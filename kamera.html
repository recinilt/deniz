<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>üì∑ Pro Kamera - Odak & Zoom</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-user-select: none;
            user-select: none;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            touch-action: manipulation;
        }
        h1 {
            font-size: 1.1rem;
            margin: 8px 0;
            text-align: center;
        }
        .video-wrapper {
            position: relative;
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            border-radius: 12px;
            background: #000;
            touch-action: none;
        }
        .video-container {
            width: 100%;
            transform-origin: center center;
            transition: transform 0.1s ease-out;
        }
        video {
            width: 100%;
            display: block;
        }
        .overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            z-index: 10;
            pointer-events: none;
        }
        .overlay-row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 3px;
        }
        .overlay-row:last-child {
            margin-bottom: 0;
        }
        .zoom-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(233, 69, 96, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
        }
        .controls {
            width: 100%;
            max-width: 500px;
            margin-top: 12px;
        }
        .control-section {
            background: #16213e;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
        }
        .control-section h3 {
            font-size: 0.8rem;
            margin-bottom: 8px;
            color: #e94560;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        button {
            flex: 1;
            min-width: 70px;
            padding: 10px 6px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        button:active {
            transform: scale(0.95);
        }
        .btn-primary { background: #e94560; color: #fff; }
        .btn-secondary { background: #0f3460; color: #fff; }
        .btn-success { background: #00b894; color: #fff; }
        .btn-warning { background: #fdcb6e; color: #000; }
        .btn-danger { background: #d63031; color: #fff; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .slider-container {
            margin: 8px 0;
        }
        .slider-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .slider-label {
            font-size: 0.7rem;
            color: #a0a0a0;
            min-width: 35px;
        }
        input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: #0f3460;
            border-radius: 3px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            background: #e94560;
            border-radius: 50%;
            cursor: pointer;
        }
        .slider-value {
            min-width: 45px;
            text-align: center;
            font-size: 0.75rem;
            color: #fff;
            background: #0f3460;
            padding: 4px 6px;
            border-radius: 4px;
        }
        .step-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
            margin-top: 8px;
        }
        .step-buttons button {
            padding: 8px 4px;
            font-size: 0.7rem;
        }
        .alert {
            background: #ff6b6b;
            color: #fff;
            padding: 8px 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.75rem;
            text-align: center;
        }
        .alert.warning { background: #feca57; color: #000; }
        .alert.info { background: #54a0ff; }
        .photo-preview {
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
            display: none;
        }
        .photo-preview img {
            width: 100%;
            border-radius: 10px;
        }
        .mode-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
        }
        .mode-auto { background: #00b894; }
        .mode-manual { background: #e94560; }
        #startBtn {
            width: 100%;
            max-width: 500px;
            padding: 14px;
            font-size: 1rem;
            margin-bottom: 12px;
        }
        .hidden { display: none !important; }
        .torch-btn.active { background: #fdcb6e; color: #000; }
        .zoom-info {
            font-size: 0.65rem;
            color: #a0a0a0;
            margin-top: 5px;
            text-align: center;
        }
        .pinch-hint {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 10;
        }
        .pinch-hint.show { opacity: 1; }
    </style>
</head>
<body>
    <h1>üì∑ Pro Kamera - Odak & Zoom</h1>
    
    <button id="startBtn" class="btn-primary">üé¨ Kamerayƒ± Ba≈ülat</button>
    
    <div id="alerts"></div>
    
    <div class="video-wrapper hidden" id="videoWrapper">
        <div class="video-container" id="videoContainer">
            <video id="video" autoplay playsinline></video>
        </div>
        <div class="overlay">
            <div class="overlay-row">
                <span id="cameraLabel">üìπ -</span>
                <span id="focusModeLabel" class="mode-indicator mode-auto">AF</span>
            </div>
            <div class="overlay-row">
                <span id="zoomTypeLabel">üîç -</span>
            </div>
        </div>
        <div class="zoom-badge" id="zoomBadge">1.0x</div>
        <div class="pinch-hint" id="pinchHint">ü§è Pinch to Zoom</div>
    </div>
    
    <div class="controls hidden" id="controls">
        <!-- Kamera & Torch -->
        <div class="control-section">
            <h3>üìπ Kamera</h3>
            <div class="btn-row">
                <button id="btnFront" class="btn-secondary">ü§≥ √ñn</button>
                <button id="btnBack" class="btn-primary">üåÑ Arka</button>
                <button id="btnTorch" class="btn-secondary torch-btn">üî¶ Fener</button>
            </div>
        </div>
        
        <!-- Zoom Kontrol√º -->
        <div class="control-section" id="zoomSection">
            <h3>üîç Zoom Kontrol√º</h3>
            <div class="slider-container">
                <div class="slider-row">
                    <span class="slider-label">1x</span>
                    <input type="range" id="zoomSlider" min="1" max="20" step="0.1" value="1">
                    <span class="slider-value" id="zoomValue">1.0x</span>
                </div>
                <div class="zoom-info" id="zoomInfo">Donanƒ±m: 1x | Yazƒ±lƒ±m: 1x</div>
            </div>
            <div class="step-buttons">
                <button id="btnZoomFineDown" class="btn-secondary">‚óÄ‚óÄ -0.1</button>
                <button id="btnZoomNormalDown" class="btn-secondary">‚óÄ -0.5</button>
                <button id="btnZoomNormalUp" class="btn-secondary">‚ñ∂ +0.5</button>
                <button id="btnZoomFineUp" class="btn-secondary">‚ñ∂‚ñ∂ +0.1</button>
            </div>
            <div class="btn-row" style="margin-top:8px;">
                <button id="btnZoom1x" class="btn-secondary">1x</button>
                <button id="btnZoom2x" class="btn-secondary">2x</button>
                <button id="btnZoom5x" class="btn-secondary">5x</button>
                <button id="btnZoom10x" class="btn-secondary">10x</button>
                <button id="btnZoomMax" class="btn-warning">MAX</button>
            </div>
        </div>
        
        <!-- Odak Kontrol√º -->
        <div class="control-section" id="focusSection">
            <h3>üéØ Odak Kontrol√º</h3>
            <div class="btn-row">
                <button id="btnAutoFocus" class="btn-success">üîÑ Otomatik</button>
                <button id="btnManualFocus" class="btn-secondary">‚úã Manuel</button>
            </div>
            <div id="manualFocusControls" class="hidden">
                <div class="slider-container">
                    <div class="slider-row">
                        <span class="slider-label">Yakƒ±n</span>
                        <input type="range" id="focusSlider" min="0" max="1" step="0.01" value="0.5">
                        <span class="slider-value" id="focusValue">0.50</span>
                    </div>
                </div>
                <div class="step-buttons">
                    <button id="btnFocusFineDown" class="btn-secondary">‚óÄ‚óÄ -0.01</button>
                    <button id="btnFocusNormalDown" class="btn-secondary">‚óÄ -0.05</button>
                    <button id="btnFocusNormalUp" class="btn-secondary">‚ñ∂ +0.05</button>
                    <button id="btnFocusFineUp" class="btn-secondary">‚ñ∂‚ñ∂ +0.01</button>
                </div>
            </div>
        </div>
        
        <!-- Fotoƒüraf √áekme -->
        <div class="control-section">
            <h3>üì∏ Fotoƒüraf</h3>
            <div class="btn-row">
                <button id="btnCapture" class="btn-primary">üì∏ √áek</button>
                <button id="btnDownload" class="btn-success hidden">üíæ ƒ∞ndir</button>
            </div>
        </div>
    </div>
    
    <div class="photo-preview" id="photoPreview">
        <img id="capturedImage" alt="√áekilen fotoƒüraf">
    </div>

    <script>
        // ==================== DEƒûƒ∞≈ûKENLER ====================
        let videoElement = document.getElementById('video');
        let videoContainer = document.getElementById('videoContainer');
        let currentStream = null;
        let currentTrack = null;
        let imageCapture = null;
        let currentFacing = 'environment';
        let lastBlob = null;
        
        // Zoom deƒüi≈ükenleri
        let hardwareZoomCapabilities = null;
        let currentHardwareZoom = 1;
        let currentSoftwareZoom = 1;
        let maxHardwareZoom = 1;
        let maxSoftwareZoom = 10; // CSS ile 10x'e kadar
        let totalMaxZoom = 20; // Toplam max
        
        // Odak deƒüi≈ükenleri
        let focusCapabilities = null;
        
        // Torch
        let torchSupported = false;
        let torchOn = false;
        
        // Pinch zoom deƒüi≈ükenleri
        let initialPinchDistance = 0;
        let initialZoom = 1;
        let isPinching = false;
        
        // ==================== DOM ELEMANLARI ====================
        const startBtn = document.getElementById('startBtn');
        const videoWrapper = document.getElementById('videoWrapper');
        const controls = document.getElementById('controls');
        const alertsDiv = document.getElementById('alerts');
        const zoomSlider = document.getElementById('zoomSlider');
        const zoomValue = document.getElementById('zoomValue');
        const zoomBadge = document.getElementById('zoomBadge');
        const zoomInfo = document.getElementById('zoomInfo');
        const zoomTypeLabel = document.getElementById('zoomTypeLabel');
        const focusSection = document.getElementById('focusSection');
        const manualFocusControls = document.getElementById('manualFocusControls');
        const focusSlider = document.getElementById('focusSlider');
        const focusValue = document.getElementById('focusValue');
        const cameraLabel = document.getElementById('cameraLabel');
        const focusModeLabel = document.getElementById('focusModeLabel');
        const photoPreview = document.getElementById('photoPreview');
        const capturedImage = document.getElementById('capturedImage');
        const btnDownload = document.getElementById('btnDownload');
        const btnTorch = document.getElementById('btnTorch');
        const pinchHint = document.getElementById('pinchHint');
        
        // ==================== YARDIMCI FONKSƒ∞YONLAR ====================
        function showAlert(message, type = 'error') {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }
        
        function stopCurrentStream() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
                currentTrack = null;
                imageCapture = null;
            }
            // Reset zoom
            currentHardwareZoom = 1;
            currentSoftwareZoom = 1;
            videoContainer.style.transform = 'scale(1)';
            torchOn = false;
            btnTorch.classList.remove('active');
        }
        
        // ==================== KAMERA BA≈ûLATMA ====================
        async function startCamera(facingMode) {
            stopCurrentStream();
            
            try {
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };
                
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = currentStream;
                currentTrack = currentStream.getVideoTracks()[0];
                currentFacing = facingMode;
                
                // Kamera etiketi
                const label = currentTrack.label || (facingMode === 'user' ? '√ñn Kamera' : 'Arka Kamera');
                cameraLabel.textContent = 'üìπ ' + label.substring(0, 18);
                
                // ImageCapture
                if ('ImageCapture' in window) {
                    imageCapture = new ImageCapture(currentTrack);
                }
                
                // Kamera hazƒ±r olana kadar bekle
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Yetenekleri kontrol et
                checkZoomCapabilities();
                checkFocusCapabilities();
                checkTorchCapability();
                
                // Buton stilleri
                document.getElementById('btnFront').className = facingMode === 'user' ? 'btn-primary' : 'btn-secondary';
                document.getElementById('btnBack').className = facingMode === 'environment' ? 'btn-primary' : 'btn-secondary';
                
                // UI g√∂ster
                videoWrapper.classList.remove('hidden');
                controls.classList.remove('hidden');
                startBtn.classList.add('hidden');
                
                // Pinch hint g√∂ster
                showPinchHint();
                
            } catch (err) {
                console.error('Kamera hatasƒ±:', err);
                showAlert('Kamera eri≈üimi ba≈üarƒ±sƒ±z: ' + err.message);
            }
        }
        
        // ==================== ZOOM FONKSƒ∞YONLARI ====================
        function checkZoomCapabilities() {
            if (!currentTrack) return;
            
            try {
                const capabilities = currentTrack.getCapabilities();
                console.log('Kamera yetenekleri:', capabilities);
                
                if (capabilities.zoom) {
                    hardwareZoomCapabilities = {
                        min: capabilities.zoom.min || 1,
                        max: capabilities.zoom.max || 1,
                        step: capabilities.zoom.step || 0.1
                    };
                    maxHardwareZoom = hardwareZoomCapabilities.max;
                    
                    // Toplam max zoom hesapla
                    totalMaxZoom = maxHardwareZoom * maxSoftwareZoom;
                    zoomSlider.max = Math.min(totalMaxZoom, 20); // Max 20x limit
                    
                    zoomTypeLabel.textContent = `üîç HW: ${maxHardwareZoom.toFixed(1)}x | SW: ${maxSoftwareZoom}x`;
                    showAlert(`Donanƒ±m zoom: ${maxHardwareZoom.toFixed(1)}x | Toplam: ${Math.min(totalMaxZoom, 20).toFixed(1)}x`, 'info');
                } else {
                    hardwareZoomCapabilities = null;
                    maxHardwareZoom = 1;
                    totalMaxZoom = maxSoftwareZoom;
                    zoomSlider.max = maxSoftwareZoom;
                    zoomTypeLabel.textContent = 'üîç Sadece yazƒ±lƒ±msal zoom';
                    showAlert('Donanƒ±m zoom desteklenmiyor, yazƒ±lƒ±msal zoom aktif', 'warning');
                }
                
            } catch (err) {
                console.error('Zoom yetenek hatasƒ±:', err);
                hardwareZoomCapabilities = null;
            }
        }
        
        async function setZoom(targetZoom) {
            targetZoom = Math.max(1, Math.min(parseFloat(zoomSlider.max), targetZoom));
            
            let hwZoom = 1;
            let swZoom = 1;
            
            if (hardwareZoomCapabilities && maxHardwareZoom > 1) {
                // √ñnce donanƒ±m zoom kullan
                if (targetZoom <= maxHardwareZoom) {
                    hwZoom = targetZoom;
                    swZoom = 1;
                } else {
                    // Donanƒ±m max, geri kalan yazƒ±lƒ±msal
                    hwZoom = maxHardwareZoom;
                    swZoom = targetZoom / maxHardwareZoom;
                }
                
                // Donanƒ±m zoom uygula
                try {
                    await currentTrack.applyConstraints({
                        advanced: [{ zoom: hwZoom }]
                    });
                    currentHardwareZoom = hwZoom;
                } catch (err) {
                    console.error('Donanƒ±m zoom hatasƒ±:', err);
                }
            } else {
                // Sadece yazƒ±lƒ±msal
                swZoom = targetZoom;
            }
            
            // Yazƒ±lƒ±msal zoom uygula (CSS)
            currentSoftwareZoom = swZoom;
            videoContainer.style.transform = `scale(${swZoom})`;
            
            // UI g√ºncelle
            const totalZoom = hwZoom * swZoom;
            zoomSlider.value = totalZoom;
            zoomValue.textContent = totalZoom.toFixed(1) + 'x';
            zoomBadge.textContent = totalZoom.toFixed(1) + 'x';
            zoomInfo.textContent = `Donanƒ±m: ${hwZoom.toFixed(1)}x | Yazƒ±lƒ±m: ${swZoom.toFixed(1)}x`;
            
            // Zoom seviyesine g√∂re badge rengi
            if (totalZoom > 10) {
                zoomBadge.style.background = 'rgba(214, 48, 49, 0.9)';
            } else if (totalZoom > 5) {
                zoomBadge.style.background = 'rgba(253, 203, 110, 0.9)';
                zoomBadge.style.color = '#000';
            } else {
                zoomBadge.style.background = 'rgba(233, 69, 96, 0.9)';
                zoomBadge.style.color = '#fff';
            }
        }
        
        function getCurrentZoom() {
            return currentHardwareZoom * currentSoftwareZoom;
        }
        
        // ==================== PINCH ZOOM ====================
        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        function handleTouchStart(e) {
            if (e.touches.length === 2) {
                isPinching = true;
                initialPinchDistance = getDistance(e.touches[0], e.touches[1]);
                initialZoom = getCurrentZoom();
                e.preventDefault();
            }
        }
        
        function handleTouchMove(e) {
            if (isPinching && e.touches.length === 2) {
                const currentDistance = getDistance(e.touches[0], e.touches[1]);
                const scale = currentDistance / initialPinchDistance;
                const newZoom = initialZoom * scale;
                setZoom(newZoom);
                e.preventDefault();
            }
        }
        
        function handleTouchEnd(e) {
            if (e.touches.length < 2) {
                isPinching = false;
            }
        }
        
        function showPinchHint() {
            pinchHint.classList.add('show');
            setTimeout(() => pinchHint.classList.remove('show'), 2500);
        }
        
        // ==================== TORCH (FENER) ====================
        function checkTorchCapability() {
            if (!currentTrack) return;
            
            try {
                const capabilities = currentTrack.getCapabilities();
                torchSupported = capabilities.torch === true;
                
                if (torchSupported && currentFacing === 'environment') {
                    btnTorch.disabled = false;
                    btnTorch.title = 'Feneri a√ß/kapat';
                } else {
                    btnTorch.disabled = true;
                    btnTorch.title = currentFacing === 'user' ? '√ñn kamerada fener yok' : 'Fener desteklenmiyor';
                }
            } catch (err) {
                torchSupported = false;
                btnTorch.disabled = true;
            }
        }
        
        async function toggleTorch() {
            if (!torchSupported || !currentTrack) return;
            
            try {
                torchOn = !torchOn;
                await currentTrack.applyConstraints({
                    advanced: [{ torch: torchOn }]
                });
                
                btnTorch.classList.toggle('active', torchOn);
                btnTorch.textContent = torchOn ? 'üî¶ A√áIK' : 'üî¶ Fener';
                
            } catch (err) {
                console.error('Torch hatasƒ±:', err);
                showAlert('Fener a√ßƒ±lamadƒ±: ' + err.message);
                torchOn = false;
                btnTorch.classList.remove('active');
            }
        }
        
        // ==================== ODAK FONKSƒ∞YONLARI ====================
        function checkFocusCapabilities() {
            if (!currentTrack) return;
            
            try {
                const capabilities = currentTrack.getCapabilities();
                
                if (!capabilities.focusMode || !capabilities.focusMode.includes('manual')) {
                    document.getElementById('btnManualFocus').disabled = true;
                    focusCapabilities = null;
                    return;
                }
                
                document.getElementById('btnManualFocus').disabled = false;
                
                if (capabilities.focusDistance) {
                    focusCapabilities = {
                        min: capabilities.focusDistance.min,
                        max: capabilities.focusDistance.max,
                        step: capabilities.focusDistance.step || 0.01
                    };
                    
                    focusSlider.min = focusCapabilities.min;
                    focusSlider.max = focusCapabilities.max;
                    focusSlider.step = focusCapabilities.step;
                    
                    const settings = currentTrack.getSettings();
                    if (settings.focusDistance !== undefined) {
                        focusSlider.value = settings.focusDistance;
                        focusValue.textContent = settings.focusDistance.toFixed(2);
                    }
                } else {
                    focusCapabilities = null;
                }
                
            } catch (err) {
                console.error('Odak yetenek hatasƒ±:', err);
                focusCapabilities = null;
            }
        }
        
        async function setFocusMode(mode) {
            if (!currentTrack) return;
            
            try {
                await currentTrack.applyConstraints({
                    advanced: [{ focusMode: mode }]
                });
                
                if (mode === 'manual') {
                    focusModeLabel.textContent = 'MF';
                    focusModeLabel.className = 'mode-indicator mode-manual';
                    manualFocusControls.classList.remove('hidden');
                    document.getElementById('btnManualFocus').className = 'btn-primary';
                    document.getElementById('btnAutoFocus').className = 'btn-secondary';
                } else {
                    focusModeLabel.textContent = 'AF';
                    focusModeLabel.className = 'mode-indicator mode-auto';
                    manualFocusControls.classList.add('hidden');
                    document.getElementById('btnAutoFocus').className = 'btn-success';
                    document.getElementById('btnManualFocus').className = 'btn-secondary';
                }
                
            } catch (err) {
                console.error('Odak modu hatasƒ±:', err);
                showAlert('Odak modu deƒüi≈ütirilemedi');
            }
        }
        
        async function setFocusDistance(distance) {
            if (!currentTrack || !focusCapabilities) return;
            
            distance = Math.max(focusCapabilities.min, Math.min(focusCapabilities.max, distance));
            
            try {
                await currentTrack.applyConstraints({
                    advanced: [{
                        focusMode: 'manual',
                        focusDistance: distance
                    }]
                });
                focusSlider.value = distance;
                focusValue.textContent = distance.toFixed(2);
            } catch (err) {
                console.error('Odak mesafesi hatasƒ±:', err);
            }
        }
        
        // ==================== FOTOƒûRAF √áEKƒ∞Mƒ∞ ====================
        async function capturePhoto() {
            // Canvas kullanarak yakala (zoom dahil)
            const canvas = document.createElement('canvas');
            const videoWidth = videoElement.videoWidth;
            const videoHeight = videoElement.videoHeight;
            
            // Yazƒ±lƒ±msal zoom varsa crop yap
            if (currentSoftwareZoom > 1) {
                const cropWidth = videoWidth / currentSoftwareZoom;
                const cropHeight = videoHeight / currentSoftwareZoom;
                const cropX = (videoWidth - cropWidth) / 2;
                const cropY = (videoHeight - cropHeight) / 2;
                
                canvas.width = cropWidth;
                canvas.height = cropHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElement, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            } else {
                canvas.width = videoWidth;
                canvas.height = videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElement, 0, 0);
            }
            
            canvas.toBlob(blob => {
                lastBlob = blob;
                showCapturedPhoto(blob);
            }, 'image/jpeg', 0.95);
        }
        
        function showCapturedPhoto(blob) {
            const url = URL.createObjectURL(blob);
            capturedImage.src = url;
            photoPreview.style.display = 'block';
            btnDownload.classList.remove('hidden');
            showAlert('üì∏ Fotoƒüraf √ßekildi!', 'info');
        }
        
        function downloadPhoto() {
            if (!lastBlob) return;
            
            const url = URL.createObjectURL(lastBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `foto_${Date.now()}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
            showAlert('üíæ Fotoƒüraf indirildi!', 'info');
        }
        
        // ==================== EVENT LISTENERS ====================
        startBtn.addEventListener('click', () => startCamera('environment'));
        
        // Kamera deƒüi≈ütirme
        document.getElementById('btnFront').addEventListener('click', () => startCamera('user'));
        document.getElementById('btnBack').addEventListener('click', () => startCamera('environment'));
        
        // Torch
        btnTorch.addEventListener('click', toggleTorch);
        
        // Zoom slider
        zoomSlider.addEventListener('input', (e) => setZoom(parseFloat(e.target.value)));
        
        // Zoom butonlarƒ±
        document.getElementById('btnZoomFineDown').addEventListener('click', () => setZoom(getCurrentZoom() - 0.1));
        document.getElementById('btnZoomFineUp').addEventListener('click', () => setZoom(getCurrentZoom() + 0.1));
        document.getElementById('btnZoomNormalDown').addEventListener('click', () => setZoom(getCurrentZoom() - 0.5));
        document.getElementById('btnZoomNormalUp').addEventListener('click', () => setZoom(getCurrentZoom() + 0.5));
        document.getElementById('btnZoom1x').addEventListener('click', () => setZoom(1));
        document.getElementById('btnZoom2x').addEventListener('click', () => setZoom(2));
        document.getElementById('btnZoom5x').addEventListener('click', () => setZoom(5));
        document.getElementById('btnZoom10x').addEventListener('click', () => setZoom(10));
        document.getElementById('btnZoomMax').addEventListener('click', () => setZoom(parseFloat(zoomSlider.max)));
        
        // Odak
        document.getElementById('btnAutoFocus').addEventListener('click', () => setFocusMode('continuous'));
        document.getElementById('btnManualFocus').addEventListener('click', () => {
            if (!focusCapabilities) {
                showAlert('Manuel odak desteklenmiyor', 'warning');
                return;
            }
            setFocusMode('manual');
        });
        
        focusSlider.addEventListener('input', (e) => setFocusDistance(parseFloat(e.target.value)));
        
        document.getElementById('btnFocusFineDown').addEventListener('click', () => {
            setFocusDistance(parseFloat(focusSlider.value) - 0.01);
        });
        document.getElementById('btnFocusFineUp').addEventListener('click', () => {
            setFocusDistance(parseFloat(focusSlider.value) + 0.01);
        });
        document.getElementById('btnFocusNormalDown').addEventListener('click', () => {
            setFocusDistance(parseFloat(focusSlider.value) - 0.05);
        });
        document.getElementById('btnFocusNormalUp').addEventListener('click', () => {
            setFocusDistance(parseFloat(focusSlider.value) + 0.05);
        });
        
        // Fotoƒüraf
        document.getElementById('btnCapture').addEventListener('click', capturePhoto);
        btnDownload.addEventListener('click', downloadPhoto);
        
        // Pinch zoom events
        videoWrapper.addEventListener('touchstart', handleTouchStart, { passive: false });
        videoWrapper.addEventListener('touchmove', handleTouchMove, { passive: false });
        videoWrapper.addEventListener('touchend', handleTouchEnd);
        videoWrapper.addEventListener('touchcancel', handleTouchEnd);
        
        // Mouse wheel zoom (desktop)
        videoWrapper.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.2 : 0.2;
            setZoom(getCurrentZoom() + delta);
        }, { passive: false });
        
        // ==================== BA≈ûLANGI√á KONTROLLERƒ∞ ====================
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showAlert('Bu tarayƒ±cƒ± kamera eri≈üimini desteklemiyor!');
            startBtn.disabled = true;
        }
        
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            showAlert('‚ö†Ô∏è Kamera eri≈üimi i√ßin HTTPS gerekli!', 'warning');
        }
    </script>
</body>
</html>