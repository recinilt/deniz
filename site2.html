<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1920">
<title>TV Alƒ±cƒ±</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0a0a0f;
    color: #e0e0e8;
    height: 100vh;
    overflow: hidden;
  }

  /* === LOGIN === */
  .login-screen {
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .login-icon { font-size: 64px; margin-bottom: 20px; }
  .login-title { font-size: 42px; font-weight: 700; margin-bottom: 6px; }
  .login-subtitle { font-size: 22px; color: #888; margin-bottom: 40px; }

  .login-form { width: 480px; }

  .auth-tabs-tv {
    display: flex;
    background: #151520;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 24px;
  }

  .auth-tab-tv {
    flex: 1;
    padding: 14px;
    text-align: center;
    font-size: 20px;
    font-weight: 600;
    color: #666;
    border-radius: 10px;
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
  }

  .auth-tab-tv.active {
    background: #1e1e2e;
    color: #e0e0e8;
  }

  .field { margin-bottom: 16px; }

  .field label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #888;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .field input {
    width: 100%;
    padding: 18px 20px;
    background: #151520;
    border: 2px solid #252530;
    border-radius: 12px;
    color: #e0e0e8;
    font-family: inherit;
    font-size: 22px;
    outline: none;
  }

  .field input:focus { border-color: #6c5ce7; }

  .confirm-field { display: none; }
  .confirm-field.show { display: block; }

  .remember-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
  }

  .remember-row input[type="checkbox"] {
    width: 24px; height: 24px;
    accent-color: #6c5ce7;
  }

  .remember-row span { font-size: 18px; color: #888; }

  .btn-login {
    width: 100%;
    padding: 20px;
    background: #6c5ce7;
    border: none;
    border-radius: 12px;
    color: #fff;
    font-family: inherit;
    font-size: 22px;
    font-weight: 700;
    cursor: pointer;
  }

  .btn-login:focus { outline: 3px solid #a29bfe; outline-offset: 2px; }

  .login-error {
    margin-top: 16px;
    padding: 14px;
    background: #2a1515;
    border: 1px solid #442222;
    border-radius: 10px;
    color: #ff6b6b;
    font-size: 18px;
    text-align: center;
    display: none;
  }

  /* === WAITING === */
  .waiting-screen {
    display: none;
    height: 100vh;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .status-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #0e0e16;
    border-bottom: 1px solid #1a1a28;
  }

  .status-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .status-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    background: #51cf66;
  }

  .status-text { font-size: 18px; color: #888; }

  .btn-logout {
    padding: 12px 24px;
    background: #1a1a28;
    border: 1px solid #252530;
    border-radius: 10px;
    color: #888;
    font-family: inherit;
    font-size: 16px;
    cursor: pointer;
  }

  .btn-logout:focus { outline: 3px solid #6c5ce7; outline-offset: 2px; }

  .waiting-icon { font-size: 80px; margin-bottom: 32px; }
  .waiting-title { font-size: 40px; font-weight: 700; margin-bottom: 12px; }
  .waiting-subtitle { font-size: 24px; color: #888; margin-bottom: 8px; }
  .waiting-email { font-size: 18px; color: #555; }

  .last-url {
    position: fixed;
    bottom: 32px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    background: #151520;
    border: 1px solid #252530;
    border-radius: 10px;
    font-size: 16px;
    color: #555;
    max-width: 80vw;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: none;
  }

  .last-url.show { display: block; }

  /* === REDIRECT === */
  .redirect-screen {
    position: fixed; inset: 0;
    background: #0a0a0f;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .redirect-screen.show { display: flex; }

  .redirect-icon { font-size: 72px; margin-bottom: 24px; }
  .redirect-title { font-size: 36px; font-weight: 700; margin-bottom: 12px; }

  .redirect-url {
    font-size: 22px;
    color: #a29bfe;
    max-width: 80vw;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 32px;
  }

  .progress-bar {
    width: 240px;
    height: 6px;
    background: #1a1a28;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 32px;
  }

  .progress-fill {
    height: 100%;
    background: #6c5ce7;
    border-radius: 3px;
    width: 0%;
    transition: width 2s linear;
  }

  .btn-back {
    padding: 16px 36px;
    background: #1a1a28;
    border: 1px solid #252530;
    border-radius: 12px;
    color: #888;
    font-family: inherit;
    font-size: 20px;
    cursor: pointer;
    display: none;
  }

  .btn-back:focus { outline: 3px solid #6c5ce7; outline-offset: 2px; }
  .btn-back.show { display: block; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-icon">üì∫</div>
  <div class="login-title">TV Alƒ±cƒ±</div>
  <div class="login-subtitle">Telefonunuzdan URL alƒ±n</div>
  <div class="login-form">
    <div class="auth-tabs-tv">
      <button class="auth-tab-tv active" id="authTabLogin" onclick="switchAuthTab('login')">Giri≈ü Yap</button>
      <button class="auth-tab-tv" id="authTabRegister" onclick="switchAuthTab('register')">Kayƒ±t Ol</button>
    </div>
    <div class="field">
      <label>E-posta</label>
      <input type="email" id="loginEmail" placeholder="ornek@email.com" autocomplete="email">
    </div>
    <div class="field">
      <label>≈ûifre</label>
      <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <div class="field confirm-field" id="confirmGroup">
      <label>≈ûifre Tekrar</label>
      <input type="password" id="confirmPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
    </div>
    <label class="remember-row">
      <input type="checkbox" id="rememberMe" checked>
      <span>Beni hatƒ±rla</span>
    </label>
    <button class="btn-login" id="btnLogin" onclick="handleAuth()">Giri≈ü Yap</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- WAITING -->
<div class="waiting-screen" id="waitingScreen">
  <div class="status-bar">
    <div class="status-left">
      <div class="status-dot"></div>
      <span class="status-text">Baƒülƒ± ‚Äî URL bekleniyor</span>
    </div>
    <button class="btn-logout" onclick="handleLogout()">√áƒ±kƒ±≈ü</button>
  </div>
  <div class="waiting-icon">üì°</div>
  <div class="waiting-title">URL Bekleniyor...</div>
  <div class="waiting-subtitle">Telefonunuzdan bir URL g√∂nderin</div>
  <div class="waiting-email" id="userEmail"></div>
  <div class="last-url" id="lastUrl"></div>
</div>

<!-- REDIRECT -->
<div class="redirect-screen" id="redirectScreen">
  <div class="redirect-icon" id="redirectIcon">üöÄ</div>
  <div class="redirect-title">Y√∂nlendiriliyor</div>
  <div class="redirect-url" id="redirectUrl"></div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <button class="btn-back show" id="btnBack" onclick="cancelRedirect()">‚Üê TV'ye D√∂n</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDw5kHPVMtm9G7zD_hBlusp1HCcUbbIhv8",
    authDomain: "mobil-tv-e1095.firebaseapp.com",
    databaseURL: "https://mobil-tv-e1095-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mobil-tv-e1095",
    storageBucket: "mobil-tv-e1095.firebasestorage.app",
    messagingSenderId: "397261791298",
    appId: "1:397261791298:web:3f392e3634bed79ba50ddb"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let currentUser = null;
  let lastProcessedTimestamp = 0;
  let redirectTimeout = null;
  let isRedirecting = false;
  let authMode = 'login';

  // --- AUTH TABS ---
  window.switchAuthTab = function(mode) {
    authMode = mode;
    document.getElementById('authTabLogin').classList.toggle('active', mode === 'login');
    document.getElementById('authTabRegister').classList.toggle('active', mode === 'register');
    document.getElementById('confirmGroup').classList.toggle('show', mode === 'register');
    document.getElementById('btnLogin').textContent = mode === 'login' ? 'Giri≈ü Yap' : 'Kayƒ±t Ol';
    document.getElementById('loginError').style.display = 'none';
  };

  // --- AUTH ---
  window.handleAuth = async function() {
    var email = document.getElementById('loginEmail').value.trim();
    var pass = document.getElementById('loginPassword').value;
    var remember = document.getElementById('rememberMe').checked;
    var errEl = document.getElementById('loginError');
    var btn = document.getElementById('btnLogin');

    if (!email || !pass) {
      errEl.textContent = 'L√ºtfen t√ºm alanlarƒ± doldurun';
      errEl.style.display = 'block';
      return;
    }

    if (authMode === 'register') {
      var confirm = document.getElementById('confirmPassword').value;
      if (pass !== confirm) { errEl.textContent = '≈ûifreler e≈üle≈ümiyor'; errEl.style.display = 'block'; return; }
      if (pass.length < 6) { errEl.textContent = '≈ûifre en az 6 karakter olmalƒ±'; errEl.style.display = 'block'; return; }
    }

    btn.textContent = 'Baƒülanƒ±yor...';
    btn.disabled = true;

    try {
      if (authMode === 'register') {
        await createUserWithEmailAndPassword(auth, email, pass);
      } else {
        await signInWithEmailAndPassword(auth, email, pass);
      }
      if (remember) {
        localStorage.setItem('tv_receiver_email', email);
        localStorage.setItem('tv_receiver_pass', btoa(pass));
      }
      errEl.style.display = 'none';
    } catch (e) {
      var msg = authMode === 'register' ? 'Kayƒ±t ba≈üarƒ±sƒ±z' : 'Giri≈ü ba≈üarƒ±sƒ±z';
      if (e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') msg = 'E-posta veya ≈üifre hatalƒ±';
      else if (e.code === 'auth/email-already-in-use') msg = 'Bu e-posta zaten kayƒ±tlƒ±';
      else if (e.code === 'auth/weak-password') msg = '≈ûifre en az 6 karakter olmalƒ±';
      else if (e.code === 'auth/invalid-email') msg = 'Ge√ßersiz e-posta adresi';
      else if (e.code === 'auth/too-many-requests') msg = '√áok fazla deneme. L√ºtfen bekleyin';
      errEl.textContent = msg;
      errEl.style.display = 'block';
      btn.textContent = authMode === 'login' ? 'Giri≈ü Yap' : 'Kayƒ±t Ol';
      btn.disabled = false;
    }
  };

  window.handleLogout = async function() {
    localStorage.removeItem('tv_receiver_email');
    localStorage.removeItem('tv_receiver_pass');
    await signOut(auth);
  };

  // --- AUTO LOGIN from localStorage ---
  var savedEmail = localStorage.getItem('tv_receiver_email');
  var savedPass = localStorage.getItem('tv_receiver_pass');
  if (savedEmail && savedPass) {
    document.getElementById('loginEmail').value = savedEmail;
    document.getElementById('loginPassword').value = atob(savedPass);
    setTimeout(function() { window.handleAuth(); }, 500);
  }

  // --- AUTO SUBMIT on password blur (TV keyboard "done") ---
  document.getElementById('loginPassword').addEventListener('blur', function() {
    var email = document.getElementById('loginEmail').value.trim();
    var pass = this.value;
    if (email && pass && authMode === 'login') {
      setTimeout(function() { window.handleAuth(); }, 300);
    }
  });

  // Enter key support
  document.getElementById('loginPassword').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') window.handleAuth();
  });
  document.getElementById('confirmPassword').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') window.handleAuth();
  });

  // --- AUTH STATE ---
  onAuthStateChanged(auth, function(user) {
    if (user) {
      currentUser = user;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('waitingScreen').style.display = 'flex';
      document.getElementById('userEmail').textContent = user.email;
      lastProcessedTimestamp = Date.now();
      listenForUrls();
    } else {
      currentUser = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('waitingScreen').style.display = 'none';
      var btn = document.getElementById('btnLogin');
      btn.textContent = authMode === 'login' ? 'Giri≈ü Yap' : 'Kayƒ±t Ol';
      btn.disabled = false;
    }
  });

  // --- LISTEN ---
  function listenForUrls() {
    var uid = currentUser.uid;
    var urlRef = ref(db, 'users/' + uid + '/currentUrl');

    onValue(urlRef, function(snap) {
      if (!snap.exists() || isRedirecting) return;

      var data = snap.val();
      var url = data.url;
      var timestamp = data.timestamp;

      if (timestamp <= lastProcessedTimestamp) return;
      lastProcessedTimestamp = timestamp;

      showRedirect(url);
      remove(urlRef);

      redirectTimeout = setTimeout(function() {
        window.location.href = url;
      }, 2500);
    });
  }

  function showRedirect(url) {
    isRedirecting = true;
    var screen = document.getElementById('redirectScreen');
    var urlEl = document.getElementById('redirectUrl');
    var iconEl = document.getElementById('redirectIcon');
    var fill = document.getElementById('progressFill');

    var isYT = /(?:youtube\.com|youtu\.be)/i.test(url);
    iconEl.textContent = isYT ? '‚ñ∂' : 'üöÄ';

    try {
      var u = new URL(url);
      urlEl.textContent = u.hostname.replace('www.', '') + u.pathname;
    } catch (e) {
      urlEl.textContent = url;
    }

    screen.classList.add('show');
    setTimeout(function() { fill.style.width = '100%'; }, 50);
  }

  window.cancelRedirect = function() {
    if (redirectTimeout) {
      clearTimeout(redirectTimeout);
      redirectTimeout = null;
    }
    isRedirecting = false;
    document.getElementById('redirectScreen').classList.remove('show');
    document.getElementById('progressFill').style.width = '0%';
  };
</script>
</body>
</html>
