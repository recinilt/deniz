<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=1920">
<title>TV Alici</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
    background: #0a0a0f;
    color: #e0e0e8;
    height: 100vh;
    overflow: hidden;
  }

  .login-screen {
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .login-icon { font-size: 64px; margin-bottom: 20px; }
  .login-title { font-size: 42px; font-weight: 700; margin-bottom: 6px; }
  .login-subtitle { font-size: 22px; color: #888; margin-bottom: 40px; }
  .login-form { width: 480px; }

  .auth-tabs {
    display: flex;
    background: #151520;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 24px;
  }

  .auth-tab {
    flex: 1;
    padding: 14px;
    text-align: center;
    font-size: 20px;
    font-weight: 600;
    color: #666;
    border-radius: 10px;
    cursor: pointer;
    border: none;
    background: none;
    font-family: inherit;
  }

  .auth-tab.active {
    background: #1e1e2e;
    color: #e0e0e8;
  }

  .field { margin-bottom: 16px; }

  .field label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: #888;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .field input {
    width: 100%;
    padding: 18px 20px;
    background: #151520;
    border: 2px solid #252530;
    border-radius: 12px;
    color: #e0e0e8;
    font-family: inherit;
    font-size: 22px;
    outline: none;
  }

  .field input:focus { border-color: #6c5ce7; }

  .confirm-field { display: none; }

  .remember-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
  }

  .remember-row input[type="checkbox"] {
    width: 24px; height: 24px;
    accent-color: #6c5ce7;
  }

  .remember-row span { font-size: 18px; color: #888; }

  .btn-login {
    width: 100%;
    padding: 20px;
    background: #6c5ce7;
    border: none;
    border-radius: 12px;
    color: #fff;
    font-family: inherit;
    font-size: 22px;
    font-weight: 700;
    cursor: pointer;
  }

  .btn-login:focus { outline: 3px solid #a29bfe; outline-offset: 2px; }

  .login-error {
    margin-top: 16px;
    padding: 14px;
    background: #2a1515;
    border: 1px solid #442222;
    border-radius: 10px;
    color: #ff6b6b;
    font-size: 18px;
    text-align: center;
    display: none;
  }

  .waiting-screen {
    display: none;
    height: 100vh;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .status-bar {
    position: fixed;
    top: 0; left: 0; right: 0;
    padding: 16px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #0e0e16;
    border-bottom: 1px solid #1a1a28;
  }

  .status-left {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .status-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    background: #51cf66;
  }

  .status-text { font-size: 18px; color: #888; }

  .btn-logout {
    padding: 12px 24px;
    background: #1a1a28;
    border: 1px solid #252530;
    border-radius: 10px;
    color: #888;
    font-family: inherit;
    font-size: 16px;
    cursor: pointer;
  }

  .btn-logout:focus { outline: 3px solid #6c5ce7; outline-offset: 2px; }

  .waiting-icon { font-size: 80px; margin-bottom: 32px; }
  .waiting-title { font-size: 40px; font-weight: 700; margin-bottom: 12px; }
  .waiting-subtitle { font-size: 24px; color: #888; margin-bottom: 8px; }
  .waiting-email { font-size: 18px; color: #555; }

  .redirect-screen {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: #0a0a0f;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .redirect-screen.show { display: flex; }

  .redirect-icon { font-size: 72px; margin-bottom: 24px; }
  .redirect-title { font-size: 36px; font-weight: 700; margin-bottom: 12px; }

  .redirect-url {
    font-size: 22px;
    color: #a29bfe;
    max-width: 80%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    margin-bottom: 32px;
  }

  .progress-bar {
    width: 240px;
    height: 6px;
    background: #1a1a28;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 32px;
  }

  .progress-fill {
    height: 100%;
    background: #6c5ce7;
    border-radius: 3px;
    width: 0;
  }

  .btn-back {
    padding: 16px 36px;
    background: #1a1a28;
    border: 1px solid #252530;
    border-radius: 12px;
    color: #888;
    font-family: inherit;
    font-size: 20px;
    cursor: pointer;
  }

  .btn-back:focus { outline: 3px solid #6c5ce7; outline-offset: 2px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-icon">&#128250;</div>
  <div class="login-title">TV Alici</div>
  <div class="login-subtitle">Telefonunuzdan URL alin</div>
  <div class="login-form">
    <div class="auth-tabs">
      <button class="auth-tab active" id="authTabLogin" onclick="switchAuthTab('login')">Giris Yap</button>
      <button class="auth-tab" id="authTabRegister" onclick="switchAuthTab('register')">Kayit Ol</button>
    </div>
    <div class="field">
      <label>E-posta</label>
      <input type="email" id="loginEmail" placeholder="ornek@email.com" autocomplete="email">
    </div>
    <div class="field">
      <label>Sifre</label>
      <input type="password" id="loginPassword" placeholder="********" autocomplete="current-password">
    </div>
    <div class="field confirm-field" id="confirmGroup">
      <label>Sifre Tekrar</label>
      <input type="password" id="confirmPassword" placeholder="********" autocomplete="new-password">
    </div>
    <label class="remember-row">
      <input type="checkbox" id="rememberMe" checked>
      <span>Beni hatirla</span>
    </label>
    <button class="btn-login" id="btnLogin" onclick="handleAuth()">Giris Yap</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- WAITING -->
<div class="waiting-screen" id="waitingScreen">
  <div class="status-bar">
    <div class="status-left">
      <div class="status-dot"></div>
      <span class="status-text">Bagli - URL bekleniyor</span>
    </div>
    <button class="btn-logout" onclick="handleLogout()">Cikis</button>
  </div>
  <div class="waiting-icon">&#128225;</div>
  <div class="waiting-title">URL Bekleniyor...</div>
  <div class="waiting-subtitle">Telefonunuzdan bir URL gonderin</div>
  <div class="waiting-email" id="userEmail"></div>
</div>

<!-- REDIRECT -->
<div class="redirect-screen" id="redirectScreen">
  <div class="redirect-icon" id="redirectIcon">&#128640;</div>
  <div class="redirect-title">Yonlendiriliyor</div>
  <div class="redirect-url" id="redirectUrl"></div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <button class="btn-back" id="btnBack" onclick="cancelRedirect()">TV'ye Don</button>
</div>

<!-- FIREBASE COMPAT SDK - klasik script tagleri, ES modules GEREKMEZ -->
<script src="firebase-lib/firebase-app-compat.js"></script>
<script src="firebase-lib/firebase-auth-compat.js"></script>
<script src="firebase-lib/firebase-database-compat.js"></script>

<script>
  // === FIREBASE CONFIG ===
  var firebaseConfig = {
    apiKey: "AIzaSyDw5kHPVMtm9G7zD_hBlusp1HCcUbbIhv8",
    authDomain: "mobil-tv-e1095.firebaseapp.com",
    databaseURL: "https://mobil-tv-e1095-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "mobil-tv-e1095",
    storageBucket: "mobil-tv-e1095.firebasestorage.app",
    messagingSenderId: "397261791298",
    appId: "1:397261791298:web:3f392e3634bed79ba50ddb"
  };

  firebase.initializeApp(firebaseConfig);

  var auth = firebase.auth();
  var db = firebase.database();

  var currentUser = null;
  var lastProcessedTimestamp = 0;
  var redirectTimeout = null;
  var isRedirecting = false;
  var authMode = "login";

  // === AUTH TABS ===
  function switchAuthTab(mode) {
    authMode = mode;
    var tabLogin = document.getElementById("authTabLogin");
    var tabRegister = document.getElementById("authTabRegister");
    var confirmGroup = document.getElementById("confirmGroup");
    var btn = document.getElementById("btnLogin");
    var errEl = document.getElementById("loginError");

    if (mode === "login") {
      tabLogin.className = "auth-tab active";
      tabRegister.className = "auth-tab";
      confirmGroup.style.display = "none";
      btn.textContent = "Giris Yap";
    } else {
      tabLogin.className = "auth-tab";
      tabRegister.className = "auth-tab active";
      confirmGroup.style.display = "block";
      btn.textContent = "Kayit Ol";
    }
    errEl.style.display = "none";
  }

  // === AUTH ===
  function handleAuth() {
    var email = document.getElementById("loginEmail").value.trim();
    var pass = document.getElementById("loginPassword").value;
    var remember = document.getElementById("rememberMe").checked;
    var errEl = document.getElementById("loginError");
    var btn = document.getElementById("btnLogin");

    if (!email || !pass) {
      errEl.textContent = "Lutfen tum alanlari doldurun";
      errEl.style.display = "block";
      return;
    }

    if (authMode === "register") {
      var confirmPass = document.getElementById("confirmPassword").value;
      if (pass !== confirmPass) {
        errEl.textContent = "Sifreler eslesmiyor";
        errEl.style.display = "block";
        return;
      }
      if (pass.length < 6) {
        errEl.textContent = "Sifre en az 6 karakter olmali";
        errEl.style.display = "block";
        return;
      }
    }

    btn.textContent = "Baglaniyor...";
    btn.disabled = true;

    var authPromise;
    if (authMode === "register") {
      authPromise = auth.createUserWithEmailAndPassword(email, pass);
    } else {
      authPromise = auth.signInWithEmailAndPassword(email, pass);
    }

    authPromise.then(function() {
      if (remember) {
        try {
          localStorage.setItem("tv_receiver_email", email);
          localStorage.setItem("tv_receiver_pass", btoa(pass));
        } catch (e) {}
      }
      errEl.style.display = "none";
    }).catch(function(e) {
      var msg = authMode === "register" ? "Kayit basarisiz" : "Giris basarisiz";
      var code = e.code || "";
      if (code === "auth/user-not-found" || code === "auth/wrong-password" || code === "auth/invalid-credential") {
        msg = "E-posta veya sifre hatali";
      } else if (code === "auth/email-already-in-use") {
        msg = "Bu e-posta zaten kayitli";
      } else if (code === "auth/weak-password") {
        msg = "Sifre en az 6 karakter olmali";
      } else if (code === "auth/invalid-email") {
        msg = "Gecersiz e-posta adresi";
      } else if (code === "auth/too-many-requests") {
        msg = "Cok fazla deneme. Lutfen bekleyin";
      }
      errEl.textContent = msg;
      errEl.style.display = "block";
      btn.textContent = authMode === "login" ? "Giris Yap" : "Kayit Ol";
      btn.disabled = false;
    });
  }

  function handleLogout() {
    try {
      localStorage.removeItem("tv_receiver_email");
      localStorage.removeItem("tv_receiver_pass");
    } catch (e) {}
    auth.signOut();
  }

  // === AUTO LOGIN ===
  try {
    var savedEmail = localStorage.getItem("tv_receiver_email");
    var savedPass = localStorage.getItem("tv_receiver_pass");
    if (savedEmail && savedPass) {
      document.getElementById("loginEmail").value = savedEmail;
      document.getElementById("loginPassword").value = atob(savedPass);
      setTimeout(function() { handleAuth(); }, 600);
    }
  } catch (e) {}

  // === PASSWORD BLUR => AUTO SUBMIT ===
  document.getElementById("loginPassword").addEventListener("blur", function() {
    var email = document.getElementById("loginEmail").value.trim();
    var pass = document.getElementById("loginPassword").value;
    if (email && pass && authMode === "login") {
      setTimeout(function() { handleAuth(); }, 400);
    }
  });

  // === ENTER KEY ===
  document.getElementById("loginPassword").addEventListener("keydown", function(e) {
    if (e.key === "Enter" || e.keyCode === 13) { handleAuth(); }
  });
  document.getElementById("confirmPassword").addEventListener("keydown", function(e) {
    if (e.key === "Enter" || e.keyCode === 13) { handleAuth(); }
  });

  // === AUTH STATE ===
  auth.onAuthStateChanged(function(user) {
    if (user) {
      currentUser = user;
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("waitingScreen").style.display = "flex";
      document.getElementById("userEmail").textContent = user.email;
      lastProcessedTimestamp = Date.now();
      listenForUrls();
    } else {
      currentUser = null;
      document.getElementById("loginScreen").style.display = "flex";
      document.getElementById("waitingScreen").style.display = "none";
      var btn = document.getElementById("btnLogin");
      btn.textContent = authMode === "login" ? "Giris Yap" : "Kayit Ol";
      btn.disabled = false;
    }
  });

  // === LISTEN FOR URLS ===
  function listenForUrls() {
    var uid = currentUser.uid;
    var urlRef = db.ref("users/" + uid + "/currentUrl");

    urlRef.on("value", function(snap) {
      if (!snap.exists() || isRedirecting) return;

      var data = snap.val();
      var url = data.url;
      var timestamp = data.timestamp;

      if (timestamp <= lastProcessedTimestamp) return;
      lastProcessedTimestamp = timestamp;

      showRedirect(url);
      urlRef.remove();

      redirectTimeout = setTimeout(function() {
        window.location.href = url;
      }, 2500);
    });
  }

  function showRedirect(url) {
    isRedirecting = true;
    var screen = document.getElementById("redirectScreen");
    var urlEl = document.getElementById("redirectUrl");
    var iconEl = document.getElementById("redirectIcon");
    var fill = document.getElementById("progressFill");

    var isYT = /(?:youtube\.com|youtu\.be)/i.test(url);
    iconEl.innerHTML = isYT ? "&#9654;" : "&#128640;";

    try {
      var u = new URL(url);
      urlEl.textContent = u.hostname.replace("www.", "") + u.pathname;
    } catch (e) {
      urlEl.textContent = url;
    }

    screen.className = "redirect-screen show";

    // Animate progress bar
    fill.style.width = "0";
    setTimeout(function() {
      fill.style.transition = "width 2s linear";
      fill.style.width = "100%";
    }, 50);
  }

  function cancelRedirect() {
    if (redirectTimeout) {
      clearTimeout(redirectTimeout);
      redirectTimeout = null;
    }
    isRedirecting = false;
    document.getElementById("redirectScreen").className = "redirect-screen";
    var fill = document.getElementById("progressFill");
    fill.style.transition = "none";
    fill.style.width = "0";
  }
</script>
</body>
</html>
