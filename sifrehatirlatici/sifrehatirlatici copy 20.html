<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://www.gstatic.com https://www.googleapis.com https://apis.google.com https://*.google.com https://fonts.googleapis.com https://cdnjs.cloudflare.com; script-src-elem 'self' 'unsafe-inline' 'wasm-unsafe-eval' https://www.gstatic.com https://www.googleapis.com https://apis.google.com https://*.google.com https://fonts.googleapis.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebasedatabase.app https://*.googleapis.com https://gmail.googleapis.com https://www.gstatic.com; img-src 'self' data: https://lh3.googleusercontent.com https://*.googleusercontent.com https://www.gstatic.com; frame-src https://sifrehatirlatici-cf65d.firebaseapp.com https://accounts.google.com; object-src 'none'; base-uri 'self';">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Åifre HatÄ±rlatÄ±cÄ±</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3346;
  --text:#e4e6ef;--text2:#9498ad;--accent:#6c8aff;--accent2:#4e6de0;
  --danger:#ef4444;--success:#22c55e;--warn:#f59e0b;
  --radius:10px;--shadow:0 2px 12px rgba(0,0,0,0.3);
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
button{font-family:inherit;cursor:pointer;border:none;outline:none;transition:all .2s}
input,select,textarea{font-family:inherit;outline:none;border:1px solid var(--border);background:var(--surface2);color:var(--text);border-radius:var(--radius);padding:10px 14px;font-size:14px;width:100%;transition:border .2s}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:60px}
select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239498ad' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L2 5h12z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}

.container{max-width:520px;margin:0 auto;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 0;margin-bottom:8px}
.header h1{font-size:20px;font-weight:700;letter-spacing:-0.3px}
.header h1 span{color:var(--accent)}

.status-bar{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);margin-bottom:16px}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.status-dot.online{background:var(--success)}
.status-dot.offline{background:var(--danger)}

/* GiriÅŸ EkranÄ± */
#giris-ekran{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center;gap:24px}
#giris-ekran h2{font-size:28px;font-weight:700}
#giris-ekran h2 span{color:var(--accent)}
#giris-ekran p{color:var(--text2);max-width:300px}
.btn-google{display:flex;align-items:center;gap:10px;background:#fff;color:#333;font-size:15px;font-weight:600;padding:12px 28px;border-radius:var(--radius);box-shadow:var(--shadow)}
.btn-google:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.4)}
.btn-google img{width:20px;height:20px}

/* Passphrase EkranÄ± */
#passphrase-ekran{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center;gap:20px}
#passphrase-ekran h2{font-size:24px;font-weight:700}
#passphrase-ekran h2 span{color:var(--accent)}
#passphrase-ekran p{color:var(--text2);max-width:340px;font-size:14px}
.passphrase-input-wrap{width:100%;max-width:320px;position:relative}
.passphrase-input-wrap input{padding-right:44px}
.passphrase-toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:4px}
.passphrase-btn{padding:12px 32px;border-radius:var(--radius);font-size:15px;font-weight:600;background:var(--accent);color:#fff}
.passphrase-btn:hover{background:var(--accent2)}
.passphrase-btn:disabled{opacity:0.5;cursor:not-allowed}
.passphrase-hata{color:var(--danger);font-size:13px;min-height:20px}
.passphrase-bilgi{color:var(--text2);font-size:12px;max-width:340px}

/* Ana Ekran */
#ana-ekran{display:none}
.toolbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.toolbar input{flex:1;min-width:150px}
.btn{padding:8px 16px;border-radius:var(--radius);font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--text)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-sm{padding:6px 10px;font-size:12px}
.btn-icon{padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text2);font-size:16px}
.btn-icon:hover{border-color:var(--accent);color:var(--text)}

.kategori-filtre{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.kategori-filtre::-webkit-scrollbar{display:none}
.kat-btn{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;background:var(--surface2);color:var(--text2);border:1px solid var(--border);white-space:nowrap;flex-shrink:0}
.kat-btn.aktif{background:var(--accent);color:#fff;border-color:var(--accent)}
.kat-btn:hover{border-color:var(--accent)}

.sifre-liste{display:flex;flex-direction:column;gap:8px}
.sifre-kart{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:border .2s;cursor:pointer}
.sifre-kart:hover{border-color:var(--accent)}
.kart-ust{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.kart-baslik{font-weight:600;font-size:15px}
.kart-kategori{font-size:11px;padding:3px 8px;border-radius:12px;background:var(--surface2);color:var(--text2)}
.kart-kullanici{font-size:13px;color:var(--text2)}
.kart-sifre-alani{display:flex;align-items:center;gap:8px;margin-top:8px}
.kart-sifre{font-family:'Courier New',monospace;font-size:14px;background:var(--surface2);padding:6px 10px;border-radius:6px;flex:1;word-break:break-all}
.kart-sifre.gizli{color:transparent;text-shadow:0 0 8px var(--text2);user-select:none}
.kart-url{font-size:12px;color:var(--accent);margin-top:6px;word-break:break-all}
.kart-not{font-size:12px;color:var(--text2);margin-top:4px;font-style:italic}
.kart-islemler{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}

.bos-mesaj{text-align:center;padding:48px 16px;color:var(--text2)}
.bos-mesaj .ikon{font-size:48px;margin-bottom:12px;opacity:.5}
.bos-mesaj p{font-size:14px}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;align-items:center;justify-content:center;padding:16px}
.modal-overlay.aktif{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:100%;max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
.modal-baslik{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.modal-baslik h3{font-size:16px;font-weight:700}
.modal-icerik{padding:20px;display:flex;flex-direction:column;gap:14px}
.form-grup{display:flex;flex-direction:column;gap:5px}
.form-grup label{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.modal-alt{display:flex;gap:8px;justify-content:flex-end;padding:16px 20px;border-top:1px solid var(--border)}

/* Alt MenÃ¼ */
.alt-menu{display:flex;gap:8px;justify-content:center;padding:16px 0;margin-top:16px;border-top:1px solid var(--border);flex-wrap:wrap}

/* KullanÄ±cÄ± */
.kullanici-bilgi{display:flex;align-items:center;gap:10px}
.kullanici-bilgi img{width:32px;height:32px;border-radius:50%;border:2px solid var(--border)}
.kullanici-bilgi span{font-size:13px;color:var(--text2)}

/* Toast */
.toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center}
.toast{padding:10px 20px;border-radius:var(--radius);font-size:13px;font-weight:600;box-shadow:var(--shadow);animation:toastIn .3s ease}
.toast.basari{background:var(--success);color:#fff}
.toast.hata{background:var(--danger);color:#fff}
.toast.bilgi{background:var(--accent);color:#fff}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* YÃ¼kleniyor */
.yukleniyor{display:flex;align-items:center;justify-content:center;padding:32px;color:var(--text2);font-size:14px;gap:8px}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:400px){
  .container{padding:10px}
  .toolbar{flex-direction:column}
  .btn{justify-content:center}
}
</style>
</head>
<body>

<div class="container">
  <!-- HEADER -->
  <div class="header" id="header" style="display:none">
    <h1>ğŸ” <span>Åifre</span> HatÄ±rlatÄ±cÄ±</h1>
    <div class="kullanici-bilgi" id="kullanici-bilgi"></div>
  </div>

  <!-- STATUS BAR -->
  <div class="status-bar" id="status-bar" style="display:none">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-metin"></span>
  </div>

  <!-- GÄ°RÄ°Å EKRANI -->
  <div id="giris-ekran">
    <h2>ğŸ” <span>Åifre</span> HatÄ±rlatÄ±cÄ±</h2>
    <p>Åifrelerini gÃ¼venle sakla, istediÄŸin yerden eriÅŸ.</p>
    <button class="btn-google" onclick="gmailGiris()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
      Google ile GiriÅŸ Yap
    </button>
  </div>

  <!-- PASSPHRASE EKRANI -->
  <div id="passphrase-ekran">
    <h2>ğŸ”‘ <span>GÃ¼venlik</span> Kelimesi</h2>
    <p id="passphrase-aciklama">Åifrelerinizi korumak iÃ§in gÃ¼venlik kelimenizi girin. Bu kelime hiÃ§bir yere kaydedilmez, her giriÅŸte sorulur.</p>
    <div class="passphrase-input-wrap">
      <input type="password" id="passphrase-input" placeholder="GÃ¼venlik kelimeniz..." autocomplete="off">
      <button class="passphrase-toggle" onclick="passphraseGosterGizle()" title="GÃ¶ster/Gizle">ğŸ‘</button>
    </div>
    <div class="passphrase-hata" id="passphrase-hata"></div>
    <button class="passphrase-btn" id="passphrase-btn" onclick="passphraseOnayla()">Kilidi AÃ§</button>
    <p class="passphrase-bilgi" id="passphrase-bilgi"></p>
  </div>

  <!-- ANA EKRAN -->
  <div id="ana-ekran">
    <!-- Arama & Ekle -->
    <div class="toolbar">
      <input type="text" id="arama-input" placeholder="Ara..." oninput="sifreFiltreUygula()">
      <button class="btn btn-primary" onclick="modalAc('ekle')">+ Yeni</button>
      <button class="btn-icon" onclick="menuToggle()" title="MenÃ¼">â˜°</button>
    </div>

    <!-- Kategori Filtre -->
    <div class="kategori-filtre" id="kategori-filtre"></div>

    <!-- Åifre Listesi -->
    <div class="sifre-liste" id="sifre-liste"></div>
    <div class="yukleniyor" id="yukleniyor" style="display:none"><div class="spinner"></div> YÃ¼kleniyor...</div>

    <!-- Alt MenÃ¼ -->
    <div class="alt-menu" id="alt-menu" style="display:none">
      <button class="btn btn-secondary btn-sm" onclick="exportBaslat()">ğŸ“§ Gmail'ime GÃ¶nder</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('txt-import').click()">ğŸ“¥ Ä°Ã§e Aktar</button>
      <button class="btn btn-secondary btn-sm" onclick="verileriSenkronla()">ğŸ”„ Senkronla</button>
      <button class="btn btn-secondary btn-sm" onclick="passphraseeDegistirModalAc()">ğŸ”‘ GÃ¼venlik Kelimesini DeÄŸiÅŸtir</button>
      <button class="btn btn-danger btn-sm" onclick="cikisYap()">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
      <input type="file" id="txt-import" accept=".txt,.json" style="display:none" onchange="txtImport(event)">
    </div>
  </div>
</div>

<!-- EKLE/DÃœZENLE MODAL -->
<div class="modal-overlay" id="modal-sifre">
  <div class="modal">
    <div class="modal-baslik">
      <h3 id="modal-baslik-text">Yeni Åifre</h3>
      <button class="btn-icon" onclick="modalKapat()">âœ•</button>
    </div>
    <div class="modal-icerik">
      <input type="hidden" id="form-id">
      <div class="form-grup">
        <label>BaÅŸlÄ±k *</label>
        <input type="text" id="form-baslik" placeholder="Ã¶r: Gmail, Netflix..." autocomplete="off" data-lpignore="true" data-1p-ignore data-bwignore="true">
      </div>
      <div class="form-grup">
        <label>Kategori</label>
        <select id="form-kategori">
          <option value="Sosyal Medya">Sosyal Medya</option>
          <option value="Banka">Banka</option>
          <option value="E-posta">E-posta</option>
          <option value="AlÄ±ÅŸveriÅŸ">AlÄ±ÅŸveriÅŸ</option>
          <option value="Ä°ÅŸ">Ä°ÅŸ</option>
          <option value="EÄŸlence">EÄŸlence</option>
          <option value="DiÄŸer">DiÄŸer</option>
        </select>
      </div>
      <div class="form-grup">
        <label>KullanÄ±cÄ± AdÄ± / E-posta</label>
        <input type="text" id="form-kullanici" placeholder="Ã¶r: kullanici@gmail.com" autocomplete="off" name="sifre-kullanici-girisi" data-lpignore="true" data-1p-ignore data-bwignore="true" readonly onfocus="this.removeAttribute('readonly')">
      </div>
      <div class="form-grup">
        <label>Åifre *</label>
        <input type="text" id="form-sifre" placeholder="Åifreniz" autocomplete="new-password" name="sifre-deger-girisi" data-lpignore="true" data-1p-ignore data-bwignore="true" readonly onfocus="this.removeAttribute('readonly')">
      </div>
      <div class="form-grup">
        <label>URL</label>
        <input type="text" id="form-url" placeholder="https://..." autocomplete="off" data-lpignore="true" data-1p-ignore data-bwignore="true">
      </div>
      <div class="form-grup">
        <label>Not</label>
        <textarea id="form-not" placeholder="Ek bilgi..."></textarea>
      </div>
    </div>
    <div class="modal-alt">
      <button class="btn btn-secondary" onclick="modalKapat()">Ä°ptal</button>
      <button class="btn btn-primary" onclick="sifreKaydet()">Kaydet</button>
    </div>
  </div>
</div>

<!-- SÄ°L ONAY MODAL -->
<div class="modal-overlay" id="modal-sil">
  <div class="modal" style="max-width:340px">
    <div class="modal-baslik">
      <h3>Silme OnayÄ±</h3>
      <button class="btn-icon" onclick="document.getElementById('modal-sil').classList.remove('aktif')">âœ•</button>
    </div>
    <div class="modal-icerik">
      <p style="font-size:14px;color:var(--text2)">Bu ÅŸifreyi silmek istediÄŸinize emin misiniz?</p>
    </div>
    <div class="modal-alt">
      <button class="btn btn-secondary" onclick="document.getElementById('modal-sil').classList.remove('aktif')">Ä°ptal</button>
      <button class="btn btn-danger" id="sil-onayla-btn">Sil</button>
    </div>
  </div>
</div>

<!-- EXPORT ONAY MODAL -->
<div class="modal-overlay" id="modal-export">
  <div class="modal" style="max-width:400px">
    <div class="modal-baslik">
      <h3>ğŸ“§ Gmail'e GÃ¶nderme UyarÄ±sÄ±</h3>
      <button class="btn-icon" onclick="document.getElementById('modal-export').classList.remove('aktif')">âœ•</button>
    </div>
    <div class="modal-icerik">
      <p style="font-size:14px;color:var(--text2)">Åifreleriniz <strong style="color:var(--success)">AES-256-GCM ile ÅŸifrelenmiÅŸ</strong> olarak Gmail hesabÄ±nÄ±za dosya eki ÅŸeklinde gÃ¶nderilecektir.</p>
      <p style="font-size:14px;color:var(--text2);margin-top:8px">Dosya uzantÄ±sÄ± <strong>.enc</strong> olacak. Geri yÃ¼klemek iÃ§in Ä°Ã§e Aktar Ã¶zelliÄŸini kullanÄ±n â€” passphrase'iniz gerekecek.</p>
    </div>
    <div class="modal-alt">
      <button class="btn btn-secondary" onclick="document.getElementById('modal-export').classList.remove('aktif')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="gmailGonder()">Evet, Gmail'ime GÃ¶nder</button>
    </div>
  </div>
</div>


<!-- GÃœVENLÄ°K KELÄ°MESÄ° DEÄÄ°ÅTÄ°R MODAL -->
<div class="modal-overlay" id="modal-passphrase-degistir">
  <div class="modal" style="max-width:400px">
    <div class="modal-baslik">
      <h3>ğŸ”‘ GÃ¼venlik Kelimesini DeÄŸiÅŸtir</h3>
      <button class="btn-icon" onclick="passphraseeDegistirModalKapat()">âœ•</button>
    </div>
    <div class="modal-icerik">
      <div class="form-grup">
        <label>Mevcut GÃ¼venlik Kelimesi</label>
        <div class="passphrase-input-wrap" style="max-width:100%">
          <input type="password" id="pd-eski" placeholder="Mevcut gÃ¼venlik kelimeniz..." autocomplete="off">
          <button class="passphrase-toggle" onclick="pdGosterGizle('pd-eski')">ğŸ‘</button>
        </div>
      </div>
      <div class="form-grup">
        <label>Yeni GÃ¼venlik Kelimesi</label>
        <div class="passphrase-input-wrap" style="max-width:100%">
          <input type="password" id="pd-yeni" placeholder="Yeni gÃ¼venlik kelimeniz (en az 5 karakter)..." autocomplete="off">
          <button class="passphrase-toggle" onclick="pdGosterGizle('pd-yeni')">ğŸ‘</button>
        </div>
      </div>
      <div class="form-grup">
        <label>Yeni GÃ¼venlik Kelimesi (Tekrar)</label>
        <div class="passphrase-input-wrap" style="max-width:100%">
          <input type="password" id="pd-yeni2" placeholder="Tekrar girin..." autocomplete="off">
          <button class="passphrase-toggle" onclick="pdGosterGizle('pd-yeni2')">ğŸ‘</button>
        </div>
      </div>
      <div class="passphrase-hata" id="pd-hata"></div>
    </div>
    <div class="modal-alt">
      <button class="btn btn-secondary" onclick="passphraseeDegistirModalKapat()">Ä°ptal</button>
      <button class="btn btn-primary" id="pd-btn" onclick="passphraseeDegistir()">DeÄŸiÅŸtir</button>
    </div>
  </div>
</div>
<!-- TOAST -->
<div class="toast-container" id="toast-container"></div>

<!-- ARGON2 WASM (KDF) -->
<script src="lib/argon2-bundled.min.js" crossorigin="anonymous"></script>

<!-- FIREBASE -->
<script src="lib/firebase-app-compat.js" crossorigin="anonymous"></script>
<script src="lib/firebase-auth-compat.js" crossorigin="anonymous"></script>
<script src="lib/firebase-database-compat.js" crossorigin="anonymous"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var firebaseConfig = {
    apiKey: "AIzaSyB5YosGWGdxZ-nizZ7ROf_XtZat76z6-4Q",
    authDomain: "sifrehatirlatici-cf65d.firebaseapp.com",
    databaseURL: "https://sifrehatirlatici-cf65d-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "sifrehatirlatici-cf65d",
    storageBucket: "sifrehatirlatici-cf65d.firebasestorage.app",
    messagingSenderId: "102814458136",
    appId: "1:102814458136:web:c5ae4a837d2264f9c57e6d"
};
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.database();
var googleProvider = new firebase.auth.GoogleAuthProvider();
googleProvider.addScope('https://www.googleapis.com/auth/gmail.send');
auth.languageCode = 'tr';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL DEÄÄ°ÅKENLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var mevcutKullanici = null;
var sifreListesi = [];
var aktifKategori = 'TÃ¼mÃ¼';
var sifrelemeAnahtari = null;
var OTURUM_SURE = 5 * 60 * 1000; // 5 dakika hareketsizlik
var oturumZamanAsimi = null;
var uyariZamanAsimi = null;
var uyariVerildiMi = false;
var firebaseDinleyici = null;
var menuAcikMi = false;
var kullaniciSalt = null; // KullanÄ±cÄ±ya Ã¶zel rastgele salt (16 byte)
var passphraseDogrulandiMi = false;
var googleAccessToken = null; // Gmail API iÃ§in OAuth access token

var KATEGORILER = ['TÃ¼mÃ¼', 'Sosyal Medya', 'Banka', 'E-posta', 'AlÄ±ÅŸveriÅŸ', 'Ä°ÅŸ', 'EÄŸlence', 'DiÄŸer'];
var MAX_YANLIS_DENEME = 5;   // 5 yanlÄ±ÅŸ denemede kilitle
var KILIT_SURE_BASE = 5 * 60 * 1000; // 5 dakika (Ã¼stel artÄ±ÅŸ: 5, 10, 20...)
// Brute-force koruma â†’ Firebase RTDB'de kalÄ±cÄ± (users/{uid}/bruteForce)
var PBKDF2_ITERASYON = 600000; // Eski kullanÄ±cÄ±lar iÃ§in korunuyor (kdfVersion=1)

// Argon2id parametreleri (RFC 9106 Ã¶nerisi)
var ARGON2_MEM   = 19456; // 19 MB (OWASP minimum, geniÅŸ cihaz uyumluluÄŸu)
var ARGON2_TIME  = 2;     // 2 iterasyon
var ARGON2_PARA  = 1;
var ARGON2_LEN   = 32;    // 256-bit Ã§Ä±ktÄ± â†’ AES-256 anahtarÄ±

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AES-GCM ÅÄ°FRELEME (Web Crypto API) - PASSPHRASE TABANLI
// KDF: Argon2id (yeni, kdfVersion=2) | PBKDF2 (eski, kdfVersion=1)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Argon2id ile anahtar tÃ¼ret (kdfVersion=2)
async function anahtarTuretArgon2(passphrase, uid, salt) {
    var saltStr = btoa(String.fromCharCode.apply(null, salt)); // salt base64
    var result = await argon2.hash({
        pass: passphrase + uid,
        salt: saltStr,
        time: ARGON2_TIME,
        mem: ARGON2_MEM,
        parallelism: ARGON2_PARA,
        hashLen: ARGON2_LEN,
        type: argon2.ArgonType.Argon2id
    });
    // result.hash â†’ Uint8Array (32 byte) â†’ AES-GCM anahtarÄ±
    var anahtar = await crypto.subtle.importKey(
        'raw', result.hash, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
    );
    return anahtar;
}

// Argon2id ile doÄŸrulama hash'i oluÅŸtur (kdfVersion=2)
async function dogrulamaHashiOlusturArgon2(passphrase, uid, salt) {
    var saltStr = btoa(String.fromCharCode.apply(null, salt));
    var result = await argon2.hash({
        pass: 'dogrulama_' + passphrase + uid,
        salt: saltStr,
        time: ARGON2_TIME,
        mem: ARGON2_MEM,
        parallelism: ARGON2_PARA,
        hashLen: ARGON2_LEN,
        type: argon2.ArgonType.Argon2id
    });
    return btoa(String.fromCharCode.apply(null, result.hash));
}

// PBKDF2 ile anahtar tÃ¼ret (eski kullanÄ±cÄ±lar, kdfVersion=1)
async function anahtarTuret(passphrase, uid, salt) {
    var enc = new TextEncoder();
    var keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode(passphrase + uid), 'PBKDF2', false, ['deriveKey']
    );
    var anahtar = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITERASYON, hash: 'SHA-256' },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
    );
    return anahtar;
}

// PBKDF2 ile doÄŸrulama hash'i oluÅŸtur (eski kullanÄ±cÄ±lar, kdfVersion=1)
async function dogrulamaHashiOlustur(passphrase, uid, salt) {
    var enc = new TextEncoder();
    var keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode('dogrulama_' + passphrase + uid), 'PBKDF2', false, ['deriveBits']
    );
    var bits = await crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITERASYON, hash: 'SHA-256' },
        keyMaterial,
        256
    );
    return btoa(String.fromCharCode.apply(null, new Uint8Array(bits)));
}

// Rastgele 16 byte salt Ã¼ret
function rastgeleSaltUret() {
    return crypto.getRandomValues(new Uint8Array(16));
}

// Salt'Ä± base64'e Ã§evir
function saltToBase64(salt) {
    return btoa(String.fromCharCode.apply(null, salt));
}

// Base64'ten salt'a Ã§evir
function base64ToSalt(b64) {
    return Uint8Array.from(atob(b64), function(c) { return c.charCodeAt(0); });
}

async function sifrele(metin) {
    if (!sifrelemeAnahtari) return metin;
    var enc = new TextEncoder();
    var iv = crypto.getRandomValues(new Uint8Array(12));
    var sifreli = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: iv }, sifrelemeAnahtari, enc.encode(metin)
    );
    var birlesik = new Uint8Array(iv.length + sifreli.byteLength);
    birlesik.set(iv);
    birlesik.set(new Uint8Array(sifreli), iv.length);
    return btoa(String.fromCharCode.apply(null, birlesik));
}

async function sifrecoz(b64) {
    if (!sifrelemeAnahtari) return b64;
    try {
        var ham = Uint8Array.from(atob(b64), function(c) { return c.charCodeAt(0); });
        var iv = ham.slice(0, 12);
        var veri = ham.slice(12);
        var cozulmus = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: iv }, sifrelemeAnahtari, veri
        );
        return new TextDecoder().decode(cozulmus);
    } catch (e) {
        console.error('Åifre Ã§Ã¶zme hatasÄ±:', e);
        throw e; // Hata fÄ±rlat ki passphrase yanlÄ±ÅŸsa yakalansÄ±n
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH Ä°ÅLEMLERÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gmailGiris() {
    auth.signInWithPopup(googleProvider).then(function(result) {
        var credential = result.credential;
        if (credential) {
            googleAccessToken = credential.accessToken;
        }
    }).catch(function(err) {
        console.error('GiriÅŸ hatasÄ±:', err);
        toast('GiriÅŸ baÅŸarÄ±sÄ±z, lÃ¼tfen tekrar deneyin', 'hata');
    });
}

function cikisYap() {
    if (firebaseDinleyici) {
        db.ref('passwords/' + mevcutKullanici.uid).off('value', firebaseDinleyici);
        firebaseDinleyici = null;
    }
    sifrelemeAnahtari = null;
    kullaniciSalt = null;
    passphraseDogrulandiMi = false;
    googleAccessToken = null;
    auth.signOut();
}

auth.onAuthStateChanged(async function(user) {
    if (user) {
        mevcutKullanici = user;
        // Passphrase ekranÄ±nÄ± gÃ¶ster (anahtar henÃ¼z tÃ¼retilmedi)
        passphraseEkraniGoster();
    } else {
        mevcutKullanici = null;
        sifrelemeAnahtari = null;
        kullaniciSalt = null;
        passphraseDogrulandiMi = false;
        sifreListesi = [];
        cikisYapildi();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSPHRASE EKRANI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function passphraseEkraniGoster() {
    oturumSayaciniTemizle();
    document.getElementById('giris-ekran').style.display = 'none';
    document.getElementById('ana-ekran').style.display = 'none';
    document.getElementById('header').style.display = 'none';
    document.getElementById('status-bar').style.display = 'none';
    document.getElementById('passphrase-ekran').style.display = 'flex';
    document.getElementById('passphrase-input').value = '';
    document.getElementById('passphrase-hata').textContent = '';
    document.getElementById('passphrase-btn').disabled = false;

    // KullanÄ±cÄ±nÄ±n daha Ã¶nce kaydÄ± var mÄ± kontrol et
    var ilkKullaniciMi = await ilkKullanimKontrol();
    if (ilkKullaniciMi) {
        document.getElementById('passphrase-aciklama').textContent = 'Ä°lk kullanÄ±m! Åifrelerinizi koruyacak bir gÃ¼venlik kelimesi belirleyin. Bu kelime hiÃ§bir yere kaydedilmez, her giriÅŸte sorulacaktÄ±r. UnutursanÄ±z ÅŸifrelerinize eriÅŸemezsiniz!';
        document.getElementById('passphrase-btn').textContent = 'GÃ¼venlik Kelimesi Belirle';
        document.getElementById('passphrase-bilgi').textContent = 'âš ï¸ Bu kelimeyi kesinlikle unutmayÄ±n!';
    } else {
        document.getElementById('passphrase-aciklama').textContent = 'Åifrelerinize eriÅŸmek iÃ§in gÃ¼venlik kelimenizi girin. Bu kelime hiÃ§bir yere kaydedilmez, her giriÅŸte sorulur.';
        document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
        document.getElementById('passphrase-bilgi').textContent = '';
    }

    // Enter tuÅŸu ile onaylama
    document.getElementById('passphrase-input').focus();
}

async function ilkKullanimKontrol() {
    try {
        var snapshot = await db.ref('users/' + mevcutKullanici.uid + '/salt').once('value');
        return !snapshot.val();
    } catch (e) {
        console.error('Salt kontrol hatasÄ±:', e);
        return true;
    }
}

async function passphraseOnayla() {
    var passphrase = document.getElementById('passphrase-input').value;
    if (!passphrase || passphrase.length < 5) {
        document.getElementById('passphrase-hata').textContent = 'GÃ¼venlik kelimesi en az 5 karakter olmalÄ±dÄ±r.';
        return;
    }

    document.getElementById('passphrase-btn').disabled = true;
    document.getElementById('passphrase-hata').textContent = '';
    document.getElementById('passphrase-btn').textContent = 'DoÄŸrulanÄ±yor...';

    try {
        // Firebase'den kullanÄ±cÄ± verisi Ã§ek
        var saltB64 = null;
        var kayitliHash = null;
        var kdfVersion = 2;
        var ilkKullanim = false;
        var bruteData = { failedCount: 0, lockUntil: 0, lastAttempt: 0 };

        try {
            var userSnap = await db.ref('users/' + mevcutKullanici.uid).once('value');
            var userData = userSnap.val();
            if (userData && userData.salt) {
                saltB64 = userData.salt;
                kdfVersion = userData.kdfVersion || 1;
                kayitliHash = userData.dogrulamaHashi || null;
                if (userData.bruteForce) {
                    bruteData = {
                        failedCount: userData.bruteForce.failedCount || 0,
                        lockUntil: userData.bruteForce.lockUntil || 0,
                        lastAttempt: userData.bruteForce.lastAttempt || 0
                    };
                }
            } else {
                ilkKullanim = true;
            }
        } catch (e) {
            console.error('Firebase kullanÄ±cÄ± verisi Ã§ekme hatasÄ±:', e);
            document.getElementById('passphrase-hata').textContent = 'BaÄŸlantÄ± hatasÄ±, lÃ¼tfen tekrar deneyin.';
            document.getElementById('passphrase-btn').disabled = false;
            document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
            return;
        }

        // â”€â”€ BRUTE-FORCE KÄ°LÄ°T KONTROLÃœ (Firebase'den kalÄ±cÄ±) â”€â”€
        if (bruteData.lockUntil > Date.now()) {
            var kalanSn = Math.ceil((bruteData.lockUntil - Date.now()) / 1000);
            var kalanDk = Math.ceil(kalanSn / 60);
            document.getElementById('passphrase-hata').textContent =
                'Ã‡ok fazla yanlÄ±ÅŸ deneme. ' + (kalanSn < 60 ? kalanSn + ' saniye' : kalanDk + ' dakika') + ' sonra tekrar deneyin.';
            document.getElementById('passphrase-btn').disabled = false;
            document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
            return;
        }

        if (ilkKullanim) {
            // â”€â”€ YENÄ° KULLANICI: Argon2id ile kurulum â”€â”€
            var yeniSalt = rastgeleSaltUret();
            var yeniSaltB64 = saltToBase64(yeniSalt);
            kullaniciSalt = yeniSalt;

            document.getElementById('passphrase-btn').textContent = 'Anahtar tÃ¼retiliyor...';
            sifrelemeAnahtari = await anahtarTuretArgon2(passphrase, mevcutKullanici.uid, kullaniciSalt);
            var dogrulamaHashi = await dogrulamaHashiOlusturArgon2(passphrase, mevcutKullanici.uid, kullaniciSalt);

            try {
                await db.ref('users/' + mevcutKullanici.uid).set({
                    salt: yeniSaltB64,
                    dogrulamaHashi: dogrulamaHashi,
                    kdfVersion: 2,
                    bruteForce: { failedCount: 0, lockUntil: 0, lastAttempt: 0 }
                });
            } catch (e) {
                console.error('Firebase salt kayÄ±t hatasÄ±:', e);
            }

            passphraseDogrulandiMi = true;
            girisYapildi();
            toast('GÃ¼venlik kelimesi belirlendi! (Argon2id)', 'basari');

        } else {
            // â”€â”€ MEVCUT KULLANICI â”€â”€
            kullaniciSalt = base64ToSalt(saltB64);

            document.getElementById('passphrase-btn').textContent = 'Anahtar tÃ¼retiliyor...';
            var hesaplananHash;
            if (kdfVersion === 2) {
                hesaplananHash = await dogrulamaHashiOlusturArgon2(passphrase, mevcutKullanici.uid, kullaniciSalt);
            } else {
                hesaplananHash = await dogrulamaHashiOlustur(passphrase, mevcutKullanici.uid, kullaniciSalt);
            }

            if (kayitliHash && hesaplananHash !== kayitliHash) {
                // â”€â”€ YANLIÅ DENEME: Firebase'e yaz â”€â”€
                var yeniFailedCount = bruteData.failedCount + 1;
                var yeniLockUntil = 0;
                if (yeniFailedCount >= MAX_YANLIS_DENEME) {
                    var kilitSure = KILIT_SURE_BASE * Math.pow(2, yeniFailedCount - MAX_YANLIS_DENEME);
                    yeniLockUntil = Date.now() + kilitSure;
                }
                try {
                    await db.ref('users/' + mevcutKullanici.uid + '/bruteForce').set({
                        failedCount: yeniFailedCount,
                        lockUntil: yeniLockUntil,
                        lastAttempt: Date.now()
                    });
                } catch (fbHata) {
                    console.error('Brute-force yazma hatasÄ±:', fbHata);
                }

                if (yeniLockUntil > 0) {
                    var kilitDk = Math.round((yeniLockUntil - Date.now()) / 60000);
                    document.getElementById('passphrase-hata').textContent =
                        'Ã‡ok fazla yanlÄ±ÅŸ deneme! ' + kilitDk + ' dakika kilitlendi.';
                } else {
                    var kalan = MAX_YANLIS_DENEME - yeniFailedCount;
                    document.getElementById('passphrase-hata').textContent =
                        'GÃ¼venlik kelimesi yanlÄ±ÅŸ! ' + kalan + ' deneme hakkÄ±nÄ±z kaldÄ±.';
                }
                document.getElementById('passphrase-btn').disabled = false;
                document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
                return;
            }

            // â”€â”€ DOÄRU GÄ°RÄ°Å: SayacÄ± sÄ±fÄ±rla â”€â”€
            try {
                await db.ref('users/' + mevcutKullanici.uid + '/bruteForce').set({
                    failedCount: 0,
                    lockUntil: 0,
                    lastAttempt: 0
                });
            } catch (fbHata) {
                console.error('Brute-force sÄ±fÄ±rlama hatasÄ±:', fbHata);
            }

            // AnahtarÄ± tÃ¼ret
            if (kdfVersion === 2) {
                sifrelemeAnahtari = await anahtarTuretArgon2(passphrase, mevcutKullanici.uid, kullaniciSalt);
            } else {
                sifrelemeAnahtari = await anahtarTuret(passphrase, mevcutKullanici.uid, kullaniciSalt);
            }

            passphraseDogrulandiMi = true;
            girisYapildi();

            // â”€â”€ OTOMATÄ°K GEÃ‡Ä°Å: PBKDF2 â†’ Argon2id (sessiz) â”€â”€
            if (kdfVersion === 1) {
                setTimeout(async function() {
                    try {
                        var yeniHash = await dogrulamaHashiOlusturArgon2(passphrase, mevcutKullanici.uid, kullaniciSalt);
                        var yeniAnahtar = await anahtarTuretArgon2(passphrase, mevcutKullanici.uid, kullaniciSalt);

                        var ref = db.ref('passwords/' + mevcutKullanici.uid);
                        var snap = await ref.once('value');
                        var fbVeri = snap.val();
                        if (fbVeri) {
                            var guncellemeler = {};
                            var anahtarlar = Object.keys(fbVeri);
                            for (var i = 0; i < anahtarlar.length; i++) {
                                var k = anahtarlar[i];
                                var item = fbVeri[k];
                                var hamEski = Uint8Array.from(atob(item.data), function(c) { return c.charCodeAt(0); });
                                var ivEski = hamEski.slice(0, 12);
                                var veriEski = hamEski.slice(12);
                                var cozulmus = await crypto.subtle.decrypt(
                                    { name: 'AES-GCM', iv: ivEski }, sifrelemeAnahtari, veriEski
                                );
                                var duzMetin = new TextDecoder().decode(cozulmus);
                                var ivYeni = crypto.getRandomValues(new Uint8Array(12));
                                var sifreliYeni = await crypto.subtle.encrypt(
                                    { name: 'AES-GCM', iv: ivYeni }, yeniAnahtar, new TextEncoder().encode(duzMetin)
                                );
                                var birlesikYeni = new Uint8Array(12 + sifreliYeni.byteLength);
                                birlesikYeni.set(ivYeni);
                                birlesikYeni.set(new Uint8Array(sifreliYeni), 12);
                                guncellemeler[k + '/data'] = btoa(String.fromCharCode.apply(null, birlesikYeni));
                            }
                            await ref.update(guncellemeler);
                        }

                        await db.ref('users/' + mevcutKullanici.uid).update({
                            dogrulamaHashi: yeniHash,
                            kdfVersion: 2
                        });

                        sifrelemeAnahtari = yeniAnahtar;
                        toast('ğŸ” GÃ¼venlik yÃ¼kseltildi: Argon2id aktif', 'basari');
                    } catch (gecisHata) {
                        console.error('Argon2id geÃ§iÅŸ hatasÄ±:', gecisHata);
                    }
                }, 2000);
            }
        }

    } catch (e) {
        console.error('Passphrase onay hatasÄ±:', e);
        document.getElementById('passphrase-hata').textContent = 'Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin.';
        document.getElementById('passphrase-btn').disabled = false;
        document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
    }
}

function passphraseGosterGizle() {
    var input = document.getElementById('passphrase-input');
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Enter tuÅŸu ile passphrase onaylama
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.getElementById('passphrase-ekran').style.display === 'flex') {
        passphraseOnayla();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÄ°RÄ°Å / Ã‡IKIÅ EKRAN YÃ–NETÄ°MÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function girisYapildi() {
    document.getElementById('giris-ekran').style.display = 'none';
    document.getElementById('passphrase-ekran').style.display = 'none';
    document.getElementById('ana-ekran').style.display = 'block';
    document.getElementById('header').style.display = 'flex';
    document.getElementById('status-bar').style.display = 'flex';

    var bilgi = document.getElementById('kullanici-bilgi');
    bilgi.innerHTML = '<img src="' + (mevcutKullanici.photoURL || '') + '" alt=""><span>' + (mevcutKullanici.displayName || mevcutKullanici.email) + '</span>';

    kategoriFiltreOlustur();
    durumGuncelle();
    verileriYukle();
    oturumSayaciniBaslat();
}

function cikisYapildi() {
    oturumSayaciniTemizle();
    document.getElementById('giris-ekran').style.display = 'flex';
    document.getElementById('passphrase-ekran').style.display = 'none';
    document.getElementById('ana-ekran').style.display = 'none';
    document.getElementById('header').style.display = 'none';
    document.getElementById('status-bar').style.display = 'none';
    document.getElementById('alt-menu').style.display = 'none';
    menuAcikMi = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONLINE/OFFLINE DURUM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('online', function() { baglantiDurumGuncelle(true); });
window.addEventListener('offline', function() { baglantiDurumGuncelle(false); });

function baglantiDurumGuncelle(bagli) {
    var bar = document.getElementById('status-bar');
    if (bagli) {
        bar.style.display = 'none';
    } else {
        bar.style.display = 'flex';
        document.getElementById('status-dot').className = 'status-dot offline';
        document.getElementById('status-metin').textContent = 'BaÄŸlantÄ± sorunu â€” veriler kaydedilemeyebilir';
    }
}

function durumGuncelle() {
    baglantiDurumGuncelle(navigator.onLine);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERÄ° YÃ–NETÄ°MÄ° (Firebase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function verileriYukle() {
    document.getElementById('yukleniyor').style.display = 'flex';

    var ref = db.ref('passwords/' + mevcutKullanici.uid);
    if (firebaseDinleyici) ref.off('value', firebaseDinleyici);

    firebaseDinleyici = ref.on('value', async function(snapshot) {
        document.getElementById('yukleniyor').style.display = 'none';
        var veri = snapshot.val();
        if (!veri) {
            sifreListesi = [];
            listeGuncelle();
            return;
        }

        var liste = [];
        var anahtarlar = Object.keys(veri);
        for (var i = 0; i < anahtarlar.length; i++) {
            var k = anahtarlar[i];
            var item = veri[k];
            try {
                var cozulmus = await sifrecoz(item.data);
                var obj = JSON.parse(cozulmus);
                obj.id = k;
                obj.ts = item.ts || 0;
                liste.push(obj);
            } catch (e) {
                console.error('Veri Ã§Ã¶zme hatasÄ±:', k, e);
            }
        }
        liste.sort(function(a, b) { return (b.ts || 0) - (a.ts || 0); });
        sifreListesi = liste;
        listeGuncelle();
    }, function(err) {
        document.getElementById('yukleniyor').style.display = 'none';
        console.error('Firebase okuma hatasÄ±:', err);
        toast('Veri okunamadÄ±, baÄŸlantÄ±yÄ± kontrol edin', 'hata');
        baglantiDurumGuncelle(false);
    });
}

async function verileriSenkronla() {
    if (!mevcutKullanici) return;
    toast('SenkronlanÄ±yor...', 'bilgi');
    verileriYukle();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ÅÄ°FRE CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sifreKaydet() {
    var id = document.getElementById('form-id').value;
    var baslik = document.getElementById('form-baslik').value.trim();
    var sifre = document.getElementById('form-sifre').value.trim();

    if (!baslik) { toast('BaÅŸlÄ±k zorunludur', 'hata'); return; }
    if (!sifre) { toast('Åifre zorunludur', 'hata'); return; }

    var kayit = {
        baslik: baslik,
        kategori: document.getElementById('form-kategori').value,
        kullanici: document.getElementById('form-kullanici').value.trim(),
        sifre: sifre,
        url: document.getElementById('form-url').value.trim(),
        not: document.getElementById('form-not').value.trim()
    };

    var ts = Date.now();

    try {
        var sifreliVeri = await sifrele(JSON.stringify(kayit));
        var ref = db.ref('passwords/' + mevcutKullanici.uid);

        if (id) {
            await ref.child(id).set({ data: sifreliVeri, ts: ts });
        } else {
            await ref.push({ data: sifreliVeri, ts: ts });
        }
        modalKapat();
        toast(id ? 'GÃ¼ncellendi' : 'Eklendi', 'basari');
    } catch (e) {
        console.error('KayÄ±t hatasÄ±:', e);
        toast('KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu', 'hata');
    }
}

function sifreSil(id) {
    document.getElementById('modal-sil').classList.add('aktif');
    document.getElementById('sil-onayla-btn').onclick = async function() {
        document.getElementById('modal-sil').classList.remove('aktif');
        try {
            await db.ref('passwords/' + mevcutKullanici.uid + '/' + id).remove();
            toast('Silindi', 'basari');
        } catch (e) {
            toast('Silme sÄ±rasÄ±nda bir hata oluÅŸtu', 'hata');
        }
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KATEGORÄ° FÄ°LTRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function kategoriFiltreOlustur() {
    var container = document.getElementById('kategori-filtre');
    container.innerHTML = '';
    KATEGORILER.forEach(function(kat) {
        var btn = document.createElement('button');
        btn.className = 'kat-btn' + (kat === aktifKategori ? ' aktif' : '');
        btn.textContent = kat;
        btn.onclick = function() {
            aktifKategori = kat;
            kategoriFiltreOlustur();
            sifreFiltreUygula();
        };
        container.appendChild(btn);
    });
}

function sifreFiltreUygula() {
    listeGuncelle();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LÄ°STE RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listeGuncelle() {
    var container = document.getElementById('sifre-liste');
    var aramaMetni = document.getElementById('arama-input').value.toLowerCase().trim();

    var filtreli = sifreListesi.filter(function(s) {
        var katUygun = (aktifKategori === 'TÃ¼mÃ¼') || (s.kategori === aktifKategori);
        var aramaUygun = !aramaMetni ||
            (s.baslik || '').toLowerCase().indexOf(aramaMetni) !== -1 ||
            (s.kullanici || '').toLowerCase().indexOf(aramaMetni) !== -1 ||
            (s.url || '').toLowerCase().indexOf(aramaMetni) !== -1 ||
            (s.not || '').toLowerCase().indexOf(aramaMetni) !== -1;
        return katUygun && aramaUygun;
    });

    if (filtreli.length === 0) {
        container.innerHTML = '<div class="bos-mesaj"><div class="ikon">ğŸ”‘</div><p>' +
            (sifreListesi.length === 0 ? 'HenÃ¼z ÅŸifre eklenmemiÅŸ.<br>Yeni bir tane ekleyin!' : 'SonuÃ§ bulunamadÄ±.') +
            '</p></div>';
        return;
    }

    container.innerHTML = '';
    filtreli.forEach(function(s) {
        var kart = document.createElement('div');
        kart.className = 'sifre-kart';
        kart.innerHTML =
            '<div class="kart-ust">' +
                '<span class="kart-baslik">' + htmlKacis(s.baslik) + '</span>' +
                '<span class="kart-kategori">' + htmlKacis(s.kategori || 'DiÄŸer') + '</span>' +
            '</div>' +
            (s.kullanici ? '<div class="kart-kullanici">ğŸ‘¤ ' + htmlKacis(s.kullanici) + '</div>' : '') +
            '<div class="kart-sifre-alani">' +
                '<span class="kart-sifre gizli" id="sifre-' + s.id + '">' + htmlKacis(s.sifre) + '</span>' +
                '<button class="btn-icon btn-sm" onclick="sifreGosterGizle(\'' + s.id + '\')" title="GÃ¶ster/Gizle">ğŸ‘</button>' +
                '<button class="btn-icon btn-sm" onclick="panoyaKopyala(\'' + htmlKacisAttr(s.sifre) + '\')" title="Kopyala">ğŸ“‹</button>' +
            '</div>' +
            (s.url ? (function(u){ var g=guvenliUrl(u); return g ? '<div class="kart-url"><a href="' + htmlKacis(g) + '" target="_blank" rel="noopener noreferrer" style="color:var(--accent);text-decoration:none">ğŸ”— ' + htmlKacis(g) + '</a></div>' : '<div class="kart-url" style="color:var(--text2)">ğŸ”— ' + htmlKacis(u) + ' <span style="color:var(--danger);font-size:11px">(gÃ¼vensiz URL)</span></div>'; })(s.url) : '') +
            (s.not ? '<div class="kart-not">ğŸ“ ' + htmlKacis(s.not) + '</div>' : '') +
            '<div class="kart-islemler">' +
                '<button class="btn btn-secondary btn-sm" onclick="modalAc(\'duzenle\',\'' + s.id + '\')">âœï¸ DÃ¼zenle</button>' +
                '<button class="btn btn-danger btn-sm" onclick="sifreSil(\'' + s.id + '\')">ğŸ—‘ï¸ Sil</button>' +
            '</div>';
        container.appendChild(kart);
    });
}

function sifreGosterGizle(id) {
    var el = document.getElementById('sifre-' + id);
    if (el) el.classList.toggle('gizli');
}

var panoClearTimeout = null;

async function panoyaKopyala(metin) {
    try {
        await navigator.clipboard.writeText(metin);
        toast('ğŸ“‹ KopyalandÄ± â€” 30 sn sonra temizlenecek', 'basari');
    } catch (e) {
        // Fallback
        var ta = document.createElement('textarea');
        ta.value = metin;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('ğŸ“‹ KopyalandÄ± â€” 30 sn sonra temizlenecek', 'basari');
    }

    // Ã–nceki temizleme varsa iptal et
    if (panoClearTimeout) clearTimeout(panoClearTimeout);

    // 30 saniye sonra panoyu temizle
    panoClearTimeout = setTimeout(async function() {
        try {
            await navigator.clipboard.writeText('');
        } catch (e) { /* sessizce geÃ§ */ }
        panoClearTimeout = null;
    }, 30000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL Ä°ÅLEMLERÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function modalAc(tip, id) {
    document.getElementById('form-id').value = '';
    document.getElementById('form-baslik').value = '';
    document.getElementById('form-kategori').value = 'Sosyal Medya';
    document.getElementById('form-kullanici').value = '';
    document.getElementById('form-sifre').value = '';
    document.getElementById('form-url').value = '';
    document.getElementById('form-not').value = '';

    if (tip === 'duzenle' && id) {
        var kayit = sifreListesi.find(function(s) { return s.id === id; });
        if (kayit) {
            document.getElementById('form-id').value = kayit.id;
            document.getElementById('form-baslik').value = kayit.baslik || '';
            document.getElementById('form-kategori').value = kayit.kategori || 'DiÄŸer';
            document.getElementById('form-kullanici').value = kayit.kullanici || '';
            document.getElementById('form-sifre').value = kayit.sifre || '';
            document.getElementById('form-url').value = kayit.url || '';
            document.getElementById('form-not').value = kayit.not || '';
        }
        document.getElementById('modal-baslik-text').textContent = 'Åifre DÃ¼zenle';
    } else {
        document.getElementById('modal-baslik-text').textContent = 'Yeni Åifre';
    }

    document.getElementById('modal-sifre').classList.add('aktif');
}

function modalKapat() {
    document.getElementById('modal-sifre').classList.remove('aktif');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TXT EXPORT / IMPORT (eski JSON yerine)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportBaslat() {
    if (sifreListesi.length === 0) {
        toast('DÄ±ÅŸa aktarÄ±lacak veri yok', 'hata');
        return;
    }
    // Onay modalÄ±nÄ± gÃ¶ster
    document.getElementById('modal-export').classList.add('aktif');
}

async function gmailGonder() {
    document.getElementById('modal-export').classList.remove('aktif');

    // Access token kontrolÃ¼
    if (!googleAccessToken) {
        toast('Gmail izni gerekli. Tekrar giriÅŸ yapÄ±lÄ±yor...', 'bilgi');
        try {
            var result = await auth.signInWithPopup(googleProvider);
            var credential = result.credential;
            if (credential) {
                googleAccessToken = credential.accessToken;
            }
        } catch (e) {
            console.error('Gmail izin hatasÄ±:', e);
            toast('Gmail izni alÄ±namadÄ±', 'hata');
            return;
        }
    }

    if (!googleAccessToken) {
        toast('Gmail eriÅŸim izni alÄ±namadÄ±', 'hata');
        return;
    }

    var exportVeri = sifreListesi.map(function(s) {
        return {
            baslik: s.baslik,
            kategori: s.kategori,
            kullanici: s.kullanici,
            sifre: s.sifre,
            url: s.url,
            not: s.not
        };
    });

    // ÅÄ°FRELÄ° EXPORT: Veriler AES-GCM ile ÅŸifrelenerek gÃ¶nderiliyor
    var jsonStr = JSON.stringify(exportVeri);
    var sifreliIcerik;
    try {
        sifreliIcerik = await sifrele(jsonStr);
    } catch (e) {
        console.error('Export ÅŸifreleme hatasÄ±:', e);
        toast('DÄ±ÅŸa aktarma sÄ±rasÄ±nda bir hata oluÅŸtu', 'hata');
        return;
    }

    var dosyaAdi = 'sifrelerim_' + new Date().toISOString().slice(0, 10) + '.enc';
    var kullaniciEmail = mevcutKullanici.email;
    var tarih = new Date().toLocaleString('tr-TR');

    // MIME multipart e-posta oluÅŸtur (ÅŸifreli dosya ekli)
    var boundary = 'boundary_' + Date.now();
    var mailGovdesi =
        'Åifre HatÄ±rlatÄ±cÄ± â€” Åifreli Yedek DosyanÄ±z\n' +
        'Tarih: ' + tarih + '\n' +
        'Toplam: ' + exportVeri.length + ' ÅŸifre\n\n' +
        'âš ï¸ Bu dosya AES-256-GCM ile ÅŸifrelidir.\n' +
        'Uygulamaya geri yÃ¼klemek iÃ§in Ä°Ã§e Aktar Ã¶zelliÄŸini kullanÄ±n.\n' +
        'Passphrase\'iniz olmadan aÃ§Ä±lamaz.';

    var mimeMessage = [
        'From: me',
        'To: ' + kullaniciEmail,
        'Subject: =?UTF-8?B?' + btoa(unescape(encodeURIComponent('Åifre Yedek (Åifreli) â€” ' + tarih))) + '?=',
        'MIME-Version: 1.0',
        'Content-Type: multipart/mixed; boundary="' + boundary + '"',
        '',
        '--' + boundary,
        'Content-Type: text/plain; charset=UTF-8',
        'Content-Transfer-Encoding: base64',
        '',
        btoa(unescape(encodeURIComponent(mailGovdesi))),
        '',
        '--' + boundary,
        'Content-Type: application/octet-stream; name="' + dosyaAdi + '"',
        'Content-Disposition: attachment; filename="' + dosyaAdi + '"',
        'Content-Transfer-Encoding: base64',
        '',
        btoa(unescape(encodeURIComponent(sifreliIcerik))),
        '',
        '--' + boundary + '--'
    ].join('\r\n');

    // Base64url encode
    var raw = btoa(unescape(encodeURIComponent(mimeMessage)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');

    toast('Gmail\'e gÃ¶nderiliyor...', 'bilgi');

    try {
        var response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + googleAccessToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ raw: raw })
        });

        googleAccessToken = null; // KullanÄ±m sonrasÄ± token'Ä± temizle

        if (response.ok) {
            toast('Åifreli yedek Gmail\'inize gÃ¶nderildi! ğŸ“§', 'basari');
        } else if (response.status === 401) {
            toast('Gmail oturumu sÃ¼resi doldu, tekrar deneyin', 'hata');
        } else {
            var errData = await response.json();
            console.error('Gmail API hatasÄ±:', errData);
            toast('GÃ¶nderim baÅŸarÄ±sÄ±z (kod: ' + response.status + ')', 'hata');
        }
    } catch (e) {
        console.error('Gmail gÃ¶nderim hatasÄ±:', e);
        toast('GÃ¶nderim sÄ±rasÄ±nda bir hata oluÅŸtu', 'hata');
    }
}

async function txtImport(event) {
    var dosya = event.target.files[0];
    if (!dosya) return;

    var reader = new FileReader();
    reader.onload = async function(e) {
        try {
            var icerik = e.target.result.trim();
            var veri;

            // Åifreli (.enc) mi yoksa eski dÃ¼z metin (.txt) mi?
            var sifreliBaÅŸliyor = false;
            try {
                // AES-GCM ÅŸifreli veriler base64 olur ve JSON ile baÅŸlamaz
                var deneme = JSON.parse(icerik);
                if (Array.isArray(deneme)) {
                    // Eski dÃ¼z metin format
                    veri = deneme;
                } else {
                    sifreliBaÅŸliyor = true;
                }
            } catch (parseErr) {
                // JSON deÄŸil â†’ ÅŸifreli olabilir
                sifreliBaÅŸliyor = true;
            }

            if (sifreliBaÅŸliyor) {
                // Åifreli dosyayÄ± Ã§Ã¶z
                try {
                    var cozulmus = await sifrecoz(icerik);
                    veri = JSON.parse(cozulmus);
                    if (!Array.isArray(veri)) { toast('GeÃ§ersiz ÅŸifreli format', 'hata'); return; }
                } catch (cozErr) {
                    toast('Åifreli dosya Ã§Ã¶zÃ¼lemedi. Passphrase doÄŸru mu?', 'hata');
                    return;
                }
            }

            if (!Array.isArray(veri)) { toast('GeÃ§ersiz format', 'hata'); return; }

            var eklenen = 0;
            for (var i = 0; i < veri.length; i++) {
                var item = veri[i];
                if (!item.baslik || !item.sifre) continue;

                var kayit = {
                    baslik: item.baslik || '',
                    kategori: item.kategori || 'DiÄŸer',
                    kullanici: item.kullanici || '',
                    sifre: item.sifre || '',
                    url: item.url || '',
                    not: item.not || ''
                };

                var ts = Date.now() + i;
                var sifreliVeri = await sifrele(JSON.stringify(kayit));
                await db.ref('passwords/' + mevcutKullanici.uid).push({ data: sifreliVeri, ts: ts });
                eklenen++;
            }

            toast(eklenen + ' ÅŸifre iÃ§e aktarÄ±ldÄ±', 'basari');
        } catch (err) {
            toast('Dosya okunamadÄ±, format geÃ§ersiz olabilir', 'hata');
        }
    };
    reader.readAsText(dosya);
    event.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OTURUM ZAMAN AÅIMI (SESSION TIMEOUT)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _aktiviteDinleyicileriEklendi = false;

function oturumSayaciniBaslat() {
    oturumSayaciniTemizle();
    uyariVerildiMi = false;
    if (!_aktiviteDinleyicileriEklendi) {
        ['mousemove', 'keydown', 'click', 'touchstart', 'scroll'].forEach(function(olay) {
            document.addEventListener(olay, oturumSayaciniSifirla, true);
        });
        _aktiviteDinleyicileriEklendi = true;
    }
    oturumSayaciniSifirla();
}

function oturumSayaciniSifirla() {
    if (!passphraseDogrulandiMi) return;
    clearTimeout(oturumZamanAsimi);
    clearTimeout(uyariZamanAsimi);
    uyariVerildiMi = false;

    // 60 saniye kala uyarÄ± ver
    uyariZamanAsimi = setTimeout(function() {
        if (!passphraseDogrulandiMi) return;
        uyariVerildiMi = true;
        toast('âš ï¸ Hareketsizlik nedeniyle 60 saniye sonra kilitlenecek', 'bilgi');
    }, OTURUM_SURE - 60000);

    // SÃ¼re dolunca kilitle
    oturumZamanAsimi = setTimeout(function() {
        if (!passphraseDogrulandiMi) return;
        oturumKilitle();
    }, OTURUM_SURE);
}

function oturumSayaciniTemizle() {
    clearTimeout(oturumZamanAsimi);
    clearTimeout(uyariZamanAsimi);
    oturumZamanAsimi = null;
    uyariZamanAsimi = null;
}

function oturumKilitle() {
    oturumSayaciniTemizle();
    // Sadece ÅŸifreleme anahtarÄ±nÄ± bellekten sil, Google oturumunu kapat
    sifrelemeAnahtari = null;
    kullaniciSalt = null;
    passphraseDogrulandiMi = false;
    sifreListesi = [];

    // Passphrase ekranÄ±na dÃ¶n
    document.getElementById('ana-ekran').style.display = 'none';
    document.getElementById('header').style.display = 'none';
    document.getElementById('status-bar').style.display = 'none';
    document.getElementById('alt-menu').style.display = 'none';
    menuAcikMi = false;

    // AÃ§Ä±k modallarÄ± kapat
    document.getElementById('modal-sifre').classList.remove('aktif');
    document.getElementById('modal-sil').classList.remove('aktif');
    document.getElementById('modal-export').classList.remove('aktif');

    // Passphrase ekranÄ±nÄ± gÃ¶ster
    passphraseEkraniGoster();
    toast('ğŸ”’ GÃ¼venlik nedeniyle ekran kilitlendi. Passphrase girin.', 'hata');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YARDIMCI FONKSÄ°YONLAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function guvenliUrl(url) {
    if (!url) return null;
    var temiz = url.trim();
    var kucuk = temiz.toLowerCase();
    if (kucuk.startsWith('https://') || kucuk.startsWith('http://')) return temiz;
    return null; // javascript:, data:, vbscript: ve diÄŸer scheme'leri engelle
}

function htmlKacis(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function htmlKacisAttr(str) {
    return (str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

function toast(mesaj, tip) {
    var container = document.getElementById('toast-container');
    var el = document.createElement('div');
    el.className = 'toast ' + (tip || 'bilgi');
    el.textContent = mesaj;
    container.appendChild(el);
    setTimeout(function() { el.remove(); }, 3000);
}

function menuToggle() {
    menuAcikMi = !menuAcikMi;
    document.getElementById('alt-menu').style.display = menuAcikMi ? 'flex' : 'none';
}

// ESC ile modal kapat
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        modalKapat();
        document.getElementById('modal-sil').classList.remove('aktif');
        document.getElementById('modal-export').classList.remove('aktif');
    }
});

// Modal overlay tÄ±klama ile kapat
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
            overlay.classList.remove('aktif');
        }
    });
});

// BaÅŸlangÄ±Ã§ durumu
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÃœVENLÄ°K KELÄ°MESÄ° DEÄÄ°ÅTÄ°RME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function passphraseeDegistirModalAc() {
    document.getElementById('pd-eski').value = '';
    document.getElementById('pd-yeni').value = '';
    document.getElementById('pd-yeni2').value = '';
    document.getElementById('pd-hata').textContent = '';
    document.getElementById('pd-btn').disabled = false;
    document.getElementById('pd-btn').textContent = 'DeÄŸiÅŸtir';
    document.getElementById('modal-passphrase-degistir').classList.add('aktif');
    menuAcikMi = false;
    document.getElementById('alt-menu').style.display = 'none';
    setTimeout(function() { document.getElementById('pd-eski').focus(); }, 100);
}

function passphraseeDegistirModalKapat() {
    document.getElementById('modal-passphrase-degistir').classList.remove('aktif');
}

function pdGosterGizle(id) {
    var input = document.getElementById(id);
    input.type = input.type === 'password' ? 'text' : 'password';
}

async function passphraseeDegistir() {
    var eski = document.getElementById('pd-eski').value;
    var yeni = document.getElementById('pd-yeni').value;
    var yeni2 = document.getElementById('pd-yeni2').value;
    var hataEl = document.getElementById('pd-hata');
    var btn = document.getElementById('pd-btn');

    hataEl.textContent = '';

    if (!eski) { hataEl.textContent = 'Mevcut gÃ¼venlik kelimesini girin.'; return; }
    if (!yeni || yeni.length < 5) { hataEl.textContent = 'Yeni gÃ¼venlik kelimesi en az 5 karakter olmalÄ±dÄ±r.'; return; }
    if (yeni !== yeni2) { hataEl.textContent = 'Yeni gÃ¼venlik kelimeleri eÅŸleÅŸmiyor.'; return; }
    if (eski === yeni) { hataEl.textContent = 'Yeni gÃ¼venlik kelimesi eskiyle aynÄ± olamaz.'; return; }

    btn.disabled = true;
    btn.textContent = 'DoÄŸrulanÄ±yor...';

    try {
        // Eski passphrase'Ä± doÄŸrula
        var kayitliHash = null;
        try {
            var snap = await db.ref('users/' + mevcutKullanici.uid + '/dogrulamaHashi').once('value');
            if (snap.val()) kayitliHash = snap.val();
        } catch (e) {
            hataEl.textContent = 'BaÄŸlantÄ± hatasÄ±, lÃ¼tfen tekrar deneyin.';
            btn.disabled = false;
            btn.textContent = 'DeÄŸiÅŸtir';
            return;
        }
        var eskiHash = await dogrulamaHashiOlusturArgon2(eski, mevcutKullanici.uid, kullaniciSalt);
        if (kayitliHash && eskiHash !== kayitliHash) {
            hataEl.textContent = 'Mevcut gÃ¼venlik kelimesi yanlÄ±ÅŸ.';
            btn.disabled = false;
            btn.textContent = 'DeÄŸiÅŸtir';
            return;
        }

        btn.textContent = 'Yeni anahtar tÃ¼retiliyor...';

        // Yeni salt + anahtar + doÄŸrulama hash'i
        var yeniSalt = rastgeleSaltUret();
        var yeniSaltB64 = saltToBase64(yeniSalt);
        var yeniAnahtar = await anahtarTuretArgon2(yeni, mevcutKullanici.uid, yeniSalt);
        var yeniDogrulamaHashi = await dogrulamaHashiOlusturArgon2(yeni, mevcutKullanici.uid, yeniSalt);

        btn.textContent = 'Veriler yeniden ÅŸifreleniyor...';

        // Firebase'deki tÃ¼m ÅŸifreleri eski â†’ yeni anahtarla dÃ¶nÃ¼ÅŸtÃ¼r
        var ref = db.ref('passwords/' + mevcutKullanici.uid);
        var fbSnap = await ref.once('value');
        var fbVeri = fbSnap.val();
        if (fbVeri) {
            var guncellemeler = {};
            var anahtarlar = Object.keys(fbVeri);
            for (var i = 0; i < anahtarlar.length; i++) {
                var k = anahtarlar[i];
                var ham = Uint8Array.from(atob(fbVeri[k].data), function(c) { return c.charCodeAt(0); });
                var iv = ham.slice(0, 12);
                var veri = ham.slice(12);
                var cozulmus = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, sifrelemeAnahtari, veri);
                var duzMetin = new TextDecoder().decode(cozulmus);
                var ivYeni = crypto.getRandomValues(new Uint8Array(12));
                var sifreliYeni = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: ivYeni }, yeniAnahtar, new TextEncoder().encode(duzMetin));
                var birlesik = new Uint8Array(12 + sifreliYeni.byteLength);
                birlesik.set(ivYeni);
                birlesik.set(new Uint8Array(sifreliYeni), 12);
                guncellemeler[k + '/data'] = btoa(String.fromCharCode.apply(null, birlesik));
            }
            await ref.update(guncellemeler);
        }
        // Firebase'de salt + hash + kdfVersion gÃ¼ncelle
        await db.ref('users/' + mevcutKullanici.uid).set({
            salt: yeniSaltB64,
            dogrulamaHashi: yeniDogrulamaHashi,
            kdfVersion: 2
        });

        // Bellek gÃ¼ncelle
        kullaniciSalt = yeniSalt;
        sifrelemeAnahtari = yeniAnahtar;

        passphraseeDegistirModalKapat();
        toast('ğŸ”‘ GÃ¼venlik kelimesi baÅŸarÄ±yla deÄŸiÅŸtirildi!', 'basari');

    } catch (e) {
        console.error('Passphrase deÄŸiÅŸtirme hatasÄ±:', e);
        hataEl.textContent = 'Bir hata oluÅŸtu, lÃ¼tfen tekrar deneyin.';
        btn.disabled = false;
        btn.textContent = 'DeÄŸiÅŸtir';
    }
}

durumGuncelle();
</script>
</body>
</html>