<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Åifre HatÄ±rlatÄ±cÄ±</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1117;--surface:#1a1d27;--surface2:#242836;--border:#2e3346;
  --text:#e4e6ef;--text2:#9498ad;--accent:#6c8aff;--accent2:#4e6de0;
  --danger:#ef4444;--success:#22c55e;--warn:#f59e0b;
  --radius:10px;--shadow:0 2px 12px rgba(0,0,0,0.3);
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
button{font-family:inherit;cursor:pointer;border:none;outline:none;transition:all .2s}
input,select,textarea{font-family:inherit;outline:none;border:1px solid var(--border);background:var(--surface2);color:var(--text);border-radius:var(--radius);padding:10px 14px;font-size:14px;width:100%;transition:border .2s}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
textarea{resize:vertical;min-height:60px}
select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239498ad' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L2 5h12z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}

.container{max-width:520px;margin:0 auto;padding:16px}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 0;margin-bottom:8px}
.header h1{font-size:20px;font-weight:700;letter-spacing:-0.3px}
.header h1 span{color:var(--accent)}

.status-bar{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2);margin-bottom:16px}
.status-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.status-dot.online{background:var(--success)}
.status-dot.offline{background:var(--danger)}

/* GiriÅŸ EkranÄ± */
#giris-ekran{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center;gap:24px}
#giris-ekran h2{font-size:28px;font-weight:700}
#giris-ekran h2 span{color:var(--accent)}
#giris-ekran p{color:var(--text2);max-width:300px}
.btn-google{display:flex;align-items:center;gap:10px;background:#fff;color:#333;font-size:15px;font-weight:600;padding:12px 28px;border-radius:var(--radius);box-shadow:var(--shadow)}
.btn-google:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.4)}
.btn-google img{width:20px;height:20px}

/* Passphrase EkranÄ± */
#passphrase-ekran{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:70vh;text-align:center;gap:20px}
#passphrase-ekran h2{font-size:24px;font-weight:700}
#passphrase-ekran h2 span{color:var(--accent)}
#passphrase-ekran p{color:var(--text2);max-width:340px;font-size:14px}
.passphrase-input-wrap{width:100%;max-width:320px;position:relative}
.passphrase-input-wrap input{padding-right:44px}
.passphrase-toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:4px}
.passphrase-btn{padding:12px 32px;border-radius:var(--radius);font-size:15px;font-weight:600;background:var(--accent);color:#fff}
.passphrase-btn:hover{background:var(--accent2)}
.passphrase-btn:disabled{opacity:0.5;cursor:not-allowed}
.passphrase-hata{color:var(--danger);font-size:13px;min-height:20px}
.passphrase-bilgi{color:var(--text2);font-size:12px;max-width:340px}

/* Ana Ekran */
#ana-ekran{display:none}
.toolbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.toolbar input{flex:1;min-width:150px}
.btn{padding:8px 16px;border-radius:var(--radius);font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--accent);color:var(--text)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-sm{padding:6px 10px;font-size:12px}
.btn-icon{padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text2);font-size:16px}
.btn-icon:hover{border-color:var(--accent);color:var(--text)}

.kategori-filtre{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.kategori-filtre::-webkit-scrollbar{display:none}
.kat-btn{padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;background:var(--surface2);color:var(--text2);border:1px solid var(--border);white-space:nowrap;flex-shrink:0}
.kat-btn.aktif{background:var(--accent);color:#fff;border-color:var(--accent)}
.kat-btn:hover{border-color:var(--accent)}

.sifre-liste{display:flex;flex-direction:column;gap:8px}
.sifre-kart{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:border .2s;cursor:pointer}
.sifre-kart:hover{border-color:var(--accent)}
.kart-ust{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.kart-baslik{font-weight:600;font-size:15px}
.kart-kategori{font-size:11px;padding:3px 8px;border-radius:12px;background:var(--surface2);color:var(--text2)}
.kart-kullanici{font-size:13px;color:var(--text2)}
.kart-sifre-alani{display:flex;align-items:center;gap:8px;margin-top:8px}
.kart-sifre{font-family:'Courier New',monospace;font-size:14px;background:var(--surface2);padding:6px 10px;border-radius:6px;flex:1;word-break:break-all}
.kart-sifre.gizli{color:transparent;text-shadow:0 0 8px var(--text2);user-select:none}
.kart-url{font-size:12px;color:var(--accent);margin-top:6px;word-break:break-all}
.kart-not{font-size:12px;color:var(--text2);margin-top:4px;font-style:italic}
.kart-islemler{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}

.bos-mesaj{text-align:center;padding:48px 16px;color:var(--text2)}
.bos-mesaj .ikon{font-size:48px;margin-bottom:12px;opacity:.5}
.bos-mesaj p{font-size:14px}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;align-items:center;justify-content:center;padding:16px}
.modal-overlay.aktif{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;width:100%;max-width:440px;max-height:85vh;overflow-y:auto;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
.modal-baslik{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.modal-baslik h3{font-size:16px;font-weight:700}
.modal-icerik{padding:20px;display:flex;flex-direction:column;gap:14px}
.form-grup{display:flex;flex-direction:column;gap:5px}
.form-grup label{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.modal-alt{display:flex;gap:8px;justify-content:flex-end;padding:16px 20px;border-top:1px solid var(--border)}

/* Alt MenÃ¼ */
.alt-menu{display:flex;gap:8px;justify-content:center;padding:16px 0;margin-top:16px;border-top:1px solid var(--border);flex-wrap:wrap}

/* KullanÄ±cÄ± */
.kullanici-bilgi{display:flex;align-items:center;gap:10px}
.kullanici-bilgi img{width:32px;height:32px;border-radius:50%;border:2px solid var(--border)}
.kullanici-bilgi span{font-size:13px;color:var(--text2)}

/* Toast */
.toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:8px;align-items:center}
.toast{padding:10px 20px;border-radius:var(--radius);font-size:13px;font-weight:600;box-shadow:var(--shadow);animation:toastIn .3s ease}
.toast.basari{background:var(--success);color:#fff}
.toast.hata{background:var(--danger);color:#fff}
.toast.bilgi{background:var(--accent);color:#fff}
@keyframes toastIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* YÃ¼kleniyor */
.yukleniyor{display:flex;align-items:center;justify-content:center;padding:32px;color:var(--text2);font-size:14px;gap:8px}
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:400px){
  .container{padding:10px}
  .toolbar{flex-direction:column}
  .btn{justify-content:center}
}
</style>
</head>
<body>

<div class="container">
  <!-- HEADER -->
  <div class="header" id="header" style="display:none">
    <h1>ğŸ” <span>Åifre</span> HatÄ±rlatÄ±cÄ±</h1>
    <div class="kullanici-bilgi" id="kullanici-bilgi"></div>
  </div>

  <!-- STATUS BAR -->
  <div class="status-bar" id="status-bar" style="display:none">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-metin"></span>
  </div>

  <!-- GÄ°RÄ°Å EKRANI -->
  <div id="giris-ekran">
    <h2>ğŸ” <span>Åifre</span> HatÄ±rlatÄ±cÄ±</h2>
    <p>Åifrelerini gÃ¼venle sakla, istediÄŸin yerden eriÅŸ.</p>
    <button class="btn-google" onclick="gmailGiris()">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G">
      Google ile GiriÅŸ Yap
    </button>
  </div>

  <!-- PASSPHRASE EKRANI -->
  <div id="passphrase-ekran">
    <h2>ğŸ”‘ <span>GÃ¼venlik</span> Kelimesi</h2>
    <p id="passphrase-aciklama">Åifrelerinizi korumak iÃ§in gÃ¼venlik kelimenizi girin. Bu kelime hiÃ§bir yere kaydedilmez, her giriÅŸte sorulur.</p>
    <div class="passphrase-input-wrap">
      <input type="password" id="passphrase-input" placeholder="GÃ¼venlik kelimeniz..." autocomplete="off">
      <button class="passphrase-toggle" onclick="passphraseGosterGizle()" title="GÃ¶ster/Gizle">ğŸ‘</button>
    </div>
    <div class="passphrase-hata" id="passphrase-hata"></div>
    <button class="passphrase-btn" id="passphrase-btn" onclick="passphraseOnayla()">Kilidi AÃ§</button>
    <p class="passphrase-bilgi" id="passphrase-bilgi"></p>
  </div>

  <!-- ANA EKRAN -->
  <div id="ana-ekran">
    <!-- Arama & Ekle -->
    <div class="toolbar">
      <input type="text" id="arama-input" placeholder="Ara..." oninput="sifreFiltreUygula()">
      <button class="btn btn-primary" onclick="modalAc('ekle')">+ Yeni</button>
      <button class="btn-icon" onclick="menuToggle()" title="MenÃ¼">â˜°</button>
    </div>

    <!-- Kategori Filtre -->
    <div class="kategori-filtre" id="kategori-filtre"></div>

    <!-- Åifre Listesi -->
    <div class="sifre-liste" id="sifre-liste"></div>
    <div class="yukleniyor" id="yukleniyor" style="display:none"><div class="spinner"></div> YÃ¼kleniyor...</div>

    <!-- Alt MenÃ¼ -->
    <div class="alt-menu" id="alt-menu" style="display:none">
      <button class="btn btn-secondary btn-sm" onclick="exportBaslat()">ğŸ“§ Gmail'ime GÃ¶nder</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('txt-import').click()">ğŸ“¥ Ä°Ã§e Aktar</button>
      <button class="btn btn-secondary btn-sm" onclick="verileriSenkronla()">ğŸ”„ Senkronla</button>
      <button class="btn btn-danger btn-sm" onclick="cikisYap()">ğŸšª Ã‡Ä±kÄ±ÅŸ</button>
      <input type="file" id="txt-import" accept=".txt,.json" style="display:none" onchange="txtImport(event)">
    </div>
  </div>
</div>

<!-- EKLE/DÃœZENLE MODAL -->
<div class="modal-overlay" id="modal-sifre">
  <div class="modal">
    <div class="modal-baslik">
      <h3 id="modal-baslik-text">Yeni Åifre</h3>
      <button class="btn-icon" onclick="modalKapat()">âœ•</button>
    </div>
    <div class="modal-icerik">
      <input type="hidden" id="form-id">
      <div class="form-grup">
        <label>BaÅŸlÄ±k *</label>
        <input type="text" id="form-baslik" placeholder="Ã¶r: Gmail, Netflix...">
      </div>
      <div class="form-grup">
        <label>Kategori</label>
        <select id="form-kategori">
          <option value="Sosyal Medya">Sosyal Medya</option>
          <option value="Banka">Banka</option>
          <option value="E-posta">E-posta</option>
          <option value="AlÄ±ÅŸveriÅŸ">AlÄ±ÅŸveriÅŸ</option>
          <option value="Ä°ÅŸ">Ä°ÅŸ</option>
          <option value="EÄŸlence">EÄŸlence</option>
          <option value="DiÄŸer">DiÄŸer</option>
        </select>
      </div>
      <div class="form-grup">
        <label>KullanÄ±cÄ± AdÄ± / E-posta</label>
        <input type="text" id="form-kullanici" placeholder="Ã¶r: kullanici@gmail.com">
      </div>
      <div class="form-grup">
        <label>Åifre *</label>
        <input type="text" id="form-sifre" placeholder="Åifreniz">
      </div>
      <div class="form-grup">
        <label>URL</label>
        <input type="url" id="form-url" placeholder="https://...">
      </div>
      <div class="form-grup">
        <label>Not</label>
        <textarea id="form-not" placeholder="Ek bilgi..."></textarea>
      </div>
    </div>
    <div class="modal-alt">
      <button class="btn btn-secondary" onclick="modalKapat()">Ä°ptal</button>
      <button class="btn btn-primary" onclick="sifreKaydet()">Kaydet</button>
    </div>
  </div>
</div>

<!-- SÄ°L ONAY MODAL -->
<div class="modal-overlay" id="modal-sil">
  <div class="modal" style="max-width:340px">
    <div class="modal-baslik">
      <h3>Silme OnayÄ±</h3>
      <button class="btn-icon" onclick="document.getElementById('modal-sil').classList.remove('aktif')">âœ•</button>
    </div>
    <div class="modal-icerik">
      <p style="font-size:14px;color:var(--text2)">Bu ÅŸifreyi silmek istediÄŸinize emin misiniz?</p>
    </div>
    <div class="modal-alt">
      <button class="btn btn-secondary" onclick="document.getElementById('modal-sil').classList.remove('aktif')">Ä°ptal</button>
      <button class="btn btn-danger" id="sil-onayla-btn">Sil</button>
    </div>
  </div>
</div>

<!-- EXPORT ONAY MODAL -->
<div class="modal-overlay" id="modal-export">
  <div class="modal" style="max-width:400px">
    <div class="modal-baslik">
      <h3>ğŸ“§ Gmail'e GÃ¶nderme</h3>
      <button class="btn-icon" onclick="document.getElementById('modal-export').classList.remove('aktif')">âœ•</button>
    </div>
    <div class="modal-icerik">
      <p style="font-size:14px;color:var(--text2)">Åifreleriniz <strong>panoya kopyalanacak</strong> ve Gmail penceresi aÃ§Ä±lacaktÄ±r.</p>
      <p style="font-size:14px;color:var(--text2)">AÃ§Ä±lan mail gÃ¶vdesine <strong style="color:var(--accent)">yapÄ±ÅŸtÄ±rÄ±p (Ctrl+V)</strong> gÃ¶nderin.</p>
      <p style="font-size:13px;color:var(--warn)">âš ï¸ Åifreleriniz dÃ¼z metin olarak gÃ¶nderilecektir.</p>
    </div>
    <div class="modal-alt">
      <button class="btn btn-secondary" onclick="document.getElementById('modal-export').classList.remove('aktif')">Ä°ptal</button>
      <button class="btn btn-primary" onclick="clipboardMailtoGonder()">Kopyala ve Mail AÃ§</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-container" id="toast-container"></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var firebaseConfig = {
    apiKey: "AIzaSyB5YosGWGdxZ-nizZ7ROf_XtZat76z6-4Q",
    authDomain: "sifrehatirlatici-cf65d.firebaseapp.com",
    databaseURL: "https://sifrehatirlatici-cf65d-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "sifrehatirlatici-cf65d",
    storageBucket: "sifrehatirlatici-cf65d.firebasestorage.app",
    messagingSenderId: "102814458136",
    appId: "1:102814458136:web:c5ae4a837d2264f9c57e6d"
};
firebase.initializeApp(firebaseConfig);
var auth = firebase.auth();
var db = firebase.database();
var googleProvider = new firebase.auth.GoogleAuthProvider();
auth.languageCode = 'tr';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL DEÄÄ°ÅKENLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var mevcutKullanici = null;
var sifreListesi = [];
var aktifKategori = 'TÃ¼mÃ¼';
var cevrimIciMi = navigator.onLine;
var sifrelemeAnahtari = null;
var firebaseDinleyici = null;
var menuAcikMi = false;
var kullaniciSalt = null; // KullanÄ±cÄ±ya Ã¶zel rastgele salt (16 byte)
var passphraseDogrulandiMi = false;

var KATEGORILER = ['TÃ¼mÃ¼', 'Sosyal Medya', 'Banka', 'E-posta', 'AlÄ±ÅŸveriÅŸ', 'Ä°ÅŸ', 'EÄŸlence', 'DiÄŸer'];
var LOKAL_ANAHTAR = 'sifreHatirlatici_';
var LOKAL_SALT_ANAHTAR = 'sifreHatirlatici_salt_';
var LOKAL_DOGRULAMA_ANAHTAR = 'sifreHatirlatici_dogrulama_';
var LOKAL_SIFRELI_VERI_ANAHTAR = 'sifreHatirlatici_enc_';
var PBKDF2_ITERASYON = 600000; // OWASP 2023 SHA-256 Ã¶nerisi

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AES-GCM ÅÄ°FRELEME (Web Crypto API) - PASSPHRASE TABANLI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// KullanÄ±cÄ± passphrase + uid + rastgele salt ile anahtar tÃ¼ret
async function anahtarTuret(passphrase, uid, salt) {
    var enc = new TextEncoder();
    var keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode(passphrase + uid), 'PBKDF2', false, ['deriveKey']
    );
    var anahtar = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITERASYON, hash: 'SHA-256' },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt', 'decrypt']
    );
    return anahtar;
}

// Passphrase doÄŸrulama hash'i oluÅŸtur (ayrÄ± bir PBKDF2 tÃ¼retme)
async function dogrulamaHashiOlustur(passphrase, uid, salt) {
    var enc = new TextEncoder();
    var keyMaterial = await crypto.subtle.importKey(
        'raw', enc.encode('dogrulama_' + passphrase + uid), 'PBKDF2', false, ['deriveBits']
    );
    var bits = await crypto.subtle.deriveBits(
        { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITERASYON, hash: 'SHA-256' },
        keyMaterial,
        256
    );
    return btoa(String.fromCharCode.apply(null, new Uint8Array(bits)));
}

// Rastgele 16 byte salt Ã¼ret
function rastgeleSaltUret() {
    return crypto.getRandomValues(new Uint8Array(16));
}

// Salt'Ä± base64'e Ã§evir
function saltToBase64(salt) {
    return btoa(String.fromCharCode.apply(null, salt));
}

// Base64'ten salt'a Ã§evir
function base64ToSalt(b64) {
    return Uint8Array.from(atob(b64), function(c) { return c.charCodeAt(0); });
}

async function sifrele(metin) {
    if (!sifrelemeAnahtari) return metin;
    var enc = new TextEncoder();
    var iv = crypto.getRandomValues(new Uint8Array(12));
    var sifreli = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: iv }, sifrelemeAnahtari, enc.encode(metin)
    );
    var birlesik = new Uint8Array(iv.length + sifreli.byteLength);
    birlesik.set(iv);
    birlesik.set(new Uint8Array(sifreli), iv.length);
    return btoa(String.fromCharCode.apply(null, birlesik));
}

async function sifrecoz(b64) {
    if (!sifrelemeAnahtari) return b64;
    try {
        var ham = Uint8Array.from(atob(b64), function(c) { return c.charCodeAt(0); });
        var iv = ham.slice(0, 12);
        var veri = ham.slice(12);
        var cozulmus = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: iv }, sifrelemeAnahtari, veri
        );
        return new TextDecoder().decode(cozulmus);
    } catch (e) {
        console.error('Åifre Ã§Ã¶zme hatasÄ±:', e);
        throw e; // Hata fÄ±rlat ki passphrase yanlÄ±ÅŸsa yakalansÄ±n
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LOKAL ÅÄ°FRELÄ° DEPOLAMA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function lokalKaydet() {
    if (!sifrelemeAnahtari || !mevcutKullanici) return;
    try {
        var veriStr = JSON.stringify(sifreListesi);
        var sifreliVeri = await sifrele(veriStr);
        localStorage.setItem(LOKAL_SIFRELI_VERI_ANAHTAR + mevcutKullanici.uid, sifreliVeri);
    } catch (e) {
        console.error('Lokal ÅŸifreli kayÄ±t hatasÄ±:', e);
    }
}

async function lokalOku() {
    if (!sifrelemeAnahtari || !mevcutKullanici) return [];
    try {
        var sifreliVeri = localStorage.getItem(LOKAL_SIFRELI_VERI_ANAHTAR + mevcutKullanici.uid);
        if (!sifreliVeri) return [];
        var cozulmus = await sifrecoz(sifreliVeri);
        return JSON.parse(cozulmus);
    } catch (e) {
        console.error('Lokal ÅŸifreli okuma hatasÄ±:', e);
        return [];
    }
}

// Salt'Ä± lokalde sakla (salt gizli olmak zorunda deÄŸil)
function lokalSaltKaydet(uid, saltB64) {
    localStorage.setItem(LOKAL_SALT_ANAHTAR + uid, saltB64);
}

function lokalSaltOku(uid) {
    return localStorage.getItem(LOKAL_SALT_ANAHTAR + uid);
}

// DoÄŸrulama hash'ini lokalde sakla
function lokalDogrulamaKaydet(uid, hash) {
    localStorage.setItem(LOKAL_DOGRULAMA_ANAHTAR + uid, hash);
}

function lokalDogrulamaOku(uid) {
    return localStorage.getItem(LOKAL_DOGRULAMA_ANAHTAR + uid);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH Ä°ÅLEMLERÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gmailGiris() {
    auth.signInWithPopup(googleProvider).catch(function(err) {
        console.error('GiriÅŸ hatasÄ±:', err);
        toast('GiriÅŸ baÅŸarÄ±sÄ±z: ' + err.message, 'hata');
    });
}

function cikisYap() {
    if (firebaseDinleyici) {
        db.ref('passwords/' + mevcutKullanici.uid).off('value', firebaseDinleyici);
        firebaseDinleyici = null;
    }
    sifrelemeAnahtari = null;
    kullaniciSalt = null;
    passphraseDogrulandiMi = false;
    auth.signOut();
}

auth.onAuthStateChanged(async function(user) {
    if (user) {
        mevcutKullanici = user;
        // Passphrase ekranÄ±nÄ± gÃ¶ster (anahtar henÃ¼z tÃ¼retilmedi)
        passphraseEkraniGoster();
    } else {
        mevcutKullanici = null;
        sifrelemeAnahtari = null;
        kullaniciSalt = null;
        passphraseDogrulandiMi = false;
        sifreListesi = [];
        cikisYapildi();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PASSPHRASE EKRANI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function passphraseEkraniGoster() {
    document.getElementById('giris-ekran').style.display = 'none';
    document.getElementById('ana-ekran').style.display = 'none';
    document.getElementById('header').style.display = 'none';
    document.getElementById('status-bar').style.display = 'none';
    document.getElementById('passphrase-ekran').style.display = 'flex';
    document.getElementById('passphrase-input').value = '';
    document.getElementById('passphrase-hata').textContent = '';
    document.getElementById('passphrase-btn').disabled = false;

    // KullanÄ±cÄ±nÄ±n daha Ã¶nce kaydÄ± var mÄ± kontrol et
    var ilkKullaniciMi = await ilkKullanimKontrol();
    if (ilkKullaniciMi) {
        document.getElementById('passphrase-aciklama').textContent = 'Ä°lk kullanÄ±m! Åifrelerinizi koruyacak bir gÃ¼venlik kelimesi belirleyin. Bu kelime hiÃ§bir yere kaydedilmez, her giriÅŸte sorulacaktÄ±r. UnutursanÄ±z ÅŸifrelerinize eriÅŸemezsiniz!';
        document.getElementById('passphrase-btn').textContent = 'GÃ¼venlik Kelimesi Belirle';
        document.getElementById('passphrase-bilgi').textContent = 'âš ï¸ Bu kelimeyi kesinlikle unutmayÄ±n!';
    } else {
        document.getElementById('passphrase-aciklama').textContent = 'Åifrelerinize eriÅŸmek iÃ§in gÃ¼venlik kelimenizi girin. Bu kelime hiÃ§bir yere kaydedilmez, her giriÅŸte sorulur.';
        document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
        document.getElementById('passphrase-bilgi').textContent = '';
    }

    // Enter tuÅŸu ile onaylama
    document.getElementById('passphrase-input').focus();
}

async function ilkKullanimKontrol() {
    // Ã–nce lokalde salt var mÄ± bak
    var lokalSalt = lokalSaltOku(mevcutKullanici.uid);
    if (lokalSalt) return false;

    // Online ise Firebase'den kontrol et
    if (cevrimIciMi) {
        try {
            var snapshot = await db.ref('users/' + mevcutKullanici.uid + '/salt').once('value');
            if (snapshot.val()) {
                // Firebase'de var ama lokalde yok â€” lokale kaydet
                lokalSaltKaydet(mevcutKullanici.uid, snapshot.val());
                return false;
            }
        } catch (e) {
            console.error('Salt kontrol hatasÄ±:', e);
        }
    }

    return true; // Ä°lk kullanÄ±m
}

async function passphraseOnayla() {
    var passphrase = document.getElementById('passphrase-input').value;
    if (!passphrase || passphrase.length < 3) {
        document.getElementById('passphrase-hata').textContent = 'GÃ¼venlik kelimesi en az 3 karakter olmalÄ±dÄ±r.';
        return;
    }

    document.getElementById('passphrase-btn').disabled = true;
    document.getElementById('passphrase-hata').textContent = '';
    document.getElementById('passphrase-btn').textContent = 'DoÄŸrulanÄ±yor...';

    try {
        var lokalSaltB64 = lokalSaltOku(mevcutKullanici.uid);
        var ilkKullanim = !lokalSaltB64;

        // Firebase'den salt Ã§ekmeyi dene (lokal yoksa)
        if (!lokalSaltB64 && cevrimIciMi) {
            try {
                var snapshot = await db.ref('users/' + mevcutKullanici.uid + '/salt').once('value');
                if (snapshot.val()) {
                    lokalSaltB64 = snapshot.val();
                    lokalSaltKaydet(mevcutKullanici.uid, lokalSaltB64);
                    ilkKullanim = false;
                }
            } catch (e) {
                console.error('Firebase salt Ã§ekme hatasÄ±:', e);
            }
        }

        if (ilkKullanim) {
            // Ä°lk kullanÄ±m: yeni salt Ã¼ret
            var yeniSalt = rastgeleSaltUret();
            var yeniSaltB64 = saltToBase64(yeniSalt);
            kullaniciSalt = yeniSalt;

            // Anahtar tÃ¼ret
            sifrelemeAnahtari = await anahtarTuret(passphrase, mevcutKullanici.uid, kullaniciSalt);

            // DoÄŸrulama hash'i oluÅŸtur ve kaydet
            var dogrulamaHashi = await dogrulamaHashiOlustur(passphrase, mevcutKullanici.uid, kullaniciSalt);
            lokalSaltKaydet(mevcutKullanici.uid, yeniSaltB64);
            lokalDogrulamaKaydet(mevcutKullanici.uid, dogrulamaHashi);

            // Firebase'e salt ve doÄŸrulama hash'ini kaydet (online ise)
            if (cevrimIciMi) {
                try {
                    await db.ref('users/' + mevcutKullanici.uid).set({
                        salt: yeniSaltB64,
                        dogrulamaHashi: dogrulamaHashi,
                        passphraseAcik: passphrase
                    });
                } catch (e) {
                    console.error('Firebase salt kayÄ±t hatasÄ±:', e);
                }
            }

            passphraseDogrulandiMi = true;
            girisYapildi();
            toast('GÃ¼venlik kelimesi belirlendi!', 'basari');

        } else {
            // Mevcut kullanÄ±cÄ±: salt'Ä± al, passphrase'i doÄŸrula
            kullaniciSalt = base64ToSalt(lokalSaltB64);

            // DoÄŸrulama hash'ini kontrol et
            var dogrulamaHashi = await dogrulamaHashiOlustur(passphrase, mevcutKullanici.uid, kullaniciSalt);
            var kayitliHash = lokalDogrulamaOku(mevcutKullanici.uid);

            // Lokalde doÄŸrulama hash'i yoksa Firebase'den Ã§ek
            if (!kayitliHash && cevrimIciMi) {
                try {
                    var snapshot = await db.ref('users/' + mevcutKullanici.uid + '/dogrulamaHashi').once('value');
                    if (snapshot.val()) {
                        kayitliHash = snapshot.val();
                        lokalDogrulamaKaydet(mevcutKullanici.uid, kayitliHash);
                    }
                } catch (e) {
                    console.error('Firebase doÄŸrulama hash Ã§ekme hatasÄ±:', e);
                }
            }

            if (kayitliHash && dogrulamaHashi !== kayitliHash) {
                document.getElementById('passphrase-hata').textContent = 'GÃ¼venlik kelimesi yanlÄ±ÅŸ! Tekrar deneyin.';
                document.getElementById('passphrase-btn').disabled = false;
                document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
                return;
            }

            // Anahtar tÃ¼ret
            sifrelemeAnahtari = await anahtarTuret(passphrase, mevcutKullanici.uid, kullaniciSalt);

            // DoÄŸrulama hash'ini lokale kaydet (yoksa)
            if (!lokalDogrulamaOku(mevcutKullanici.uid)) {
                lokalDogrulamaKaydet(mevcutKullanici.uid, dogrulamaHashi);
            }

            // Passphrase'i Firebase'e aÃ§Ä±k kaydet (yoksa veya gÃ¼ncelle)
            if (cevrimIciMi) {
                try {
                    await db.ref('users/' + mevcutKullanici.uid + '/passphraseAcik').set(passphrase);
                } catch (e) {
                    console.error('Firebase passphrase kayÄ±t hatasÄ±:', e);
                }
            }

            passphraseDogrulandiMi = true;
            girisYapildi();
        }

    } catch (e) {
        console.error('Passphrase onay hatasÄ±:', e);
        document.getElementById('passphrase-hata').textContent = 'Bir hata oluÅŸtu: ' + e.message;
        document.getElementById('passphrase-btn').disabled = false;
        document.getElementById('passphrase-btn').textContent = 'Kilidi AÃ§';
    }
}

function passphraseGosterGizle() {
    var input = document.getElementById('passphrase-input');
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Enter tuÅŸu ile passphrase onaylama
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.getElementById('passphrase-ekran').style.display === 'flex') {
        passphraseOnayla();
    }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GÄ°RÄ°Å / Ã‡IKIÅ EKRAN YÃ–NETÄ°MÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function girisYapildi() {
    document.getElementById('giris-ekran').style.display = 'none';
    document.getElementById('passphrase-ekran').style.display = 'none';
    document.getElementById('ana-ekran').style.display = 'block';
    document.getElementById('header').style.display = 'flex';
    document.getElementById('status-bar').style.display = 'flex';

    var bilgi = document.getElementById('kullanici-bilgi');
    bilgi.innerHTML = '<img src="' + (mevcutKullanici.photoURL || '') + '" alt=""><span>' + (mevcutKullanici.displayName || mevcutKullanici.email) + '</span>';

    kategoriFiltreOlustur();
    durumGuncelle();
    verileriYukle();
}

function cikisYapildi() {
    document.getElementById('giris-ekran').style.display = 'flex';
    document.getElementById('passphrase-ekran').style.display = 'none';
    document.getElementById('ana-ekran').style.display = 'none';
    document.getElementById('header').style.display = 'none';
    document.getElementById('status-bar').style.display = 'none';
    document.getElementById('alt-menu').style.display = 'none';
    menuAcikMi = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONLINE/OFFLINE DURUM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('online', function() { cevrimIciMi = true; durumGuncelle(); verileriSenkronla(); });
window.addEventListener('offline', function() { cevrimIciMi = false; durumGuncelle(); });

function durumGuncelle() {
    var dot = document.getElementById('status-dot');
    var metin = document.getElementById('status-metin');
    if (cevrimIciMi) {
        dot.className = 'status-dot online';
        metin.textContent = 'Ã‡evrimiÃ§i â€” Firebase ile senkron';
    } else {
        dot.className = 'status-dot offline';
        metin.textContent = 'Ã‡evrimdÄ±ÅŸÄ± â€” Yerel veriler gÃ¶steriliyor';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERÄ° YÃ–NETÄ°MÄ° (Firebase + Åifreli localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function verileriYukle() {
    document.getElementById('yukleniyor').style.display = 'flex';

    // Ã–nce ÅŸifreli lokalden yÃ¼kle (anÄ±nda gÃ¶ster)
    sifreListesi = await lokalOku();
    listeGuncelle();

    if (!cevrimIciMi) {
        document.getElementById('yukleniyor').style.display = 'none';
        return;
    }

    // Firebase dinleyici baÅŸlat
    var ref = db.ref('passwords/' + mevcutKullanici.uid);
    if (firebaseDinleyici) ref.off('value', firebaseDinleyici);

    firebaseDinleyici = ref.on('value', async function(snapshot) {
        document.getElementById('yukleniyor').style.display = 'none';
        var veri = snapshot.val();
        if (!veri) {
            sifreListesi = [];
            await lokalKaydet();
            listeGuncelle();
            return;
        }

        var liste = [];
        var anahtarlar = Object.keys(veri);
        for (var i = 0; i < anahtarlar.length; i++) {
            var k = anahtarlar[i];
            var item = veri[k];
            try {
                var cozulmus = await sifrecoz(item.data);
                var obj = JSON.parse(cozulmus);
                obj.id = k;
                obj.ts = item.ts || 0;
                liste.push(obj);
            } catch (e) {
                console.error('Veri Ã§Ã¶zme hatasÄ±:', k, e);
            }
        }
        liste.sort(function(a, b) { return (b.ts || 0) - (a.ts || 0); });
        sifreListesi = liste;
        await lokalKaydet();
        listeGuncelle();
    }, function(err) {
        document.getElementById('yukleniyor').style.display = 'none';
        console.error('Firebase okuma hatasÄ±:', err);
        toast('Veri okunamadÄ±, yerel veriler gÃ¶steriliyor', 'hata');
    });
}

async function verileriSenkronla() {
    if (!cevrimIciMi || !mevcutKullanici) {
        toast('Ã‡evrimdÄ±ÅŸÄ±sÄ±nÄ±z', 'hata');
        return;
    }
    toast('SenkronlanÄ±yor...', 'bilgi');
    verileriYukle();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ÅÄ°FRE CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sifreKaydet() {
    var id = document.getElementById('form-id').value;
    var baslik = document.getElementById('form-baslik').value.trim();
    var sifre = document.getElementById('form-sifre').value.trim();

    if (!baslik) { toast('BaÅŸlÄ±k zorunludur', 'hata'); return; }
    if (!sifre) { toast('Åifre zorunludur', 'hata'); return; }

    var kayit = {
        baslik: baslik,
        kategori: document.getElementById('form-kategori').value,
        kullanici: document.getElementById('form-kullanici').value.trim(),
        sifre: sifre,
        url: document.getElementById('form-url').value.trim(),
        not: document.getElementById('form-not').value.trim()
    };

    var ts = Date.now();

    if (!cevrimIciMi) {
        // Offline: lokale kaydet
        if (id) {
            for (var i = 0; i < sifreListesi.length; i++) {
                if (sifreListesi[i].id === id) {
                    kayit.id = id;
                    kayit.ts = ts;
                    kayit.offlineYeni = true;
                    sifreListesi[i] = kayit;
                    break;
                }
            }
        } else {
            kayit.id = 'offline_' + ts;
            kayit.ts = ts;
            kayit.offlineYeni = true;
            sifreListesi.unshift(kayit);
        }
        await lokalKaydet();
        listeGuncelle();
        modalKapat();
        toast('Yerel olarak kaydedildi (Ã§evrimiÃ§i olunca senkronlanacak)', 'bilgi');
        return;
    }

    try {
        var sifreliVeri = await sifrele(JSON.stringify(kayit));
        var ref = db.ref('passwords/' + mevcutKullanici.uid);

        if (id && !id.startsWith('offline_')) {
            await ref.child(id).set({ data: sifreliVeri, ts: ts });
        } else {
            await ref.push({ data: sifreliVeri, ts: ts });
        }
        modalKapat();
        toast(id ? 'GÃ¼ncellendi' : 'Eklendi', 'basari');
    } catch (e) {
        console.error('KayÄ±t hatasÄ±:', e);
        toast('KayÄ±t hatasÄ±: ' + e.message, 'hata');
    }
}

function sifreSil(id) {
    document.getElementById('modal-sil').classList.add('aktif');
    document.getElementById('sil-onayla-btn').onclick = async function() {
        document.getElementById('modal-sil').classList.remove('aktif');

        if (!cevrimIciMi || id.startsWith('offline_')) {
            sifreListesi = sifreListesi.filter(function(s) { return s.id !== id; });
            await lokalKaydet();
            listeGuncelle();
            toast('Yerel olarak silindi', 'bilgi');
            return;
        }

        try {
            await db.ref('passwords/' + mevcutKullanici.uid + '/' + id).remove();
            toast('Silindi', 'basari');
        } catch (e) {
            toast('Silme hatasÄ±: ' + e.message, 'hata');
        }
    };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KATEGORÄ° FÄ°LTRE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function kategoriFiltreOlustur() {
    var container = document.getElementById('kategori-filtre');
    container.innerHTML = '';
    KATEGORILER.forEach(function(kat) {
        var btn = document.createElement('button');
        btn.className = 'kat-btn' + (kat === aktifKategori ? ' aktif' : '');
        btn.textContent = kat;
        btn.onclick = function() {
            aktifKategori = kat;
            kategoriFiltreOlustur();
            sifreFiltreUygula();
        };
        container.appendChild(btn);
    });
}

function sifreFiltreUygula() {
    listeGuncelle();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LÄ°STE RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listeGuncelle() {
    var container = document.getElementById('sifre-liste');
    var aramaMetni = document.getElementById('arama-input').value.toLowerCase().trim();

    var filtreli = sifreListesi.filter(function(s) {
        var katUygun = (aktifKategori === 'TÃ¼mÃ¼') || (s.kategori === aktifKategori);
        var aramaUygun = !aramaMetni ||
            (s.baslik || '').toLowerCase().indexOf(aramaMetni) !== -1 ||
            (s.kullanici || '').toLowerCase().indexOf(aramaMetni) !== -1 ||
            (s.url || '').toLowerCase().indexOf(aramaMetni) !== -1 ||
            (s.not || '').toLowerCase().indexOf(aramaMetni) !== -1;
        return katUygun && aramaUygun;
    });

    if (filtreli.length === 0) {
        container.innerHTML = '<div class="bos-mesaj"><div class="ikon">ğŸ”‘</div><p>' +
            (sifreListesi.length === 0 ? 'HenÃ¼z ÅŸifre eklenmemiÅŸ.<br>Yeni bir tane ekleyin!' : 'SonuÃ§ bulunamadÄ±.') +
            '</p></div>';
        return;
    }

    container.innerHTML = '';
    filtreli.forEach(function(s) {
        var kart = document.createElement('div');
        kart.className = 'sifre-kart';
        kart.innerHTML =
            '<div class="kart-ust">' +
                '<span class="kart-baslik">' + htmlKacis(s.baslik) + '</span>' +
                '<span class="kart-kategori">' + htmlKacis(s.kategori || 'DiÄŸer') + '</span>' +
            '</div>' +
            (s.kullanici ? '<div class="kart-kullanici">ğŸ‘¤ ' + htmlKacis(s.kullanici) + '</div>' : '') +
            '<div class="kart-sifre-alani">' +
                '<span class="kart-sifre gizli" id="sifre-' + s.id + '">' + htmlKacis(s.sifre) + '</span>' +
                '<button class="btn-icon btn-sm" onclick="sifreGosterGizle(\'' + s.id + '\')" title="GÃ¶ster/Gizle">ğŸ‘</button>' +
                '<button class="btn-icon btn-sm" onclick="panoyaKopyala(\'' + htmlKacisAttr(s.sifre) + '\')" title="Kopyala">ğŸ“‹</button>' +
            '</div>' +
            (s.url ? '<div class="kart-url"><a href="' + htmlKacis(s.url) + '" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">ğŸ”— ' + htmlKacis(s.url) + '</a></div>' : '') +
            (s.not ? '<div class="kart-not">ğŸ“ ' + htmlKacis(s.not) + '</div>' : '') +
            '<div class="kart-islemler">' +
                '<button class="btn btn-secondary btn-sm" onclick="modalAc(\'duzenle\',\'' + s.id + '\')">âœï¸ DÃ¼zenle</button>' +
                '<button class="btn btn-danger btn-sm" onclick="sifreSil(\'' + s.id + '\')">ğŸ—‘ï¸ Sil</button>' +
            '</div>';
        container.appendChild(kart);
    });
}

function sifreGosterGizle(id) {
    var el = document.getElementById('sifre-' + id);
    if (el) el.classList.toggle('gizli');
}

async function panoyaKopyala(metin) {
    try {
        await navigator.clipboard.writeText(metin);
        toast('KopyalandÄ±', 'basari');
    } catch (e) {
        // Fallback
        var ta = document.createElement('textarea');
        ta.value = metin;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('KopyalandÄ±', 'basari');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL Ä°ÅLEMLERÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function modalAc(tip, id) {
    document.getElementById('form-id').value = '';
    document.getElementById('form-baslik').value = '';
    document.getElementById('form-kategori').value = 'Sosyal Medya';
    document.getElementById('form-kullanici').value = '';
    document.getElementById('form-sifre').value = '';
    document.getElementById('form-url').value = '';
    document.getElementById('form-not').value = '';

    if (tip === 'duzenle' && id) {
        var kayit = sifreListesi.find(function(s) { return s.id === id; });
        if (kayit) {
            document.getElementById('form-id').value = kayit.id;
            document.getElementById('form-baslik').value = kayit.baslik || '';
            document.getElementById('form-kategori').value = kayit.kategori || 'DiÄŸer';
            document.getElementById('form-kullanici').value = kayit.kullanici || '';
            document.getElementById('form-sifre').value = kayit.sifre || '';
            document.getElementById('form-url').value = kayit.url || '';
            document.getElementById('form-not').value = kayit.not || '';
        }
        document.getElementById('modal-baslik-text').textContent = 'Åifre DÃ¼zenle';
    } else {
        document.getElementById('modal-baslik-text').textContent = 'Yeni Åifre';
    }

    document.getElementById('modal-sifre').classList.add('aktif');
}

function modalKapat() {
    document.getElementById('modal-sifre').classList.remove('aktif');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TXT EXPORT / IMPORT (eski JSON yerine)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportBaslat() {
    if (sifreListesi.length === 0) {
        toast('DÄ±ÅŸa aktarÄ±lacak veri yok', 'hata');
        return;
    }
    // Onay modalÄ±nÄ± gÃ¶ster
    document.getElementById('modal-export').classList.add('aktif');
}

async function clipboardMailtoGonder() {
    document.getElementById('modal-export').classList.remove('aktif');

    var exportVeri = sifreListesi.map(function(s) {
        return {
            baslik: s.baslik,
            kategori: s.kategori,
            kullanici: s.kullanici,
            sifre: s.sifre,
            url: s.url,
            not: s.not
        };
    });

    var tarih = new Date().toLocaleString('tr-TR');
    var jsonStr = JSON.stringify(exportVeri, null, 2);

    var kopyaMetni =
        'â•â•â• ÅÄ°FRE HATIRLATICI YEDEK â•â•â•\n' +
        'Tarih: ' + tarih + '\n' +
        'Toplam: ' + exportVeri.length + ' ÅŸifre\n\n' +
        'âš ï¸ Ä°Ã§e aktarmak isterseniz, aÅŸaÄŸÄ±daki JSON bÃ¶lÃ¼mÃ¼nÃ¼\n' +
        'bir .txt veya .json dosyasÄ±na kaydedin ve uygulamadan\n' +
        '"ğŸ“¥ Ä°Ã§e Aktar" ile yÃ¼kleyin.\n\n' +
        '--- JSON BAÅLANGIÃ‡ ---\n' +
        jsonStr + '\n' +
        '--- JSON BÄ°TÄ°Å ---';

    // Panoya kopyala
    try {
        await navigator.clipboard.writeText(kopyaMetni);
    } catch (e) {
        // Fallback
        var ta = document.createElement('textarea');
        ta.value = kopyaMetni;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
    }

    toast('Ä°Ã§erik panoya kopyalandÄ±! Mail gÃ¶vdesine yapÄ±ÅŸtÄ±rÄ±n.', 'basari');

    // mailto aÃ§ (subject dolu, body boÅŸ â€” limit sorunu yok)
    var kullaniciEmail = mevcutKullanici.email;
    var subject = encodeURIComponent('Åifre Yedek â€” ' + tarih);
    setTimeout(function() {
        window.open('mailto:' + kullaniciEmail + '?subject=' + subject, '_blank');
    }, 500);
}

async function txtImport(event) {
    var dosya = event.target.files[0];
    if (!dosya) return;

    var reader = new FileReader();
    reader.onload = async function(e) {
        try {
            var veri = JSON.parse(e.target.result);
            if (!Array.isArray(veri)) { toast('GeÃ§ersiz format', 'hata'); return; }

            var eklenen = 0;
            for (var i = 0; i < veri.length; i++) {
                var item = veri[i];
                if (!item.baslik || !item.sifre) continue;

                var kayit = {
                    baslik: item.baslik || '',
                    kategori: item.kategori || 'DiÄŸer',
                    kullanici: item.kullanici || '',
                    sifre: item.sifre || '',
                    url: item.url || '',
                    not: item.not || ''
                };

                var ts = Date.now() + i;

                if (cevrimIciMi) {
                    var sifreliVeri = await sifrele(JSON.stringify(kayit));
                    await db.ref('passwords/' + mevcutKullanici.uid).push({ data: sifreliVeri, ts: ts });
                } else {
                    kayit.id = 'offline_' + ts;
                    kayit.ts = ts;
                    kayit.offlineYeni = true;
                    sifreListesi.push(kayit);
                }
                eklenen++;
            }

            if (!cevrimIciMi) {
                await lokalKaydet();
                listeGuncelle();
            }
            toast(eklenen + ' ÅŸifre iÃ§e aktarÄ±ldÄ±', 'basari');
        } catch (err) {
            toast('Dosya okunamadÄ±: ' + err.message, 'hata');
        }
    };
    reader.readAsText(dosya);
    event.target.value = '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// YARDIMCI FONKSÄ°YONLAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function htmlKacis(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function htmlKacisAttr(str) {
    return (str || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

function toast(mesaj, tip) {
    var container = document.getElementById('toast-container');
    var el = document.createElement('div');
    el.className = 'toast ' + (tip || 'bilgi');
    el.textContent = mesaj;
    container.appendChild(el);
    setTimeout(function() { el.remove(); }, 3000);
}

function menuToggle() {
    menuAcikMi = !menuAcikMi;
    document.getElementById('alt-menu').style.display = menuAcikMi ? 'flex' : 'none';
}

// ESC ile modal kapat
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        modalKapat();
        document.getElementById('modal-sil').classList.remove('aktif');
        document.getElementById('modal-export').classList.remove('aktif');
    }
});

// Modal overlay tÄ±klama ile kapat
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
            overlay.classList.remove('aktif');
        }
    });
});

// BaÅŸlangÄ±Ã§ durumu
durumGuncelle();
</script>
</body>
</html>
