<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chrome Yer ƒ∞mi Sƒ±klƒ±k Analizi</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700;800&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --surface3: #1e1e2e;
    --border: #2a2a3a;
    --border-active: #4a6cf7;
    --text: #e8e8f0;
    --text-dim: #8888a0;
    --accent: #4a6cf7;
    --accent-glow: rgba(74,108,247,0.25);
    --success: #34d399;
    --warn: #fbbf24;
    --danger: #f87171;
    --gold: #f59e0b;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 40px 24px 80px;
    position: relative;
    z-index: 1;
  }

  .header {
    text-align: center;
    margin-bottom: 48px;
  }
  .header-icon {
    font-size: 48px;
    margin-bottom: 12px;
    display: block;
    filter: drop-shadow(0 0 24px var(--accent-glow));
  }
  .header h1 {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 0%, #4a6cf7 50%, #34d399 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .header p {
    color: var(--text-dim);
    font-size: 14px;
    margin-top: 8px;
    font-weight: 300;
  }

  .step {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 20px;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .step.active {
    border-color: var(--border-active);
    box-shadow: 0 0 40px var(--accent-glow), inset 0 1px 0 rgba(74,108,247,0.1);
  }
  .step.done {
    border-color: var(--success);
    box-shadow: 0 0 20px rgba(52,211,153,0.1);
  }
  .step.locked {
    opacity: 0.45;
    pointer-events: none;
    filter: grayscale(0.3);
  }

  .step-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--accent);
    margin-bottom: 14px;
  }
  .step.done .step-badge { color: var(--success); }
  .step-badge .num {
    width: 24px; height: 24px;
    border-radius: 50%;
    background: var(--accent);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 800;
  }
  .step.done .step-badge .num { background: var(--success); }

  .step h2 { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .step .desc { font-size: 13px; color: var(--text-dim); margin-bottom: 18px; line-height: 1.6; }

  .info-box {
    background: rgba(251,191,36,0.06);
    border: 1px solid rgba(251,191,36,0.2);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 16px;
    font-size: 12.5px;
    line-height: 1.7;
    color: #e8d5a0;
  }
  .info-box strong { color: var(--warn); font-weight: 600; }
  .info-box code {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    background: rgba(255,255,255,0.06);
    padding: 2px 6px;
    border-radius: 4px;
    color: #fbbf24;
  }
  .info-box .steps-list {
    margin-top: 8px;
    padding-left: 0;
    list-style: none;
    counter-reset: infoStep;
  }
  .info-box .steps-list li { counter-increment: infoStep; margin-bottom: 4px; }
  .info-box .steps-list li::before { content: counter(infoStep) "."; font-weight: 700; color: var(--warn); margin-right: 6px; }

  .path-row { display: flex; align-items: center; gap: 8px; margin-bottom: 14px; }
  .path-display {
    flex: 1;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--accent);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    user-select: all;
  }
  .copy-btn {
    flex-shrink: 0;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    font-family: 'Outfit', sans-serif;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .copy-btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
  .copy-btn.copied { background: var(--success); }

  .profile-select {
    width: 100%;
    font-family: 'Outfit', sans-serif;
    font-size: 14px;
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    appearance: none;
    cursor: pointer;
    margin-bottom: 14px;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238888a0' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
  }
  .profile-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }

  .file-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .file-btn-wrap { position: relative; }
  .file-btn {
    width: 100%;
    background: var(--surface2);
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 20px 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  .file-btn:hover { border-color: var(--accent); background: rgba(74,108,247,0.04); transform: translateY(-2px); }
  .file-btn.loaded { border-style: solid; border-color: var(--success); background: rgba(52,211,153,0.04); }
  .file-btn .icon { font-size: 28px; }
  .file-btn .label { font-size: 13px; font-weight: 600; }
  .file-btn .sublabel { font-size: 11px; color: var(--text-dim); }

  .analyze-btn {
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: 12px;
    font-family: 'Outfit', sans-serif;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 16px;
    background: linear-gradient(135deg, var(--accent), #34d399);
    color: #fff;
    transition: all 0.3s;
    letter-spacing: 0.5px;
  }
  .analyze-btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 8px 30px var(--accent-glow); }
  .analyze-btn:disabled { opacity: 0.35; cursor: not-allowed; filter: none; transform: none; box-shadow: none; }

  #results { margin-top: 24px; }
  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .results-header h2 { font-size: 20px; font-weight: 700; }
  .results-stats { display: flex; gap: 16px; font-size: 12px; color: var(--text-dim); }
  .results-stats span { display: flex; align-items: center; gap: 4px; }
  .results-stats .val { color: var(--text); font-weight: 700; font-size: 14px; }

  .filter-row { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .search-input {
    flex: 1;
    min-width: 200px;
    font-family: 'Outfit', sans-serif;
    font-size: 13px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 8px;
    padding: 10px 14px;
  }
  .search-input:focus { outline: none; border-color: var(--accent); }
  .filter-btn {
    font-family: 'Outfit', sans-serif;
    font-size: 12px;
    font-weight: 600;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
    border-radius: 8px;
    padding: 8px 16px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn:hover, .filter-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(74,108,247,0.06); }

  /* ===== DOMAIN ACCORDION ===== */
  .domain-list { display: flex; flex-direction: column; gap: 6px; }

  .domain-group {
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: border-color 0.2s;
  }
  .domain-group.open { border-color: var(--accent); }

  .domain-header {
    display: grid;
    grid-template-columns: 48px 1fr auto auto;
    gap: 14px;
    align-items: center;
    background: var(--surface);
    padding: 14px 16px;
    cursor: pointer;
    transition: background 0.2s;
    user-select: none;
  }
  .domain-header:hover { background: var(--surface2); }
  .domain-group.open .domain-header { background: var(--surface2); border-bottom: 1px solid var(--border); }

  .domain-rank {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 800;
    text-align: center;
    color: var(--text-dim);
  }
  .domain-group:nth-child(1) .domain-rank { color: #fbbf24; font-size: 20px; }
  .domain-group:nth-child(2) .domain-rank { color: #cbd5e1; font-size: 18px; }
  .domain-group:nth-child(3) .domain-rank { color: #d97706; font-size: 18px; }

  .domain-info { overflow: hidden; }
  .domain-name { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .domain-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .domain-meta .bm-count-label { color: var(--accent); font-weight: 600; }

  .domain-visits {
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--success);
    background: rgba(52,211,153,0.08);
    padding: 6px 12px;
    border-radius: 8px;
    white-space: nowrap;
  }
  .domain-visits.zero { color: var(--text-dim); background: rgba(136,136,160,0.06); }

  .domain-chevron {
    font-size: 14px;
    color: var(--text-dim);
    transition: transform 0.25s;
    width: 20px;
    text-align: center;
  }
  .domain-group.open .domain-chevron { transform: rotate(90deg); color: var(--accent); }

  .domain-body { display: none; background: var(--bg); }
  .domain-group.open .domain-body { display: block; }

  .path-item {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
    padding: 10px 16px 10px 78px;
    border-bottom: 1px solid rgba(42,42,58,0.5);
    transition: background 0.15s;
    text-decoration: none;
    color: inherit;
  }
  .path-item:last-child { border-bottom: none; }
  .path-item:hover { background: rgba(74,108,247,0.04); }

  .path-info { overflow: hidden; }
  .path-title { font-size: 12.5px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
  .path-url {
    font-size: 10.5px;
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .path-folders { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 3px; }
  .path-folder-tag {
    font-size: 9.5px;
    color: var(--accent);
    background: rgba(74,108,247,0.08);
    padding: 2px 7px;
    border-radius: 4px;
    white-space: nowrap;
    max-width: 220px;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .path-visits {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    color: var(--success);
    white-space: nowrap;
    flex-shrink: 0;
  }
  .path-visits.zero { color: var(--text-dim); }

  .no-match { text-align: center; padding: 40px; color: var(--text-dim); font-size: 14px; }

  .loading-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(10,10,15,0.85);
    z-index: 999;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 16px;
  }
  .loading-overlay.show { display: flex; }
  .spinner {
    width: 40px; height: 40px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 14px; color: var(--text-dim); }

  @media (max-width: 600px) {
    .file-buttons { grid-template-columns: 1fr; }
    .domain-header { grid-template-columns: 36px 1fr auto auto; gap: 10px; padding: 10px 12px; }
    .path-item { padding-left: 52px; }
    .container { padding: 24px 16px 60px; }
  }

  .fade-in { animation: fadeIn 0.4s ease both; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Analiz ediliyor...</div>
</div>

<div class="container">

  <div class="header fade-in">
    <span class="header-icon">üîñ</span>
    <h1>Chrome Yer ƒ∞mi Sƒ±klƒ±k Analizi</h1>
    <p>Yer imlerinizi domain bazlƒ± grupla, ziyaret sƒ±klƒ±ƒüƒ±na g√∂re sƒ±rala</p>
  </div>

  <!-- STEP 1 -->
  <div class="step active fade-in" id="step1">
    <div class="step-badge"><span class="num">1</span> PROFƒ∞L ALGILAMA</div>
    <h2>Local State Dosyasƒ±nƒ± Se√ßin</h2>
    <p class="desc">Bu dosya t√ºm Chrome profillerinizin listesini i√ßerir.</p>
    <div class="info-box">
      <span class="emoji">‚ö†Ô∏è</span> <strong>Dosya Se√ßici A√ßƒ±ldƒ±ƒüƒ±nda:</strong>
      <ol class="steps-list">
        <li>A≈üaƒüƒ±daki yolu <strong>üìã Kopyala</strong> butonuyla kopyalayƒ±n</li>
        <li>Dosya se√ßicinin <strong>adres √ßubuƒüuna</strong> tƒ±klayƒ±n (<code>Alt+D</code>)</li>
        <li>Yapƒ±≈ütƒ±rƒ±n (<code>Ctrl+V</code>) ve <strong>Enter</strong>'a basƒ±n</li>
        <li><code>Local State</code> dosyasƒ±nƒ± se√ßin</li>
      </ol>
    </div>
    <div class="path-row">
      <div class="path-display" id="localStatePath">%LOCALAPPDATA%\Google\Chrome\User Data</div>
      <button class="copy-btn" onclick="copyPath('localStatePath', this)">üìã Kopyala</button>
    </div>
    <div class="file-btn-wrap">
      <div class="file-btn" id="localStateBtn" onclick="document.getElementById('localStateInput').click()">
        <span class="icon">üìÇ</span>
        <span class="label">Local State Dosyasƒ±nƒ± Se√ß</span>
        <span class="sublabel">User Data klas√∂r√ºndeki "Local State" dosyasƒ±</span>
      </div>
      <input type="file" id="localStateInput" accept="*" style="display:none" onchange="handleLocalState(this)">
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="step locked" id="step2">
    <div class="step-badge"><span class="num">2</span> PROFƒ∞L SE√áƒ∞Mƒ∞</div>
    <h2>Chrome Profilinizi Se√ßin</h2>
    <p class="desc">Algƒ±lanan profillerden aktif kullandƒ±ƒüƒ±nƒ±zƒ± se√ßin.</p>
    <select class="profile-select" id="profileSelect" onchange="onProfileChange()">
      <option disabled selected>‚Äî Profil se√ßin ‚Äî</option>
    </select>
    <div id="profilePathSection" style="display:none">
      <div class="info-box">
        <span class="emoji">üìÅ</span> Dosya se√ßici a√ßƒ±ldƒ±ƒüƒ±nda bu yolu adres √ßubuƒüuna yapƒ±≈ütƒ±rƒ±n.
      </div>
      <div class="path-row">
        <div class="path-display" id="profilePath"></div>
        <button class="copy-btn" onclick="copyPath('profilePath', this)">üìã Kopyala</button>
      </div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="step locked" id="step3">
    <div class="step-badge"><span class="num">3</span> DOSYA SE√áƒ∞Mƒ∞ & ANALƒ∞Z</div>
    <h2>Bookmarks ve History Dosyalarƒ±nƒ± Se√ßin</h2>
    <p class="desc">Her iki dosya da se√ßilen profil klas√∂r√ºndedir.</p>
    <div class="info-box">
      <span class="emoji">üí°</span> Chrome a√ßƒ±kken okunabilir. Son birka√ß dakikalƒ±k ziyaretler eksik kalabilir ‚Äî normal.
    </div>
    <div class="file-buttons">
      <div class="file-btn-wrap">
        <div class="file-btn" id="bookmarksBtn" onclick="document.getElementById('bookmarksInput').click()">
          <span class="icon">üîñ</span>
          <span class="label">Bookmarks</span>
          <span class="sublabel">Yer imleri (JSON)</span>
        </div>
        <input type="file" id="bookmarksInput" accept="*" style="display:none" onchange="handleBookmarks(this)">
      </div>
      <div class="file-btn-wrap">
        <div class="file-btn" id="historyBtn" onclick="document.getElementById('historyInput').click()">
          <span class="icon">üìä</span>
          <span class="label">History</span>
          <span class="sublabel">Ge√ßmi≈ü (SQLite)</span>
        </div>
        <input type="file" id="historyInput" accept="*" style="display:none" onchange="handleHistory(this)">
      </div>
    </div>
    <button class="analyze-btn" id="analyzeBtn" disabled onclick="analyze()">
      üîç Analiz Et ‚Äî Domain Bazlƒ± Sƒ±rala
    </button>
  </div>

  <div id="results"></div>
</div>

<script>
// ====== STATE ======
let profilesData = {};
let selectedProfileDir = '';
let bookmarksJSON = null;
let historyBuffer = null;
let domainGroups = [];

// ====== CLIPBOARD ======
async function copyPath(elementId, btn) {
  const text = document.getElementById(elementId).textContent;
  try { await navigator.clipboard.writeText(text); } catch {
    const ta = document.createElement('textarea');
    ta.value = text; ta.style.cssText = 'position:fixed;left:-9999px';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  }
  btn.classList.add('copied'); btn.innerHTML = '‚úÖ Kopyalandƒ±!';
  setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = 'üìã Kopyala'; }, 2000);
}

// ====== STEP 1 ======
function handleLocalState(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      const cache = data?.profile?.info_cache;
      if (!cache || Object.keys(cache).length === 0) { alert('Profil bilgisi bulunamadƒ±.'); return; }
      profilesData = cache;
      const select = document.getElementById('profileSelect');
      select.innerHTML = '<option disabled selected>‚Äî Profil se√ßin ‚Äî</option>';
      Object.entries(cache).forEach(([dir, info]) => {
        const name = info.name || info.gaia_name || dir;
        const email = info.user_name || info.gaia_name || '';
        const label = email ? `${name} (${email}) ‚Äî [${dir}]` : `${name} ‚Äî [${dir}]`;
        const opt = document.createElement('option');
        opt.value = dir; opt.textContent = label; select.appendChild(opt);
      });
      if (Object.keys(cache).length === 1) { select.selectedIndex = 1; onProfileChange(); }
      document.getElementById('localStateBtn').classList.add('loaded');
      document.getElementById('localStateBtn').querySelector('.label').textContent = '‚úÖ Local State Y√ºklendi';
      document.getElementById('step1').className = 'step done fade-in';
      document.getElementById('step2').className = 'step active';
    } catch (err) { alert('Dosya okunamadƒ±: ' + err.message); }
  };
  reader.readAsText(file, 'utf-8');
}

// ====== STEP 2 ======
function onProfileChange() {
  const dir = document.getElementById('profileSelect').value;
  if (!dir) return;
  selectedProfileDir = dir;
  document.getElementById('profilePath').textContent = `%LOCALAPPDATA%\\Google\\Chrome\\User Data\\${dir}`;
  document.getElementById('profilePathSection').style.display = 'block';
  document.getElementById('step2').className = 'step done';
  document.getElementById('step3').className = 'step active';
  bookmarksJSON = null; historyBuffer = null;
  document.getElementById('bookmarksBtn').classList.remove('loaded');
  document.getElementById('bookmarksBtn').querySelector('.label').textContent = 'Bookmarks';
  document.getElementById('historyBtn').classList.remove('loaded');
  document.getElementById('historyBtn').querySelector('.label').textContent = 'History';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('results').innerHTML = '';
}

// ====== STEP 3 ======
function handleBookmarks(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      bookmarksJSON = JSON.parse(e.target.result);
      if (!bookmarksJSON.roots) { alert('Ge√ßerli Bookmarks dosyasƒ± deƒüil.'); bookmarksJSON = null; return; }
      document.getElementById('bookmarksBtn').classList.add('loaded');
      document.getElementById('bookmarksBtn').querySelector('.label').textContent = '‚úÖ Bookmarks Y√ºklendi';
      checkReady();
    } catch (err) { alert('Okunamadƒ±: ' + err.message); }
  };
  reader.readAsText(file, 'utf-8');
}

function handleHistory(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    historyBuffer = new Uint8Array(e.target.result);
    if (!String.fromCharCode(...historyBuffer.slice(0, 15)).startsWith('SQLite format')) {
      alert('Ge√ßerli History dosyasƒ± deƒüil.'); historyBuffer = null; return;
    }
    document.getElementById('historyBtn').classList.add('loaded');
    document.getElementById('historyBtn').querySelector('.label').textContent = '‚úÖ History Y√ºklendi';
    checkReady();
  };
  reader.readAsArrayBuffer(file);
}

function checkReady() {
  document.getElementById('analyzeBtn').disabled = !(bookmarksJSON && historyBuffer);
}

// ====== HELPERS ======
function getDomain(url) {
  try { return new URL(url).hostname.replace(/^www\./, ''); } catch { return null; }
}

function getPathDisplay(url) {
  try {
    const u = new URL(url);
    const p = u.pathname + u.search + u.hash;
    return p === '/' ? '/' : p;
  } catch { return url; }
}

function extractBookmarksRaw(node, folder) {
  const items = [];
  if (node.type === 'url') {
    items.push({ title: node.name || '(ƒ∞simsiz)', url: node.url, folder: folder });
  }
  if (node.children) {
    const cur = folder ? `${folder} ‚Ä∫ ${node.name}` : (node.name || '');
    node.children.forEach(child => items.push(...extractBookmarksRaw(child, cur)));
  }
  return items;
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ====== ANALYSIS ======
async function analyze() {
  const overlay = document.getElementById('loadingOverlay');
  const lt = document.getElementById('loadingText');
  overlay.classList.add('show');

  try {
    lt.textContent = 'sql.js y√ºkleniyor...';
    const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${f}` });

    lt.textContent = 'History okunuyor...';
    const db = new SQL.Database(historyBuffer);

    lt.textContent = 'Ziyaret sayƒ±larƒ± √ßƒ±karƒ±lƒ±yor...';
    const visitMap = {};
    try {
      const stmt = db.exec("SELECT url, visit_count, title FROM urls");
      if (stmt.length > 0) {
        stmt[0].values.forEach(r => { visitMap[r[0]] = { count: r[1] || 0, title: r[2] || '' }; });
      }
    } catch (e) { console.warn('SQL hatasƒ±:', e); }
    db.close();

    lt.textContent = 'Yer imleri i≈üleniyor...';
    const rawBm = [];
    Object.values(bookmarksJSON.roots).forEach(root => {
      if (root && typeof root === 'object') rawBm.push(...extractBookmarksRaw(root, ''));
    });

    // Deduplicate: aynƒ± URL ‚Üí tek kayƒ±t, klas√∂rler birle≈ü
    lt.textContent = 'URL deduplication...';
    const urlMap = {};
    rawBm.forEach(bm => {
      if (!bm.url || !bm.url.startsWith('http')) return;
      if (!urlMap[bm.url]) {
        const v = visitMap[bm.url];
        urlMap[bm.url] = { title: bm.title, url: bm.url, folders: new Set(), visitCount: v ? v.count : 0 };
      }
      if (bm.folder) urlMap[bm.url].folders.add(bm.folder);
    });

    // Domain gruplama
    lt.textContent = 'Domain gruplama...';
    const dMap = {};
    Object.values(urlMap).forEach(item => {
      const d = getDomain(item.url);
      if (!d) return;
      if (!dMap[d]) dMap[d] = [];
      dMap[d].push({ url: item.url, title: item.title, visitCount: item.visitCount, folders: [...item.folders] });
    });

    domainGroups = Object.entries(dMap).map(([domain, paths]) => {
      paths.sort((a, b) => b.visitCount - a.visitCount);
      return { domain, totalVisits: paths.reduce((s, p) => s + p.visitCount, 0), uniqueUrls: paths.length, paths };
    });
    domainGroups.sort((a, b) => b.totalVisits - a.totalVisits);

    overlay.classList.remove('show');
    renderResults();
  } catch (err) {
    overlay.classList.remove('show');
    alert('Hata: ' + err.message);
    console.error(err);
  }
}

// ====== RENDER ======
let currentFilter = 'all';

function renderResults() {
  const c = document.getElementById('results');
  const td = domainGroups.length;
  const tu = domainGroups.reduce((s, g) => s + g.uniqueUrls, 0);
  const tv = domainGroups.reduce((s, g) => s + g.totalVisits, 0);

  c.innerHTML = `
    <div class="results-header fade-in">
      <h2>üìä Sonu√ßlar</h2>
      <div class="results-stats">
        <span>Domain: <span class="val">${td}</span></span>
        <span>Benzersiz URL: <span class="val">${tu}</span></span>
        <span>Toplam ziyaret: <span class="val">${tv.toLocaleString('tr-TR')}</span></span>
      </div>
    </div>
    <div class="filter-row fade-in">
      <input type="text" class="search-input" id="searchInput" placeholder="üîç Domain veya URL ara..." oninput="filterResults()">
      <button class="filter-btn active" onclick="setFilter('all', this)">T√ºm√º</button>
      <button class="filter-btn" onclick="setFilter('visited', this)">Ziyaret Edilenler</button>
      <button class="filter-btn" onclick="setFilter('unvisited', this)">Ziyaret Edilmeyenler</button>
    </div>
    <div class="domain-list" id="domainList"></div>
  `;
  currentFilter = 'all';
  filterResults();
}

function setFilter(type, btn) {
  currentFilter = type;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  filterResults();
}

function filterResults() {
  const q = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
  let filtered = domainGroups;

  if (currentFilter === 'visited') filtered = filtered.filter(g => g.totalVisits > 0);
  if (currentFilter === 'unvisited') filtered = filtered.filter(g => g.totalVisits === 0);

  if (q) {
    filtered = filtered.filter(g =>
      g.domain.toLowerCase().includes(q) ||
      g.paths.some(p =>
        (p.title || '').toLowerCase().includes(q) ||
        (p.url || '').toLowerCase().includes(q) ||
        p.folders.some(f => f.toLowerCase().includes(q))
      )
    );
  }

  const list = document.getElementById('domainList');
  if (!list) return;

  if (filtered.length === 0) {
    list.innerHTML = '<div class="no-match">E≈üle≈üen domain bulunamadƒ±.</div>';
    return;
  }

  const toRender = filtered.slice(0, 200);
  list.innerHTML = toRender.map((g, i) => {
    const vc = g.totalVisits === 0 ? 'zero' : '';
    const vt = g.totalVisits > 0 ? `${g.totalVisits.toLocaleString('tr-TR')} ziyaret` : 'Yok';
    const ul = g.uniqueUrls === 1 ? '1 yer imi' : `${g.uniqueUrls} yer imi`;

    const ph = g.paths.map(p => {
      const ps = getPathDisplay(p.url);
      const pvc = p.visitCount === 0 ? 'zero' : '';
      const pvt = p.visitCount > 0 ? p.visitCount.toLocaleString('tr-TR') : '0';
      const fh = p.folders.length > 0
        ? `<div class="path-folders">${p.folders.map(f => `<span class="path-folder-tag" title="${escapeHtml(f)}">üìÅ ${escapeHtml(f)}</span>`).join('')}</div>`
        : '';
      return `<a class="path-item" href="${escapeHtml(p.url)}" target="_blank" rel="noopener" title="${escapeHtml(p.url)}">
        <div class="path-info">
          <div class="path-title">${escapeHtml(p.title)}</div>
          <div class="path-url">${escapeHtml(ps)}</div>
          ${fh}
        </div>
        <div class="path-visits ${pvc}">${pvt}</div>
      </a>`;
    }).join('');

    return `<div class="domain-group" data-domain="${escapeHtml(g.domain)}">
      <div class="domain-header" onclick="toggleDomain(this)">
        <div class="domain-rank">#${i + 1}</div>
        <div class="domain-info">
          <div class="domain-name">${escapeHtml(g.domain)}</div>
          <div class="domain-meta"><span class="bm-count-label">${ul}</span></div>
        </div>
        <div class="domain-visits ${vc}">${vt}</div>
        <div class="domain-chevron">‚ñ∂</div>
      </div>
      <div class="domain-body">${ph}</div>
    </div>`;
  }).join('');

  if (filtered.length > 200) {
    list.innerHTML += `<div class="no-match">... ve ${filtered.length - 200} domain daha</div>`;
  }
}

function toggleDomain(el) {
  el.closest('.domain-group').classList.toggle('open');
}
</script>
</body>
</html>