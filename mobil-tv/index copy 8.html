<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TV Kontrol</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5f4f0;
    --bg2: #eceae4;
    --surface: #ffffff;
    --border: #dddbd4;
    --text: #1a1917;
    --text2: #6b6860;
    --text3: #9b9890;
    --accent: #2d6a4f;
    --accent-light: #d8f3dc;
    --danger: #c0392b;
    --danger-light: #fdecea;
    --online: #27ae60;
    --shadow: 0 1px 3px rgba(0,0,0,.08), 0 4px 12px rgba(0,0,0,.06);
    --shadow-lg: 0 8px 32px rgba(0,0,0,.12);
    --radius: 12px;
    --font: 'DM Sans', sans-serif;
    --mono: 'DM Mono', monospace;
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #111110;
      --bg2: #1a1917;
      --surface: #222220;
      --border: #2e2d2a;
      --text: #f0efe9;
      --text2: #9b9890;
      --text3: #5a5955;
      --accent: #52b788;
      --accent-light: #1a3a2a;
      --danger: #e74c3c;
      --danger-light: #2a1510;
      --shadow: 0 1px 3px rgba(0,0,0,.3), 0 4px 12px rgba(0,0,0,.2);
      --shadow-lg: 0 8px 32px rgba(0,0,0,.4);
    }
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html, body {
    height: 100%;
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    font-size: 16px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
  }

  /* ‚îÄ‚îÄ LAYOUT SCREENS ‚îÄ‚îÄ */
  .screen { display: none; height: 100vh; overflow: hidden; }
  .screen.active { display: flex; }

  /* ‚îÄ‚îÄ GIRI≈û EKRANI ‚îÄ‚îÄ */
  #screen-login {
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: var(--bg);
  }
  .login-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: var(--shadow-lg);
  }
  .login-logo {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: .12em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 28px;
  }
  .login-logo span { color: var(--text3); font-weight: 400; }
  .login-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 6px;
  }
  .login-sub {
    font-size: 14px;
    color: var(--text2);
    margin-bottom: 32px;
  }
  .form-group { margin-bottom: 16px; }
  .form-label {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: var(--text2);
    margin-bottom: 6px;
  }
  .form-input {
    width: 100%;
    padding: 11px 14px;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: var(--font);
    font-size: 15px;
    color: var(--text);
    outline: none;
    transition: border-color .15s;
  }
  .form-input:focus { border-color: var(--accent); }
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 11px 20px;
    border: none;
    border-radius: 8px;
    font-family: var(--font);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: opacity .15s, transform .1s;
    text-decoration: none;
  }
  .btn:active { transform: scale(.98); }
  .btn-primary {
    background: var(--accent);
    color: #fff;
    width: 100%;
    margin-top: 8px;
    padding: 13px;
  }
  .btn-primary:hover { opacity: .88; }
  .btn-primary:disabled { opacity: .5; cursor: not-allowed; }
  .btn-ghost {
    background: transparent;
    color: var(--text2);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { background: var(--bg2); }
  .btn-danger {
    background: var(--danger-light);
    color: var(--danger);
    border: 1px solid transparent;
  }
  .btn-danger:hover { opacity: .85; }
  .btn-sm { font-size: 13px; padding: 7px 14px; border-radius: 6px; }

  .error-msg {
    background: var(--danger-light);
    color: var(--danger);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 13px;
    margin-top: 12px;
    display: none;
  }
  .error-msg.show { display: block; }

  /* ‚îÄ‚îÄ ROL TESPIT BANNER ‚îÄ‚îÄ */
  #screen-role-confirm {
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .role-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 420px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }
  .role-icon {
    font-size: 52px;
    margin-bottom: 20px;
    display: block;
  }
  .role-card h2 { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
  .role-card p { font-size: 14px; color: var(--text2); margin-bottom: 28px; }
  .role-btns { display: flex; gap: 10px; }
  .role-btns .btn { flex: 1; }

  /* ‚îÄ‚îÄ TV EKRANI ‚îÄ‚îÄ */
  #screen-tv {
    flex-direction: column;
    background: var(--bg);
  }
  .tv-topbar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 0 20px;
    height: 52px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    z-index: 10;
  }
  .tv-url {
    flex: 1;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: var(--bg2);
    padding: 5px 10px;
    border-radius: 6px;
    min-width: 0;
  }
  .tv-devices {
    font-size: 12px;
    color: var(--text2);
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .dot-online {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--online);
    display: inline-block;
    flex-shrink: 0;
  }
  .tv-topbar .btn-ghost { flex-shrink: 0; font-size: 13px; padding: 5px 12px; }
  .tv-content {
    flex: 1;
    position: relative;
    overflow: hidden;
  }
  .tv-iframe {
    width: 100%;
    height: 100%;
    border: none;
    display: none;
  }
  .tv-iframe.active { display: block; }
  .tv-waiting {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    color: var(--text2);
  }
  .tv-waiting-icon { font-size: 56px; opacity: .4; }
  .tv-waiting h3 { font-size: 20px; font-weight: 500; color: var(--text); }
  .tv-waiting p { font-size: 14px; color: var(--text3); text-align: center; max-width: 280px; }

  /* iframe engel uyarƒ±sƒ± */
  .iframe-warn {
    display: none;
    position: absolute;
    inset: 0;
    background: var(--bg);
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    padding: 40px;
    text-align: center;
  }
  .iframe-warn.show { display: flex; }
  .iframe-warn-icon { font-size: 48px; }
  .iframe-warn h3 { font-size: 18px; font-weight: 600; }
  .iframe-warn p { font-size: 14px; color: var(--text2); max-width: 340px; }
  .iframe-warn .url-display {
    font-family: var(--mono);
    font-size: 12px;
    background: var(--bg2);
    padding: 8px 14px;
    border-radius: 8px;
    max-width: 100%;
    word-break: break-all;
    color: var(--text2);
  }

  /* ‚îÄ‚îÄ Sanal ƒ∞mle√ß (TV) ‚îÄ‚îÄ */
  #virtual-cursor {
    position: absolute;
    width: 22px;
    height: 22px;
    pointer-events: none;
    z-index: 9999;
    display: none;
    transform: translate(-50%, -50%);
    transition: left .04s linear, top .04s linear;
  }
  #virtual-cursor svg { width: 100%; height: 100%; }
  #virtual-cursor.click-pulse svg circle.ring {
    animation: cursor-pulse .3s ease-out forwards;
  }
  @keyframes cursor-pulse {
    0%   { r: 8; opacity: 1; }
    100% { r: 18; opacity: 0; }
  }

  /* ‚îÄ‚îÄ MOBƒ∞L EKRANI ‚îÄ‚îÄ */
  #screen-mobile {
    flex-direction: column;
    max-width: 480px;
    margin: 0 auto;
    width: 100%;
    padding: 0;
  }
  .mobile-header {
    padding: 20px 20px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .mobile-header h1 { font-size: 20px; font-weight: 600; }
  .mobile-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }

  .section-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: .1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 10px;
  }

  /* TV Listesi */
  .tv-list { display: flex; flex-direction: column; gap: 8px; }
  .tv-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: background .12s;
  }
  .tv-item:hover { background: var(--bg2); }
  .tv-item.selected { border-color: var(--accent); background: var(--accent-light); }
  .tv-item-icon { font-size: 22px; flex-shrink: 0; }
  .tv-item-info { flex: 1; min-width: 0; }
  .tv-item-name { font-size: 14px; font-weight: 500; }
  .tv-item-status { font-size: 12px; color: var(--text3); display: flex; align-items: center; gap: 4px; margin-top: 2px; }
  .tv-empty { font-size: 14px; color: var(--text3); text-align: center; padding: 24px 0; }
  .dot-offline {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: var(--text3);
    display: inline-block;
    flex-shrink: 0;
  }
  .tv-item-offline { opacity: .45; cursor: default; }
  .tv-item-offline:hover { background: var(--surface) !important; }

  /* ‚îÄ‚îÄ TOUCHPAD B√ñL√úM√ú ‚îÄ‚îÄ */
  .touchpad-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* Mod Toggle */
  .mode-toggle {
    display: flex;
    background: var(--bg2);
    border-radius: 8px;
    padding: 3px;
    gap: 3px;
  }
  .mode-btn {
    flex: 1;
    padding: 8px 0;
    border: none;
    border-radius: 6px;
    font-family: var(--font);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    background: transparent;
    color: var(--text2);
    transition: background .15s, color .15s;
  }
  .mode-btn.active {
    background: var(--surface);
    color: var(--text);
    box-shadow: var(--shadow);
  }

  /* Swipe Alanƒ± */
  #touchpad-area {
    width: 100%;
    height: 200px;
    background: var(--bg2);
    border-radius: 10px;
    border: 1px solid var(--border);
    position: relative;
    touch-action: none;
    user-select: none;
    cursor: crosshair;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  #touchpad-area::after {
    content: "Kaydƒ±r ¬∑ Tek parmak tƒ±kla";
    font-size: 12px;
    color: var(--text3);
    pointer-events: none;
    position: absolute;
    bottom: 10px;
    left: 0; right: 0;
    text-align: center;
  }
  #touchpad-area.touching { background: var(--accent-light); border-color: var(--accent); }

  /* Sensitivity Slider */
  .slider-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .slider-row label { font-size: 12px; color: var(--text2); white-space: nowrap; flex-shrink: 0; }
  .slider-row input[type=range] {
    flex: 1;
    accent-color: var(--accent);
    height: 4px;
    cursor: pointer;
  }
  .slider-val {
    font-size: 12px;
    color: var(--text2);
    min-width: 22px;
    text-align: right;
    flex-shrink: 0;
  }

  /* D-Pad */
  #dpad-area {
    display: none;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  #dpad-area.show { display: flex; }
  .dpad-row { display: flex; gap: 6px; align-items: center; }
  .dpad-btn {
    width: 56px; height: 56px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--bg2);
    font-size: 20px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background .1s, transform .1s;
    -webkit-tap-highlight-color: transparent;
  }
  .dpad-btn:active { transform: scale(.9); background: var(--border); }
  .dpad-center {
    background: var(--accent);
    color: #fff;
    border-color: transparent;
    font-size: 16px;
    font-weight: 600;
  }
  .dpad-center:active { background: var(--accent); opacity: .8; }
  .dpad-spacer { width: 56px; height: 56px; }

  /* Text Input (Klavye) */
  .textinput-row {
    display: flex;
    gap: 8px;
  }
  .textinput-row .form-input {
    flex: 1;
    font-size: 14px;
    padding: 9px 12px;
  }
  .btn-textinput-send {
    flex-shrink: 0;
    padding: 9px 14px;
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: #fff;
    font-family: var(--font);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: opacity .15s;
  }
  .btn-textinput-send:hover { opacity: .85; }

  /* Video Kumanda */
  .video-ctrl-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }
  .video-ctrl-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  .btn-ctrl {
    width: 52px; height: 52px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: var(--bg2);
    font-size: 20px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background .12s, transform .1s;
    flex-shrink: 0;
  }
  .btn-ctrl:active { transform: scale(.92); }
  .btn-ctrl:hover { background: var(--border); }
  .btn-ctrl-play  { background: var(--accent); color: #fff; border-color: transparent; font-size: 18px; }
  .btn-ctrl-play:hover { opacity: .85; background: var(--accent); }
  .btn-ctrl-pause { background: var(--bg2); }
  .btn-ctrl-stop  { background: var(--danger-light); color: var(--danger); border-color: transparent; }

  /* URL g√∂nder */
  .send-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }
  .send-row { display: flex; gap: 8px; }
  .send-row .form-input { flex: 1; }
  .btn-paste {
    flex-shrink: 0;
    padding: 11px 13px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg2);
    font-size: 16px;
    cursor: pointer;
    transition: background .12s;
  }
  .btn-paste:hover { background: var(--border); }
  .btn-send {
    background: var(--accent);
    color: #fff;
    flex-shrink: 0;
    padding: 11px 18px;
    border-radius: 8px;
    border: none;
    font-family: var(--font);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    transition: opacity .15s;
  }
  .btn-send:hover { opacity: .85; }
  .btn-send:disabled { opacity: .45; cursor: not-allowed; }

  /* Ge√ßmi≈ü */
  .history-list { display: flex; flex-direction: column; gap: 6px; }
  .history-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: background .12s;
  }
  .history-item:hover { background: var(--bg2); }
  .history-url {
    flex: 1;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--text2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .history-arrow { font-size: 12px; color: var(--text3); flex-shrink: 0; }

  /* Ayarlar */
  .settings-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
  }
  .settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
  }
  .settings-row:last-child { border-bottom: none; }
  .settings-row-label { font-size: 14px; font-weight: 500; }
  .settings-row-desc { font-size: 12px; color: var(--text3); margin-top: 2px; }

  /* Toggle Switch */
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 26px;
    flex-shrink: 0;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
  .toggle-track {
    position: absolute;
    inset: 0;
    border-radius: 13px;
    background: var(--border);
    cursor: pointer;
    transition: background .2s;
  }
  .toggle-track::after {
    content: '';
    position: absolute;
    left: 3px; top: 3px;
    width: 20px; height: 20px;
    border-radius: 50%;
    background: #fff;
    transition: transform .2s;
    box-shadow: 0 1px 3px rgba(0,0,0,.2);
  }
  .toggle-switch input:checked + .toggle-track { background: var(--accent); }
  .toggle-switch input:checked + .toggle-track::after { transform: translateX(18px); }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--text);
    color: var(--bg);
    padding: 10px 20px;
    border-radius: 100px;
    font-size: 13px;
    font-weight: 500;
    z-index: 9999;
    pointer-events: none;
    transition: transform .25s cubic-bezier(.34,1.56,.64,1);
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* Loader */
  .loader {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2px solid rgba(255,255,255,.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin .6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Fade-in */
  .fade-in { animation: fadeIn .3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ‚îÄ Gƒ∞Rƒ∞≈û EKRANI ‚îÄ‚îÄ‚îÄ -->
<div id="screen-login" class="screen active">
  <div class="login-card fade-in">
    <div class="login-logo">TV Kontrol <span>/ by Firebase</span></div>
    <h1 class="login-title">Giri≈ü Yap</h1>
    <p class="login-sub">T√ºm cihazlarƒ±nƒ±zla aynƒ± hesabƒ± kullanƒ±n.</p>
    <div class="form-group">
      <label class="form-label" for="inp-email">E-posta</label>
      <input class="form-input" type="email" id="inp-email" placeholder="ornek@eposta.com" autocomplete="email">
    </div>
    <div class="form-group">
      <label class="form-label" for="inp-pass">≈ûifre</label>
      <input class="form-input" type="password" id="inp-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
    </div>
    <button class="btn btn-primary" id="btn-login" onclick="doLogin()">
      <span id="login-btn-text">Giri≈ü Yap</span>
    </button>
    <div class="error-msg" id="login-error"></div>
    <p style="margin-top:16px;font-size:13px;color:var(--text3);text-align:center;">
      Hesabƒ±nƒ±z yok mu?
      <a href="#" onclick="toggleRegister(event)" style="color:var(--accent);text-decoration:none;font-weight:500;">Kayƒ±t ol</a>
    </p>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ ROL ONAY EKRANI ‚îÄ‚îÄ‚îÄ -->
<div id="screen-role-confirm" class="screen">
  <div class="role-card fade-in">
    <span class="role-icon" id="role-icon">üì∫</span>
    <h2 id="role-title">TV olarak tanƒ±ndƒ±nƒ±z</h2>
    <p id="role-desc">Cihazƒ±nƒ±z TV tarayƒ±cƒ±sƒ± gibi g√∂r√ºn√ºyor. Doƒüru mu?</p>
    <div class="role-btns">
      <button class="btn btn-ghost" onclick="confirmRole('mobile')">üì± Hayƒ±r, Mobil</button>
      <button class="btn btn-primary" id="btn-confirm-role" onclick="confirmRole(null)">‚úì Evet, Devam</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ TV EKRANI ‚îÄ‚îÄ‚îÄ -->
<div id="screen-tv" class="screen">
  <div class="tv-topbar">
    <div class="tv-url" id="tv-url-bar">Baƒülantƒ± bekleniyor...</div>
    <div class="tv-devices" id="tv-device-count">
      <span class="dot-online"></span> <span id="tv-mobile-count">0</span> mobil
    </div>
    <button class="btn btn-ghost btn-sm" id="btn-newtab" onclick="openNewTab()" style="display:none;">‚Üó Yeni Sekme</button>
    <button class="btn btn-ghost btn-sm" onclick="closeIframe()">‚úï Kapat</button>
    <button class="btn btn-ghost btn-sm" onclick="showSettings()">‚öô</button>
  </div>
  <div class="tv-content">
    <div class="tv-waiting" id="tv-waiting">
      <div class="tv-waiting-icon">üì°</div>
      <h3>Baƒülantƒ± bekleniyor</h3>
      <p>Mobil cihazƒ±nƒ±zdan bu hesaba giri≈ü yapƒ±n ve bir URL g√∂nderin.</p>
    </div>
    <iframe id="tv-iframe" class="tv-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation"></iframe>
    <div class="iframe-warn" id="iframe-warn">
      <div class="iframe-warn-icon">üö´</div>
      <h3>Bu site y√ºklenemedi</h3>
      <p>Site, √ßer√ßeve (iframe) i√ßinde a√ßƒ±lmaya izin vermiyor.</p>
      <div class="url-display" id="iframe-warn-url"></div>
      <button class="btn btn-primary" id="btn-open-newtab" style="margin-top:4px;">Yeni Sekmede A√ß</button>
      <button class="btn btn-ghost btn-sm" onclick="closeIframe()" style="margin-top:4px;">Kapat</button>
    </div>
    <!-- Sanal ƒ∞mle√ß -->
    <div id="virtual-cursor">
      <svg viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
        <circle class="ring" cx="11" cy="11" r="8" stroke="#2d6a4f" stroke-width="2" fill="rgba(45,106,79,0.15)"/>
        <circle cx="11" cy="11" r="3.5" fill="#2d6a4f"/>
      </svg>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ MOBƒ∞L EKRANI ‚îÄ‚îÄ‚îÄ -->
<div id="screen-mobile" class="screen">
  <div class="mobile-header">
    <h1>TV Kontrol</h1>
    <button class="btn btn-ghost btn-sm" onclick="doLogout()">√áƒ±kƒ±≈ü</button>
  </div>
  <div class="mobile-body">

    <!-- TV Listesi -->
    <div>
      <div class="section-label">Baƒülƒ± TV'ler</div>
      <div class="tv-list" id="tv-list">
        <div class="tv-empty">Aktif TV bulunamadƒ±.</div>
      </div>
    </div>

    <!-- Touchpad / D-Pad -->
    <div>
      <div class="section-label">Kumanda</div>
      <div class="touchpad-card">
        <!-- Mod Toggle -->
        <div class="mode-toggle">
          <button class="mode-btn active" id="mode-btn-swipe" onclick="setTouchMode('swipe')">üëÜ Swipe</button>
          <button class="mode-btn" id="mode-btn-dpad" onclick="setTouchMode('dpad')">üïπÔ∏è D-Pad</button>
        </div>

        <!-- Swipe Alanƒ± -->
        <div id="touchpad-area" style="display:flex;"></div>

        <!-- Sensitivity Slider (sadece swipe'ta) -->
        <div class="slider-row" id="sensitivity-row">
          <label>Hassasiyet</label>
          <input type="range" id="sensitivity-slider" min="1" max="10" value="5" oninput="onSensitivityChange(this.value)">
          <span class="slider-val" id="sensitivity-val">5</span>
        </div>

        <!-- D-Pad Alanƒ± -->
        <div id="dpad-area">
          <div class="dpad-row">
            <div class="dpad-spacer"></div>
            <button class="dpad-btn" ontouchstart="sendDpad('up')" onclick="sendDpad('up')">‚Üë</button>
            <div class="dpad-spacer"></div>
          </div>
          <div class="dpad-row">
            <button class="dpad-btn" ontouchstart="sendDpad('left')" onclick="sendDpad('left')">‚Üê</button>
            <button class="dpad-btn dpad-center" ontouchstart="sendDpad('enter')" onclick="sendDpad('enter')">OK</button>
            <button class="dpad-btn" ontouchstart="sendDpad('right')" onclick="sendDpad('right')">‚Üí</button>
          </div>
          <div class="dpad-row">
            <div class="dpad-spacer"></div>
            <button class="dpad-btn" ontouchstart="sendDpad('down')" onclick="sendDpad('down')">‚Üì</button>
            <div class="dpad-spacer"></div>
          </div>
        </div>

        <!-- Klavye / Metin G√∂nder -->
        <div>
          <div style="font-size:11px;color:var(--text3);margin-bottom:6px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;">Metin G√∂nder</div>
          <div class="textinput-row">
            <input class="form-input" type="text" id="inp-remote-text" placeholder="Yazƒ± yaz, Enter g√∂nder...">
            <button class="btn-textinput-send" onclick="sendRemoteText()">‚Üµ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- URL G√∂nder -->
    <div>
      <div class="section-label">URL G√∂nder</div>
      <div class="send-box">
        <div class="send-row">
          <input class="form-input" type="text" id="inp-url" placeholder="https://..." inputmode="url" autocomplete="url">
          <button class="btn-paste" id="btn-paste" onclick="pasteUrl()" title="Panodan yapƒ±≈ütƒ±r">üìã</button>
          <button class="btn-send" id="btn-send" onclick="sendUrl()">G√∂nder</button>
        </div>
        <div id="send-target-note" style="font-size:12px;color:var(--text3);margin-top:8px;"></div>
      </div>
    </div>

    <!-- Video Kumanda -->
    <div id="video-ctrl-section" style="display:none;">
      <div class="section-label">Video Kumanda</div>
      <div class="video-ctrl-card">
        <div class="video-ctrl-row">
          <button class="btn-ctrl" onclick="sendVideoCmd('seekBack')" title="10 saniye geri">‚è™</button>
          <button class="btn-ctrl btn-ctrl-play" onclick="sendVideoCmd('play')" title="Oynat">‚ñ∂</button>
          <button class="btn-ctrl btn-ctrl-pause" onclick="sendVideoCmd('pause')" title="Duraklat">‚è∏</button>
          <button class="btn-ctrl btn-ctrl-stop" onclick="sendVideoCmd('stop')" title="Durdur">‚èπ</button>
          <button class="btn-ctrl" onclick="sendVideoCmd('seekForward')" title="10 saniye ileri">‚è©</button>
        </div>
        <div id="video-ctrl-status" style="font-size:12px;color:var(--text3);text-align:center;margin-top:8px;">TV'de video bekleniyor...</div>
      </div>
    </div>

    <!-- Ge√ßmi≈ü -->
    <div id="history-section" style="display:none;">
      <div class="section-label">Son G√∂nderilenler</div>
      <div class="history-list" id="history-list"></div>
    </div>

    <!-- Ayarlar -->
    <div>
      <div class="section-label">Ayarlar</div>
      <div class="settings-card">
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Proxy Kullan</div>
            <div class="settings-row-desc">CORS proxy √ºzerinden baƒülan</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggle-proxy" onchange="onProxyToggle(this.checked)">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Rol</div>
            <div class="settings-row-desc" id="role-desc-mobile">Mobil olarak giri≈ü yapƒ±ldƒ±</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="switchToTV()">TV'ye ge√ß</button>
        </div>
        <div class="settings-row">
          <div>
            <div class="settings-row-label">Hesap</div>
            <div class="settings-row-desc" id="mobile-email-display"></div>
          </div>
          <button class="btn btn-danger btn-sm" onclick="doLogout()">√áƒ±kƒ±≈ü</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- ‚îÄ‚îÄ‚îÄ FIREBASE SDK ‚îÄ‚îÄ‚îÄ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, serverTimestamp, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üîß FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey:            "AIzaSyDw5kHPVMtm9G7zD_hBlusp1HCcUbbIhv8",
  authDomain:        "mobil-tv-e1095.firebaseapp.com",
  projectId:         "mobil-tv-e1095",
  storageBucket:     "mobil-tv-e1095.firebasestorage.app",
  messagingSenderId: "397261791298",
  appId:             "1:397261791298:web:b34161ad7656ce67a50ddb"
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let currentUser   = null;
let currentRole   = null;   // "tv" | "mobile"
let sessionId     = null;
let sessionUnsub  = null;
let tvListUnsub   = null;
let selectedTvId  = null;
let isRegisterMode = false;
let urlHistory    = [];

// ‚îÄ‚îÄ‚îÄ Touchpad state ‚îÄ‚îÄ‚îÄ
let touchMode       = "swipe";   // "swipe" | "dpad"
let sensitivity     = 5;
let useProxy        = false;
let pointerThrottle = null;
let pendingDx       = 0;
let pendingDy       = 0;
let lastPointerX    = null;
let lastPointerY    = null;
// Sanal imle√ß pozisyonu (TV ekran y√ºzdesi)
let cursorPctX      = 50;
let cursorPctY      = 50;

// ‚îÄ‚îÄ‚îÄ DEVICE ID ‚îÄ‚îÄ‚îÄ
function getDeviceId() {
  let id = localStorage.getItem("tvctrl_device_id");
  if (!id) {
    id = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2);
    localStorage.setItem("tvctrl_device_id", id);
  }
  return id;
}

function getDeviceName() {
  const ua = navigator.userAgent;
  if (/Samsung/i.test(ua)) return "Samsung TV";
  if (/LG Smart|WebOS/i.test(ua)) return "LG TV";
  if (/Philips/i.test(ua)) return "Philips TV";
  if (/HbbTV/i.test(ua)) return "HbbTV";
  if (/Android TV|AFT/i.test(ua)) return "Android TV";
  if (/iPhone/i.test(ua)) return "iPhone";
  if (/iPad/i.test(ua)) return "iPad";
  if (/Android/i.test(ua)) return "Android";
  return "Tarayƒ±cƒ±";
}

// ‚îÄ‚îÄ‚îÄ ROL TESPƒ∞Tƒ∞ ‚îÄ‚îÄ‚îÄ
function detectRole() {
  const ua = navigator.userAgent;
  const tvPatterns = /SmartTV|SMART-TV|HbbTV|WebOS|Tizen|SMART_TV|BRAVIA|Viera|NetCast|DLNA|CrKey|GoogleTV|Android TV|AFT/i;
  if (tvPatterns.test(ua)) return "tv";
  const isTouchless = !navigator.maxTouchPoints && window.screen.width >= 1100 && window.screen.height >= 600;
  const isLargeScreen = window.screen.width >= 1280 && window.screen.height >= 720;
  if (isTouchless && isLargeScreen) return "tv";
  return "mobile";
}

// ‚îÄ‚îÄ‚îÄ SCREEN Y√ñNETƒ∞Mƒ∞ ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById("screen-" + id).classList.add("active");
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
function toast(msg, dur = 2500) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(() => el.classList.remove("show"), dur);
}

// ‚îÄ‚îÄ‚îÄ Gƒ∞Rƒ∞≈û / KAYIT ‚îÄ‚îÄ‚îÄ
window.toggleRegister = function(e) {
  e.preventDefault();
  isRegisterMode = !isRegisterMode;
  document.getElementById("login-btn-text").textContent = isRegisterMode ? "Kayƒ±t Ol" : "Giri≈ü Yap";
  document.querySelector(".login-title").textContent = isRegisterMode ? "Kayƒ±t Ol" : "Giri≈ü Yap";
};

window.doLogin = async function() {
  const email = document.getElementById("inp-email").value.trim();
  const pass  = document.getElementById("inp-pass").value;
  const errEl = document.getElementById("login-error");
  const btn   = document.getElementById("btn-login");

  if (!email || !pass) { showErr("E-posta ve ≈üifre gerekli."); return; }

  btn.innerHTML = '<span class="loader"></span>';
  btn.disabled = true;
  errEl.classList.remove("show");

  try {
    if (isRegisterMode) {
      await createUserWithEmailAndPassword(auth, email, pass);
    } else {
      await signInWithEmailAndPassword(auth, email, pass);
    }
  } catch(e) {
    const msgs = {
      "auth/user-not-found": "Bu e-posta kayƒ±tlƒ± deƒüil.",
      "auth/wrong-password": "≈ûifre hatalƒ±.",
      "auth/email-already-in-use": "Bu e-posta zaten kayƒ±tlƒ±.",
      "auth/invalid-email": "Ge√ßersiz e-posta.",
      "auth/weak-password": "≈ûifre en az 6 karakter olmalƒ±.",
      "auth/invalid-credential": "E-posta veya ≈üifre hatalƒ±."
    };
    showErr(msgs[e.code] || e.message);
    btn.innerHTML = '<span id="login-btn-text">' + (isRegisterMode ? "Kayƒ±t Ol" : "Giri≈ü Yap") + "</span>";
    btn.disabled = false;
  }
};

function showErr(msg) {
  const el = document.getElementById("login-error");
  el.textContent = msg;
  el.classList.add("show");
}

document.getElementById("inp-pass").addEventListener("keydown", e => {
  if (e.key === "Enter") window.doLogin();
});

// ‚îÄ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (!user) {
    currentUser = null;
    if (sessionUnsub) { sessionUnsub(); sessionUnsub = null; }
    if (tvListUnsub)  { tvListUnsub(); tvListUnsub = null; }
    showScreen("login");
    document.getElementById("btn-login").innerHTML = '<span id="login-btn-text">Giri≈ü Yap</span>';
    document.getElementById("btn-login").disabled = false;
    return;
  }
  currentUser = user;
  const detected = detectRole();
  showRoleConfirm(detected);
});

// ‚îÄ‚îÄ‚îÄ ROL ONAY ‚îÄ‚îÄ‚îÄ
function showRoleConfirm(detected) {
  currentRole = detected;
  const icon  = document.getElementById("role-icon");
  const title = document.getElementById("role-title");
  const desc  = document.getElementById("role-desc");
  const btn   = document.getElementById("btn-confirm-role");
  if (detected === "tv") {
    icon.textContent = "üì∫";
    title.textContent = "TV olarak tanƒ±ndƒ±nƒ±z";
    desc.textContent = "Cihazƒ±nƒ±z TV tarayƒ±cƒ±sƒ± gibi g√∂r√ºn√ºyor. Doƒüru mu?";
    btn.textContent = "‚úì Evet, TV";
    document.querySelector(".role-btns .btn-ghost").style.display = "";
  } else {
    icon.textContent = "üì±";
    title.textContent = "Mobil olarak tanƒ±ndƒ±nƒ±z";
    desc.textContent = "Cihazƒ±nƒ±z mobil / masa√ºst√º tarayƒ±cƒ± gibi g√∂r√ºn√ºyor. Doƒüru mu?";
    btn.textContent = "‚úì Evet, Mobil";
    document.querySelector(".role-btns .btn-ghost").textContent = "üì∫ Hayƒ±r, TV";
  }
  showScreen("role-confirm");
}

window.confirmRole = async function(override) {
  if (override) currentRole = override;
  await startSession(currentRole);
};

// ‚îÄ‚îÄ‚îÄ SESSION BA≈ûLAT ‚îÄ‚îÄ‚îÄ
async function startSession(role) {
  const deviceId = getDeviceId();
  sessionId = `${currentUser.uid}_${deviceId}`;

  await setDoc(doc(db, "sessions", sessionId), {
    userId:     currentUser.uid,
    email:      currentUser.email,
    role:       role,
    deviceId:   deviceId,
    deviceName: getDeviceName(),
    online:     true,
    lastSeen:   serverTimestamp(),
    command:    null
  });

  // Sayfa kapanƒ±nca session sil
  window.addEventListener("beforeunload", () => {
    if (!sessionId || !firebaseConfig.projectId) return;
    const url = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/sessions/${sessionId}`;
    try { fetch(url, { method: "DELETE", keepalive: true }); } catch(_) {}
  });

  if (role === "tv") {
    startTvScreen();
  } else {
    startMobileScreen();
  }
}

// ‚îÄ‚îÄ‚îÄ TV EKRANI ‚îÄ‚îÄ‚îÄ
let videoCheckInterval = null;
let heartbeatInterval = null;

function startTvScreen() {
  showScreen("tv");

  // Heartbeat: her 15sn lastSeen g√ºncelle
  if (heartbeatInterval) clearInterval(heartbeatInterval);
  heartbeatInterval = setInterval(() => {
    if (sessionId) setDoc(doc(db, "sessions", sessionId), { lastSeen: serverTimestamp() }, { merge: true });
  }, 15000);

  // Kendi session'ƒ± dinle (komut gelirse)
  sessionUnsub = onSnapshot(doc(db, "sessions", sessionId), snap => {
    if (snap.metadata.hasPendingWrites) return; // local yazma kaynaklƒ± tetiklenme, atla
    const data = snap.data();
    if (!data) return;
    const cmd = data.command;
    if (!cmd) return;
    // Komutu hemen null'la ‚Äî sonraki snapshot'larda tekrar i≈ülenmesin
    setDoc(doc(db, "sessions", sessionId), { command: null }, { merge: true });
    if (cmd.type === "navigate" && cmd.url) {
      loadUrl(cmd.url);
    } else if (cmd.type === "videoControl") {
      handleVideoControl(cmd.action);
    } else if (cmd.type === "pointer") {
      handlePointerCmd(cmd.dx, cmd.dy);
    } else if (cmd.type === "click") {
      handleClickCmd();
    } else if (cmd.type === "dpad") {
      handleDpadCmd(cmd.dir);
    } else if (cmd.type === "typeText") {
      handleTypeTextCmd(cmd.text);
    }
  });

  // Aynƒ± hesabƒ±n mobil cihazlarƒ±nƒ± say
  tvListUnsub = onSnapshot(
    query(collection(db, "sessions"),
          where("userId", "==", currentUser.uid),
          where("role", "==", "mobile")),
    snap => {
      document.getElementById("tv-mobile-count").textContent = snap.size;
    }
  );
}

// ‚îÄ‚îÄ‚îÄ TV: Sanal ƒ∞mle√ß ‚îÄ‚îÄ‚îÄ
function showCursor() {
  const el = document.getElementById("virtual-cursor");
  const content = document.querySelector(".tv-content");
  if (!content) return;
  const rect = content.getBoundingClientRect();
  el.style.display = "block";
  el.style.left = (rect.left + rect.width  * cursorPctX / 100) + "px";
  el.style.top  = (rect.top  + rect.height * cursorPctY / 100) + "px";
}

function handlePointerCmd(dx, dy) {
  const content = document.querySelector(".tv-content");
  if (!content) return;
  const rect = content.getBoundingClientRect();
  // dx/dy piksel cinsinden gelir, ekran y√ºzdesine √ßevir
  cursorPctX = Math.min(100, Math.max(0, cursorPctX + (dx / rect.width)  * 100));
  cursorPctY = Math.min(100, Math.max(0, cursorPctY + (dy / rect.height) * 100));
  showCursor();
}

function handleClickCmd() {
  const content = document.querySelector(".tv-content");
  if (!content) return;
  showCursor();
  // Pulse animasyonu
  const el = document.getElementById("virtual-cursor");
  el.classList.remove("click-pulse");
  void el.offsetWidth; // reflow
  el.classList.add("click-pulse");
  setTimeout(() => el.classList.remove("click-pulse"), 400);

  // iframe click dene (same-origin √ßalƒ±≈üƒ±r)
  const iframe = document.getElementById("tv-iframe");
  if (!iframe.classList.contains("active")) return;
  try {
    const rect = content.getBoundingClientRect();
    const x = rect.width  * cursorPctX / 100;
    const y = rect.height * cursorPctY / 100;
    const iframeRect = iframe.getBoundingClientRect();
    const ix = x - (iframeRect.left - rect.left);
    const iy = y - (iframeRect.top  - rect.top);
    const el2 = iframe.contentDocument.elementFromPoint(ix, iy);
    if (el2) el2.click();
  } catch(e) { /* cross-origin */ }
}

function handleDpadCmd(dir) {
  const iframe = document.getElementById("tv-iframe");
  if (!iframe.classList.contains("active")) return;
  const keyMap = { up: "ArrowUp", down: "ArrowDown", left: "ArrowLeft", right: "ArrowRight", enter: "Enter" };
  const key = keyMap[dir];
  if (!key) return;
  try {
    iframe.contentWindow.dispatchEvent(new KeyboardEvent("keydown", { key, bubbles: true, cancelable: true }));
    iframe.contentWindow.dispatchEvent(new KeyboardEvent("keyup",   { key, bubbles: true, cancelable: true }));
  } catch(e) { /* cross-origin */ }
}

function handleTypeTextCmd(text) {
  const iframe = document.getElementById("tv-iframe");
  if (!iframe.classList.contains("active")) return;
  try {
    const doc2 = iframe.contentDocument;
    const active = doc2.activeElement;
    if (active && (active.tagName === "INPUT" || active.tagName === "TEXTAREA" || active.isContentEditable)) {
      active.value = (active.value || "") + text;
      active.dispatchEvent(new Event("input", { bubbles: true }));
    } else {
      // Odaklanmƒ±≈ü element yoksa imle√ß pozisyonundaki input'u bul
      const el = doc2.elementFromPoint(
        iframe.getBoundingClientRect().width  * cursorPctX / 100,
        iframe.getBoundingClientRect().height * cursorPctY / 100
      );
      if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA")) {
        el.focus();
        el.value = (el.value || "") + text;
        el.dispatchEvent(new Event("input", { bubbles: true }));
      }
    }
    // Enter g√∂nder
    const target2 = iframe.contentDocument.activeElement;
    if (target2) {
      target2.dispatchEvent(new KeyboardEvent("keydown", { key: "Enter", bubbles: true, cancelable: true }));
      target2.dispatchEvent(new KeyboardEvent("keyup",   { key: "Enter", bubbles: true, cancelable: true }));
    }
  } catch(e) { /* cross-origin */ }
}

// TV'de video kontrol√º uygula
function handleVideoControl(action) {
  const iframe = document.getElementById("tv-iframe");
  if (!iframe.classList.contains("active")) return;
  let video = null;
  try {
    const videos = iframe.contentWindow.document.querySelectorAll("video");
    videos.forEach(v => {
      if (!video || (!video.paused && v.paused === false) || v.duration > (video.duration || 0)) {
        video = v;
      }
    });
  } catch(e) {
    setDoc(doc(db, "sessions", sessionId), {
      videoStatus: { detected: false, reason: "cross-origin" }
    }, { merge: true });
    return;
  }
  if (!video) return;
  try {
    if (action === "play")        video.play();
    else if (action === "pause")  video.pause();
    else if (action === "stop")   { video.pause(); video.currentTime = 0; }
    else if (action === "seekBack")    video.currentTime = Math.max(0, video.currentTime - 10);
    else if (action === "seekForward") video.currentTime = video.currentTime + 10;
  } catch(e) { /* sessiz hata */ }
}

// Video tespit polling
function startVideoDetectPolling() {
  if (videoCheckInterval) clearInterval(videoCheckInterval);
  videoCheckInterval = setInterval(async () => {
    const iframe = document.getElementById("tv-iframe");
    if (!iframe.classList.contains("active")) {
      clearInterval(videoCheckInterval);
      videoCheckInterval = null;
      await setDoc(doc(db, "sessions", sessionId), { videoStatus: { detected: false } }, { merge: true });
      return;
    }
    let detected = false;
    try {
      const videos = iframe.contentWindow.document.querySelectorAll("video");
      detected = videos.length > 0;
    } catch(e) {
      detected = false;
    }
    await setDoc(doc(db, "sessions", sessionId), {
      videoStatus: { detected, ts: Date.now() }
    }, { merge: true });
  }, 2000);
}

let currentUrl = "";

const CORS_PROXY = "https://mycors.recepyeni.workers.dev/?url=";

function loadUrl(url) {
  currentUrl = url;
  document.getElementById("tv-url-bar").textContent = url;
  document.getElementById("tv-waiting").style.display = "none";
  document.getElementById("iframe-warn").classList.remove("show");
  document.getElementById("btn-newtab").style.display = "";

  const iframe = document.getElementById("tv-iframe");
  iframe.classList.remove("active");
  iframe.src = "";

  let loaded = false;
  const proxyUrl = CORS_PROXY + encodeURIComponent(url);

  iframe.onload = () => {
    loaded = true;
    iframe.onload = null; // sonraki iframe-i√ßi navigasyonlarda tekrar tetiklenmesin
    startVideoDetectPolling();
  };

  iframe.onerror = () => {
    loaded = true;
    showIframeWarn(url);
  };

  setTimeout(() => {
    if (!loaded) showIframeWarn(url);
  }, 8000);

  iframe.src = proxyUrl;
  iframe.classList.add("active");
}

function showIframeWarn(url) {
  document.getElementById("tv-iframe").classList.remove("active");
  document.getElementById("iframe-warn-url").textContent = url;
  document.getElementById("btn-open-newtab").onclick = () => window.open(url, "_blank");
  document.getElementById("iframe-warn").classList.add("show");
}

window.pasteUrl = async function() {
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      document.getElementById("inp-url").value = text.trim();
      toast("Yapƒ±≈ütƒ±rƒ±ldƒ± ‚úì");
    }
  } catch(e) {
    const inp = document.getElementById("inp-url");
    inp.focus();
    inp.select();
    toast("URL kutusuna uzun basƒ±p yapƒ±≈ütƒ±rƒ±n");
  }
};

window.openNewTab = function() {
  if (currentUrl) window.open(currentUrl, "_blank");
};

window.closeIframe = function() {
  currentUrl = "";
  if (videoCheckInterval) { clearInterval(videoCheckInterval); videoCheckInterval = null; }
  if (sessionId) setDoc(doc(db, "sessions", sessionId), { videoStatus: { detected: false } }, { merge: true });
  document.getElementById("tv-iframe").src = "about:blank";
  document.getElementById("tv-iframe").classList.remove("active");
  document.getElementById("iframe-warn").classList.remove("show");
  document.getElementById("tv-waiting").style.display = "";
  document.getElementById("tv-url-bar").textContent = "Baƒülantƒ± bekleniyor...";
  document.getElementById("btn-newtab").style.display = "none";
  // ƒ∞mleci gizle
  document.getElementById("virtual-cursor").style.display = "none";
  cursorPctX = 50; cursorPctY = 50;
};

window.showSettings = function() {
  if (confirm("Mobil moda ge√ßmek istiyor musunuz?")) {
    switchRoleTo("mobile");
  }
};

async function switchRoleTo(role) {
  currentRole = role;
  if (heartbeatInterval) { clearInterval(heartbeatInterval); heartbeatInterval = null; }
  await setDoc(doc(db, "sessions", sessionId), { role }, { merge: true });
  if (role === "mobile") {
    if (sessionUnsub) { sessionUnsub(); sessionUnsub = null; }
    if (tvListUnsub)  { tvListUnsub(); tvListUnsub = null; }
    startMobileScreen();
  } else {
    startTvScreen();
  }
}

// ‚îÄ‚îÄ‚îÄ MOBƒ∞L EKRANI ‚îÄ‚îÄ‚îÄ
let videoStatusUnsub = null;

function startMobileScreen() {
  showScreen("mobile");
  document.getElementById("mobile-email-display").textContent = currentUser.email;
  document.getElementById("role-desc-mobile").textContent = "≈ûu an: Mobil";
  loadUrlHistory();
  loadTouchSettings();
  initTouchpad();

  if (tvListUnsub) tvListUnsub();
  tvListUnsub = onSnapshot(
    query(collection(db, "sessions"),
          where("userId", "==", currentUser.uid),
          where("role", "==", "tv")),
    snap => {
      renderTvList(snap.docs);
      watchVideoStatus(snap.docs);
    }
  );
}

// ‚îÄ‚îÄ‚îÄ Touchpad Ayarlarƒ± (localStorage) ‚îÄ‚îÄ‚îÄ
function loadTouchSettings() {
  touchMode   = localStorage.getItem("tvctrl_touchmode") || "swipe";
  sensitivity = parseInt(localStorage.getItem("tvctrl_sensitivity") || "5");
  useProxy    = localStorage.getItem("tvctrl_proxy") === "true";

  document.getElementById("sensitivity-slider").value = sensitivity;
  document.getElementById("sensitivity-val").textContent = sensitivity;
  document.getElementById("toggle-proxy").checked = useProxy;

  applyTouchMode(touchMode);
}

window.setTouchMode = function(mode) {
  touchMode = mode;
  localStorage.setItem("tvctrl_touchmode", mode);
  applyTouchMode(mode);
};

function applyTouchMode(mode) {
  document.getElementById("mode-btn-swipe").classList.toggle("active", mode === "swipe");
  document.getElementById("mode-btn-dpad").classList.toggle("active", mode === "dpad");
  document.getElementById("touchpad-area").style.display   = mode === "swipe" ? "flex" : "none";
  document.getElementById("sensitivity-row").style.display = mode === "swipe" ? "flex" : "none";
  document.getElementById("dpad-area").classList.toggle("show", mode === "dpad");
}

window.onSensitivityChange = function(val) {
  sensitivity = parseInt(val);
  document.getElementById("sensitivity-val").textContent = val;
  localStorage.setItem("tvctrl_sensitivity", val);
};

window.onProxyToggle = function(checked) {
  useProxy = checked;
  localStorage.setItem("tvctrl_proxy", checked ? "true" : "false");
  toast(checked ? "Proxy a√ßƒ±k" : "Proxy kapalƒ±");
};

// ‚îÄ‚îÄ‚îÄ Touchpad init ‚îÄ‚îÄ‚îÄ
function initTouchpad() {
  const area = document.getElementById("touchpad-area");
  // √ñnceki listener'larƒ± temizlemek i√ßin clone
  const newArea = area.cloneNode(true);
  area.parentNode.replaceChild(newArea, area);

  let tapTimer = null;
  let isMoved  = false;

  newArea.addEventListener("pointerdown", e => {
    e.preventDefault();
    lastPointerX = e.clientX;
    lastPointerY = e.clientY;
    isMoved = false;
    newArea.classList.add("touching");
    newArea.setPointerCapture(e.pointerId);

    tapTimer = setTimeout(() => { tapTimer = null; }, 300);
  }, { passive: false });

  newArea.addEventListener("pointermove", e => {
    e.preventDefault();
    if (lastPointerX === null) return;
    const dx = (e.clientX - lastPointerX) * (sensitivity / 5);
    const dy = (e.clientY - lastPointerY) * (sensitivity / 5);
    lastPointerX = e.clientX;
    lastPointerY = e.clientY;

    if (Math.abs(dx) > 1 || Math.abs(dy) > 1) isMoved = true;

    pendingDx += dx;
    pendingDy += dy;

    if (!pointerThrottle) {
      pointerThrottle = setTimeout(async () => {
        pointerThrottle = null;
        if (!selectedTvId) return;
        const sdx = pendingDx;
        const sdy = pendingDy;
        pendingDx = 0;
        pendingDy = 0;
        try {
          await setDoc(doc(db, "sessions", selectedTvId), {
            command: { type: "pointer", dx: sdx, dy: sdy, sentAt: serverTimestamp() }
          }, { merge: true });
        } catch(e) { /* sessiz */ }
      }, 80);
    }
  }, { passive: false });

  newArea.addEventListener("pointerup", async e => {
    e.preventDefault();
    newArea.classList.remove("touching");
    lastPointerX = null;
    lastPointerY = null;

    if (!isMoved && tapTimer !== null) {
      clearTimeout(tapTimer);
      tapTimer = null;
      // Tek parmak tap = tƒ±klama
      if (!selectedTvId) return;
      try {
        await setDoc(doc(db, "sessions", selectedTvId), {
          command: { type: "click", sentAt: serverTimestamp() }
        }, { merge: true });
        toast("Tƒ±k ‚úì");
      } catch(e) { /* */ }
    }
  }, { passive: false });

  newArea.addEventListener("pointercancel", () => {
    newArea.classList.remove("touching");
    lastPointerX = null;
    lastPointerY = null;
  });
}

// ‚îÄ‚îÄ‚îÄ D-Pad g√∂nder ‚îÄ‚îÄ‚îÄ
window.sendDpad = async function(dir) {
  if (!selectedTvId) { toast("TV se√ßili deƒüil."); return; }
  try {
    await setDoc(doc(db, "sessions", selectedTvId), {
      command: { type: "dpad", dir, sentAt: serverTimestamp() }
    }, { merge: true });
  } catch(e) { toast("Hata: " + e.message); }
};

// ‚îÄ‚îÄ‚îÄ Metin G√∂nder ‚îÄ‚îÄ‚îÄ
window.sendRemoteText = async function() {
  const inp = document.getElementById("inp-remote-text");
  const text = inp.value;
  if (!text) { toast("Metin girin."); return; }
  if (!selectedTvId) { toast("TV se√ßili deƒüil."); return; }
  try {
    await setDoc(doc(db, "sessions", selectedTvId), {
      command: { type: "typeText", text, sentAt: serverTimestamp() }
    }, { merge: true });
    toast("G√∂nderildi ‚úì");
    inp.value = "";
  } catch(e) { toast("Hata: " + e.message); }
};

// Enter tu≈üu ile metin g√∂nder
document.getElementById("inp-remote-text").addEventListener("keydown", e => {
  if (e.key === "Enter") window.sendRemoteText();
});

function watchVideoStatus(tvDocs) {
  if (videoStatusUnsub) { videoStatusUnsub(); videoStatusUnsub = null; }
  if (tvDocs.length === 0) {
    document.getElementById("video-ctrl-section").style.display = "none";
    return;
  }
  const targetId = selectedTvId || tvDocs[0].id;
  videoStatusUnsub = onSnapshot(doc(db, "sessions", targetId), snap => {
    const data = snap.data();
    if (!data) return;
    const vs = data.videoStatus;
    const section = document.getElementById("video-ctrl-section");
    const statusEl = document.getElementById("video-ctrl-status");
    if (vs && vs.detected) {
      section.style.display = "";
      statusEl.textContent = "TV'de video bulundu ‚Äî kontrol aktif";
      statusEl.style.color = "var(--accent)";
    } else if (vs && vs.reason === "cross-origin") {
      section.style.display = "";
      statusEl.textContent = "‚ö† Bu site video kontrol√ºne izin vermiyor";
      statusEl.style.color = "var(--danger)";
    } else {
      section.style.display = "none";
    }
  });
}

function renderTvList(docs) {
  const listEl = document.getElementById("tv-list");
  if (docs.length === 0) {
    listEl.innerHTML = '<div class="tv-empty">Aktif TV bulunamadƒ±.</div>';
    selectedTvId = null;
    return;
  }
  const now = Date.now();
  const STALE_MS = 40000;
  listEl.innerHTML = "";
  let anyOnline = false;
  docs.forEach(d => {
    const data = d.data();
    let isOnline = false;
    if (data.lastSeen && data.lastSeen.toMillis) {
      isOnline = (now - data.lastSeen.toMillis()) < STALE_MS;
    } else if (data.lastSeen && data.lastSeen.seconds) {
      isOnline = (now - data.lastSeen.seconds * 1000) < STALE_MS;
    }
    const isSelected = d.id === selectedTvId;
    const el = document.createElement("div");
    el.className = "tv-item" + (isSelected && isOnline ? " selected" : "") + (!isOnline ? " tv-item-offline" : "");
    el.innerHTML = `
      <div class="tv-item-icon">üì∫</div>
      <div class="tv-item-info">
        <div class="tv-item-name">${data.deviceName || "TV"}</div>
        <div class="tv-item-status">${isOnline
          ? '<span class="dot-online"></span> √áevrimi√ßi'
          : '<span class="dot-offline"></span> √áevrimdƒ±≈üƒ±'
        }</div>
      </div>
    `;
    if (isOnline) {
      anyOnline = true;
      el.onclick = () => {
        selectedTvId = d.id;
        document.querySelectorAll(".tv-item").forEach(i => i.classList.remove("selected"));
        el.classList.add("selected");
        updateSendNote();
      };
      if (!selectedTvId) {
        selectedTvId = d.id;
        el.classList.add("selected");
      }
    }
    listEl.appendChild(el);
  });
  if (!anyOnline) selectedTvId = null;
  updateSendNote();
}

function updateSendNote() {
  const note = document.getElementById("send-target-note");
  if (!selectedTvId) {
    note.textContent = "G√∂ndermek i√ßin bir TV se√ßin.";
  } else {
    note.textContent = "Se√ßili TV'ye g√∂nderilecek.";
  }
}

window.sendUrl = async function() {
  const rawUrl = document.getElementById("inp-url").value.trim();
  if (!rawUrl) { toast("URL girin."); return; }
  if (!selectedTvId) { toast("√ñnce bir TV se√ßin."); return; }
  if (!rawUrl.startsWith("http://") && !rawUrl.startsWith("https://")) {
    toast("Ge√ßerli bir URL girin (https://...)"); return;
  }
  const url = useProxy ? (CORS_PROXY + encodeURIComponent(rawUrl)) : rawUrl;
  const btn = document.getElementById("btn-send");
  btn.disabled = true;
  btn.textContent = "...";
  try {
    await setDoc(doc(db, "sessions", selectedTvId), {
      command: { type: "navigate", url, sentAt: serverTimestamp() }
    }, { merge: true });
    toast("G√∂nderildi ‚úì");
    addHistory(rawUrl);
    document.getElementById("inp-url").value = "";
  } catch(e) {
    toast("Hata: " + e.message);
  }
  btn.disabled = false;
  btn.textContent = "G√∂nder";
};

// Ge√ßmi≈ü (localStorage)
function loadUrlHistory() {
  try {
    urlHistory = JSON.parse(localStorage.getItem("tvctrl_history") || "[]");
  } catch { urlHistory = []; }
  renderHistory();
}

function addHistory(url) {
  urlHistory = [url, ...urlHistory.filter(u => u !== url)].slice(0, 5);
  localStorage.setItem("tvctrl_history", JSON.stringify(urlHistory));
  renderHistory();
}

function renderHistory() {
  const sec = document.getElementById("history-section");
  const list = document.getElementById("history-list");
  if (urlHistory.length === 0) { sec.style.display = "none"; return; }
  sec.style.display = "";
  list.innerHTML = "";
  urlHistory.forEach(url => {
    const el = document.createElement("div");
    el.className = "history-item";
    el.innerHTML = `<span class="history-url">${url}</span><span class="history-arrow">‚Üó</span>`;
    el.onclick = () => { document.getElementById("inp-url").value = url; };
    list.appendChild(el);
  });
}

window.sendVideoCmd = async function(action) {
  const targetId = selectedTvId;
  if (!targetId) { toast("TV se√ßili deƒüil."); return; }
  try {
    await setDoc(doc(db, "sessions", targetId), {
      command: { type: "videoControl", action, sentAt: serverTimestamp() }
    }, { merge: true });
  } catch(e) {
    toast("Hata: " + e.message);
  }
};

window.switchToTV = function() {
  if (confirm("TV moduna ge√ßmek istiyor musunuz?")) {
    switchRoleTo("tv");
  }
};

// ‚îÄ‚îÄ‚îÄ Ok tu≈üu desteƒüi (TV kumanda) ‚îÄ‚îÄ‚îÄ
document.addEventListener("keydown", e => {
  if (!document.getElementById("screen-tv").classList.contains("active")) return;
  const iframe = document.getElementById("tv-iframe");
  if (!iframe.classList.contains("active")) return;
});

// ‚îÄ‚îÄ‚îÄ √áIKI≈û ‚îÄ‚îÄ‚îÄ
window.doLogout = async function() {
  if (heartbeatInterval)  { clearInterval(heartbeatInterval); heartbeatInterval = null; }
  if (videoCheckInterval) { clearInterval(videoCheckInterval); videoCheckInterval = null; }
  if (sessionUnsub)       sessionUnsub();
  if (tvListUnsub)        tvListUnsub();
  if (videoStatusUnsub)   videoStatusUnsub();
  if (sessionId) {
    try { await deleteDoc(doc(db, "sessions", sessionId)); } catch(_) {}
  }
  sessionId = null;
  await signOut(auth);
};
</script>
</body>
</html>